[site]: stackoverflow
[post_id]: 4075229
[parent_id]: 4074997
[tags]: 
This is pretty far outside the normal use of regexes. Although it might be possible, it's far easier, far more maintainable, and possibly computationally faster to split this problem up into subproblems. First of all, regexes can't handle arbitrarily-nested comments, which are valid HTML. Consider first splitting the content up into an array of paragraphs, looping through the paragraphs to find the third paragraph that doesn't contain an image, and inserting your text after that. If you really have to use regexes, something like ^.*?(((( |\W)(?! |\W))))(.(?! |\W)))*?( ).*?)){3} would match what you want once you strip comments. Explanation: The ^ is to ensure that it only matches up to the first three paragraphs that match the pattern, and not the last 3 (or every 3). Then, it reluctantly matches anything up until the real pattern starts. The real pattern then matches a tag (avoiding other tags that start with p, but still allowing for attributes) so long as it is not immediately followed by an tag, and then reluctantly matches any character so long as it is not followed by an tag until it gets to a close tag. This means that since no character between and has and tag following it, there is no tag between and . After that, the pattern reluctantly matches any other characters so that it allows for anything between non-image paragraphs, but so that it doesn't match non-image paragraphs themselves, and so that it doesn't match anything that's not strictly needed. This is then repeated 3 times, to get the third such paragraph.
