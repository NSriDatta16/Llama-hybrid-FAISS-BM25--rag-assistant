[site]: stackoverflow
[post_id]: 2735693
[parent_id]: 2727972
[tags]: 
I just registered an openid account, so i can not edit my own question. I found a way to manage this problem and wanted to post my solution. There was 2 problems : wrong biHeight parameter in BMP header vertically flipped data in the bitmap content (start with upper left corner in the place of down left corner first) For the biHeight parameter, i replaced the biHeight bytes to the good value (1080 for my image) For the flipped problem, i just flip all rows in the content bitmap bytes. May be this is not the most elegant solution, but it work fine. Just let me know if you if you have other solutions. Here's the code : intwidth = 1920; intheight = 1080; CGColorSpaceRefcolorSpace = CGColorSpaceCreateDeviceRGB(); CGContextRefcontext = CGBitmapContextCreate(NULL, (int)width, (int)height, 8, 4* (int)width, colorSpace, kCGImageAlphaNoneSkipLast); [duneScreenViewdrawBackgroundWithDuneFolder:selfinContext:context inRect:NSMakeRect(0,0,width,height) needScale:NO]; if(folderType==DXFolderTypeMovie) { [duneScreenViewdrawSynopsisContentWithDuneFolder:selfinContext:context inRect:NSMakeRect(0,0,width,height) withScale:1.0]; } CGImageRefbackgroundImageRef = CGBitmapContextCreateImage(context); NSBitmapImageRep*bitmapBackgroundImageRef = [[NSBitmapImageRepalloc] initWithCGImage:backgroundImageRef]; NSData*data = [bitmapBackgroundImageRef representationUsingType:NSBMPFileTypeproperties:nil]; NSMutableData*mutableData = [[NSMutableDataalloc] init]; intbitmapBytesOffset = 54; //headers [mutableData appendData:[data subdataWithRange:NSMakeRange(0,bitmapBytesOffset)]]; //bitmap data intlineIndex=height-1; while(lineIndex>=0) { [mutableData appendData:[data subdataWithRange:NSMakeRange(bitmapBytesOffset+lineIndex*width*3,width*3)]]; lineIndex--; } //force biHeight header parameter to 1080 NSString*biHeightString = @"\x38\x04\x00\x00"; NSData*biHeightData = [biHeightString dataUsingEncoding:NSUTF8StringEncoding]; [mutableData replaceBytesInRange:NSMakeRange(22,4) withBytes:[biHeightData bytes]]; [mutableData writeToFile:[NSStringstringWithFormat:@"%@/%@", folderPath,backgroundPath] atomically: YES]; [mutableData release]; CGImageRelease(backgroundImageRef); [bitmapBackgroundImageRef release]; CGContextRelease(context); CGColorSpaceRelease(colorSpace);
