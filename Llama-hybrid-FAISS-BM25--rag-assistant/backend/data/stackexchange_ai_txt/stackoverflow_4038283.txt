[site]: stackoverflow
[post_id]: 4038283
[parent_id]: 
[tags]: 
How many bytes does my function use? (C#)

I would like to calculate how many bytes my function fills so that I can inject it into another process using CreateRemoteThread(). Once I know the number of bytes, I can write them into the remote process using the function's pointer. I have found an article online (see http://www.codeproject.com/KB/threads/winspy.aspx#section_3 , chapter III) where they do the following in C++ : // ThreadFunc // Notice: - the code being injected; //Return value: password length static DWORD WINAPI ThreadFunc (INJDATA *pData) { //Code to be executed remotely } // This function marks the memory address after ThreadFunc. static void AfterThreadFunc (void) { } Then they calculate the number of bytes ThreadFunc fills using : const int cbCodeSize = ((LPBYTE) AfterThreadFunc - (LPBYTE) ThreadFunc); Using cbCodeSize they allocate memory in the remote process for the injected ThreadFunc and write a copy of ThreadFunc to the allocated memory: pCodeRemote = (PDWORD) VirtualAllocEx( hProcess, 0, cbCodeSize, MEM_COMMIT, PAGE_EXECUTE_READWRITE ); if (pCodeRemote == NULL) __leave; WriteProcessMemory( hProcess, pCodeRemote, &ThreadFunc, cbCodeSize, &dwNumBytesXferred ); I would like to do this in C#. :) I have tried creating delegates, getting their pointers, and subtracting them like this: // Thread proc, to be used with Create*Thread public delegate int ThreadProc(InjectionData param); //Function pointer ThreadFuncDeleg = new ThreadProc(ThreadFunc); ThreadFuncPtr = Marshal.GetFunctionPointerForDelegate(ThreadFuncDeleg); //FunctionPointer AfterThreadFuncDeleg = new ThreadProc(AfterThreadFunc); IntPtr AfterThreadFuncDelegPtr= Marshal.GetFunctionPointerForDelegate(AfterThreadFuncDeleg); //Number of bytes int cbCodeSize = (AfterThreadFuncDelegPtr.ToInt32() - ThreadFuncPtr.ToInt32())*4 ; It just does not seem right, as I get a static number no matter what I do with the code. My question is, if possible, how does one calculate the number of bytes a function's code fills in C#? Thank you in advance.
