[site]: stackoverflow
[post_id]: 2181786
[parent_id]: 
[tags]: 
Help with ajax callback and drupal_process_form

I have a form that is added through the nodeapi displayed only on view mode. Users can select an item from a select menu and their choice will automatically get saved to the database with a hook_menu callback on change. If the user has javascript disabled, it'll submit normally with the form api. This is all working fine, but now for security reasons I want to submit the ajax version via the form api too. My form_name_submit is simple like: function mymodule_test_form_submit($form, &$form_state) { global $user; db_query("INSERT INTO {mymodule} (nid, uid, status, created) VALUES (%d, %d, %d, " . time() . ")", $form['#parameters'][2], $user->uid, $form_state['values']['mymodule_status']); } My ajax: $('.mysubmit').css('display', 'none'); $('.myclass').change(function() { $.ajax({ type: 'POST', url: Drupal.settings.basePath + 'mymodule/set/' + $nid + '/' + $('.myclass').val(), dataType: 'json', data: { 'ajax' : true, 'form_build_id' : $('#mymodule-form input[name=form_build_id]').val() } }); }); And my callback function: function mymodule_set($nid, $status) { $form_build_id = $_POST['form_build_id']; $form_state = array('storage' => NULL, 'submitted' => FALSE); $form = form_get_cache($form_build_id, $form_state); $args = $form['#parameters']; $form_id = array_shift($args); $form['#post'] = $_POST; $form['#redirect'] = FALSE; $form['#programmed'] = FALSE; $form_state['post'] = $_POST; drupal_process_form($form_id, $form, $form_state); } Originally my callback function was about the same as my submit function, but now I'm trying to use the submit function with ajax as well. Is this the right way to use drupal_process_form? The form is grabbed from the cache, it get's validated and submitted if no errors? I'm using some code from this tutorial to apply to my situation: http://drupal.org/node/331941 There doesn't seem to be any examples of what I'm trying to do. I also have $form['#cache'] = TRUE; in my form function. How does drupal_process_form compare the submitted values with the original form to check for integrity? Am I supposed to add my values to the form_state since the form state will be empty with ajax. Been stuck on this for a few days, hopefully someone has experience with this. Thanks.
