[site]: stackoverflow
[post_id]: 4667917
[parent_id]: 4667596
[tags]: 
I would simplify what you're trying to do by creating a stored procedure which will produce the leader/agent stats and then just call it from your php (single call) as follows: full script here : http://pastie.org/1451802 alternatively, you could probably combine your individual queries into a single select/group by statement. see here : http://pastie.org/1451842 select leaders.agent_name, sum(leaders.job_value) as sum_job_value, sum(leaders.points_value) as sum_points_value from ( select agent_name, job_number, job_value, points_value from jobs where year(booked_date) = 2011 and weekofyear(booked_date) = 2 union all select distinct agent_name, 0,0,0 from apps where year(booked_date) = 2011 and weekofyear(booked_date) = 2 ) leaders group by agent_name order by sum_points_value desc; Stored procedure drop procedure if exists list_leaders; delimiter # create procedure list_leaders ( in p_year smallint unsigned, in p_week tinyint unsigned ) begin create temporary table tmp_leaders( agent_name varchar(20) not null, job_number int unsigned not null default 0, -- note the default values job_value decimal(3,1) not null default 0, points_value decimal(8,2) not null default 0 )engine=memory; insert into tmp_leaders (agent_name, job_number, job_value, points_value) select agent_name, job_number, job_value, points_value from jobs where year(booked_date) = p_year and weekofyear(booked_date) = p_week; insert into tmp_leaders (agent_name) -- requires default values otherwise you will get nulls select distinct agent_name from apps where year(booked_date) = p_year and weekofyear(booked_date) = p_week; select agent_name, sum(job_value) as sum_job_value, sum(points_value) as sum_points_value from tmp_leaders group by agent_name order by sum_points_value desc; drop temporary table if exists tmp_leaders; end# delimiter ; call list_leaders(year(curdate()), weekofyear(curdate())); PHP script connect_errno) throw new exception(sprintf("Could not connect: %s", $db->connect_error)); $sqlCmd = "call list_leaders(2011, 2)"; $result = $db->query($sqlCmd); if(!$result) throw new exception(sprintf("Invalid query : %s", $sqlCmd)); if($db->affected_rows fetch_all(MYSQLI_ASSOC); foreach($leaders as $ldr){ // do stuff echo $ldr["agent_name"], " "; } } } catch(exception $ex) { ob_clean(); echo sprintf("zomg borked - %s", $ex->getMessage()); } if(!$db->connect_errno) $db->close(); ob_end_flush(); ?> Kinda simpler now - hope it helps :)
