[site]: stackoverflow
[post_id]: 1555520
[parent_id]: 1555488
[tags]: 
WITH cb AS ( SELECT CompanyId, NumberText, ROW_NUMBER() OVER (PARTITION BY CompanyID ORDER BY NumberText) AS rn FROM CompanyNumbers ) SELECT CompanyID, batch, ( SELECT CASE WHEN rn % 150 = 1 THEN '' ELSE ', ' END + NumberText AS [text()] FROM cb WHERE cb.CompanyID = cbd.CompanyID AND rn BETWEEN cbd.batch * 150 + 1 AND cbd.batch * 150 + 150 FOR XML PATH('') ) FROM ( SELECT DISTINCT CompanyID, FLOOR((rn - 1) / 150) AS batch FROM cb ) AS cbd
