[site]: stackoverflow
[post_id]: 4224216
[parent_id]: 
[tags]: 
ANTLR rewrite query text to repeat text with earlier nodes

I am new to ANTLR and am trying to parse queries using the following grammar SearchEngineQuery; options { language = CSharp2; output = AST; } tokens { AndNode; } LPARENTHESIS : '('; RPARENTHESIS : ')'; AND : 'and'; OR : 'or'; ANDNOT : 'andnot'; NOT : 'not'; NEAR : 'near'; fragment CHARACTER : ('a'..'z'|'0'..'9'|'-'); fragment QUOTE : ('"'); fragment WILDCARD : ('*'|'?'); fragment SPACE : (' '|'\n'|'\r'|'\t'|'\u000C'); WILD_STRING : (CHARACTER)* ( ('?') (CHARACTER)* )+ ; PREFIX_STRING : (CHARACTER)+ ( ('*') )+ ; WS : (SPACE) { $channel=HIDDEN; }; PHRASE : (QUOTE)(WORD)(WILDCARD)?((SPACE)+(WORD)(WILDCARD)?)*(QUOTE); WORD : (CHARACTER)+; startExpression : nearExpression; nearExpression : andExpression (NEAR^ andExpression)*; andExpression : (andnotExpression -> andnotExpression) (AND? a=andnotExpression -> ^(AndNode $andnotExpression $a))* ; andnotExpression : orExpression (ANDNOT^ orExpression)*; orExpression : notExpression (OR^ notExpression)* ; notExpression : (NOT^)? (phraseExpression | wildExpression | prefixExpression | atomicExpression); phraseExpression : (PHRASE^); wildExpression : (WILD_STRING^); prefixExpression : (PREFIX_STRING^); atomicExpression : WORD | LPARENTHESIS! andExpression RPARENTHESIS!; This seems to work ok for general queries. However, the case of a near (b or c) needs to be actually handled as: and a near (b or c and (d or e)) needs to be handled as: I am unable to determine how to do this. Any help would be most appreciated. Thanks
