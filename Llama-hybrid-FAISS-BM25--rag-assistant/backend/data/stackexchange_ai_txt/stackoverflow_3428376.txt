[site]: stackoverflow
[post_id]: 3428376
[parent_id]: 3428115
[tags]: 
Will A 's comment on my original post found the key - the collation. My posted query worked for me in the master database, too. Examining the collation suggested I was on the right track. SELECT DATABASEPROPERTYEX('crm_mscrm', 'Collation') crmSQLCollation crmSQLCollation -------------------- Latin1_General_CI_AI (1 row(s) affected) SELECT DATABASEPROPERTYEX('master', 'Collation') masterSQLCollation masterSQLCollation ---------------------------- SQL_Latin1_General_CP1_CI_AS (1 row(s) affected) Some frenzied searching later, I had this monstrosity of code, which explicitly specifies collation on each column, successfully executes, and returns the expected results To wit: if object_id('tempdb..#tOwner') IS NOT NULL drop table #tOwner; CREATE TABLE #tOwner(id int identity(1,1), email nvarchar(max) ); insert into #towner values ( cast('123@123.321' as nvarchar(max))); insert into #towner values ( cast('tsql rage' as nvarchar(max))); insert into #towner values ( cast('another@e.c' as nvarchar(max))); insert into #towner values ( cast('einstein.x.m' as nvarchar(max))); ;WITH data AS ( SELECT DISTINCT convert(nvarchar(max), email) datapoint FROM #tOwner ), CTE ( data_list, datapoint, length ) AS ( SELECT convert(nvarchar(max), '' ) Collate SQL_Latin1_General_CP1_CI_AS,convert(nvarchar(max), '' ) Collate SQL_Latin1_General_CP1_CI_AS, 0 UNION ALL SELECT convert(nvarchar(max),d.datapoint+';'+data_list) Collate SQL_Latin1_General_CP1_CI_AS,convert(nvarchar(max),d.datapoint) Collate SQL_Latin1_General_CP1_CI_AS, length + 1 FROM CTE c CROSS JOIN data d WHERE d.datapoint > c.datapoint ) SELECT D.data_list FROM ( SELECT data_list, RANK() OVER ( PARTITION BY 1 ORDER BY length DESC ) FROM CTE ) D ( data_list, rank ) WHERE rank = 1 ; if object_id('tempdb..#tOwner') IS NOT NULL drop table #tOwner; Sitting beautifully in my results window is the expected: data_list ------------------------------------------------ tsql rage;einstein.x.m;another@e.c;123@123.321;
