[site]: stackoverflow
[post_id]: 5492007
[parent_id]: 5487846
[tags]: 
So, I'm posting my attempt at this question for three reasons... To Make Quassnoi's answer look even more elegant Because I spent about two hours on it and I don't want to throw it away On the rare possibility that you're using something earlier than SQL 2005, this might be useful Here, there are three routes... Foo: Locations 1, 2, 3, 4 Bar: Locations 4, 3, 2, 1 Quicky: Locations 2, 3 This query, while long, is giving me the correct results for the test data included: CREATE TABLE #Routes ( RouteID INT, RouteName VARCHAR(50), ) CREATE TABLE #RoutePoints ( RouteID INT, LocationID INT, SequenceNumber INT ) CREATE TABLE #MapLocations ( LocationID INT, LocationName VARCHAR(50) ) CREATE TABLE #GPSData ( VehicleID INT, LocationID INT, Time DATETIME ) INSERT INTO #Routes (RouteID, RouteName) VALUES (1, 'Foo') INSERT INTO #Routes (RouteID, RouteName) VALUES (2, 'Bar') INSERT INTO #Routes (RouteID, RouteName) VALUES (3, 'Quicky') INSERT INTO #MapLocations (LocationID, LocationName) VALUES (1, 'Warehouse') INSERT INTO #MapLocations (LocationID, LocationName) VALUES (2, 'School') INSERT INTO #MapLocations (LocationID, LocationName) VALUES (3, 'Stadium') INSERT INTO #MapLocations (LocationID, LocationName) VALUES (4, 'Park') INSERT INTO #RoutePoints (RouteID, LocationID, SequenceNumber) VALUES (1, 1, 1) INSERT INTO #RoutePoints (RouteID, LocationID, SequenceNumber) VALUES (1, 2, 2) INSERT INTO #RoutePoints (RouteID, LocationID, SequenceNumber) VALUES (1, 3, 3) INSERT INTO #RoutePoints (RouteID, LocationID, SequenceNumber) VALUES (1, 4, 4) INSERT INTO #RoutePoints (RouteID, LocationID, SequenceNumber) VALUES (2, 4, 1) INSERT INTO #RoutePoints (RouteID, LocationID, SequenceNumber) VALUES (2, 3, 2) INSERT INTO #RoutePoints (RouteID, LocationID, SequenceNumber) VALUES (2, 2, 3) INSERT INTO #RoutePoints (RouteID, LocationID, SequenceNumber) VALUES (2, 1, 4) INSERT INTO #RoutePoints (RouteID, LocationID, SequenceNumber) VALUES (3, 2, 1) INSERT INTO #RoutePoints (RouteID, LocationID, SequenceNumber) VALUES (3, 3, 2) INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 12:17:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 12:18:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 12:19:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 12:20:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 12:21:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 12:22:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 12:23:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 3, '2011-03-26 12:24:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 3, '2011-03-26 12:25:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 18:17:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 18:18:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 18:19:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 18:20:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 18:21:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 18:22:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 18:23:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 3, '2011-03-26 18:24:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 3, '2011-03-26 18:25:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 4, '2011-03-26 18:26:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 4, '2011-03-26 18:27:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 18:28:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 19:17:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 19:18:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 19:19:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 19:20:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 19:21:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 19:22:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 2, '2011-03-26 19:23:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 3, '2011-03-26 19:24:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 3, '2011-03-26 19:25:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 4, '2011-03-26 19:26:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 4, '2011-03-26 19:27:50.000') INSERT INTO #GPSData (VehicleID, LocationID, Time) VALUES (1, 1, '2011-03-26 19:28:50.000') CREATE TABLE #GPSRoute ( RouteID INT, VehicleID INT, LocationID INT, SequenceNumber INT, Time DATETIME, StepsInRoute INT ) INSERT INTO #GPSRoute ( RouteID, VehicleID, LocationID, SequenceNumber, Time, StepsInRoute ) SELECT r.RouteID, gps.VehicleID, rp.LocationID, rp.SequenceNumber, gps.Time, ( SELECT COUNT(*) FROM #RoutePoints WHERE RouteID = r.RouteID ) FROM #Routes r JOIN #RoutePoints rp ON r.RouteID = rp.RouteID JOIN #GPSData gps ON gps.LocationID = rp.LocationID SELECT r.RouteID, r.RouteName, previousRouteStep.VehicleID, COUNT(*) / NULLIF(previousRouteStep.StepsInRoute - 1, 0) AS TimesRouteCompleted FROM #Routes r JOIN #GPSRoute previousRouteStep ON r.RouteID = previousRouteStep.RouteID JOIN #GPSRoute nextRouteStep ON previousRouteStep.RouteID = nextRouteStep.RouteID AND previousRouteStep.VehicleID = nextRouteStep.VehicleID AND previousRouteStep.SequenceNumber + 1 = nextRouteStep.SequenceNumber AND previousRouteStep.Time previousRouteStep.Time ) AND -- Only include the step if it is the latest step in the sequence that meets the criteria. previousRouteStep.Time = ( SELECT MAX(Time) FROM #GPSRoute WHERE RouteID = previousRouteStep.RouteID AND VehicleID = previousRouteStep.VehicleID AND sequenceNumber = previousRouteStep.sequenceNumber AND Time
