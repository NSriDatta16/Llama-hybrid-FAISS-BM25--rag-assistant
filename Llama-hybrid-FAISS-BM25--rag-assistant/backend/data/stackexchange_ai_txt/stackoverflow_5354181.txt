[site]: stackoverflow
[post_id]: 5354181
[parent_id]: 
[tags]: 
C# - Send HttpWebRequest to remote upload image?

For several days I've tried to write a program that remote upload image to an image host (imgur.com). I used Wireshark to sniff http requests sent by browser, then create HttpWebRequest with similar headers and parameters. But the server always send back to me something weird. Please look at the code (this code is simplified): static void Main(string[] args) { ServicePointManager.Expect100Continue = false; CookieContainer cc = new CookieContainer(); List formData = new List (); //The first request - login HttpWebRequest request = (HttpWebRequest)WebRequest.Create("http://imgur.com/signin"); configRequest(request, cc); //add POST params add(formData, "username", "abcdefgh"); //this is a working account, add(formData, "password", "abcdefgh"); //feel free to use it if you add(formData, "remember", "remember"); //want to test add(formData, "submit", ""); writeToRequestStream(request, formData); //send request request.GetResponse(); //The second request - remote upload image request = (HttpWebRequest)WebRequest.Create("http://imgur.com/upload?sid_hash=9efff36179fef47dc5e078a4575fd96a"); configRequest(request, cc); //add POST params formData = new List (); add(formData, "url", "http://img34.imageshack.us/img34/8425/89948070152259768406.jpg"); add(formData, "create_album", "0"); add(formData, "album_title", "Optional Album Title"); add(formData, "album_layout", "b"); add(formData, "edit_url", "0"); writeToRequestStream(request, formData); //send request Stream s = request.GetResponse().GetResponseStream(); StreamReader sr = new StreamReader(s); string html = sr.ReadToEnd(); sr.Close();s.Close(); Console.WriteLine(html + "\n\n"); } static void add(List formData, string key, string value) { formData.Add(HttpUtility.UrlEncode(key) + "=" + HttpUtility.UrlEncode(value)); } static void configRequest(HttpWebRequest request, CookieContainer cc) { request.Method = "POST"; request.ContentType = "application/x-www-form-urlencoded; charset=UTF-8"; request.CookieContainer = cc; request.Credentials = CredentialCache.DefaultCredentials; request.Accept = "*/*"; request.KeepAlive = true; request.Referer = "http://imgur.com/"; request.UserAgent = "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.2.15) Gecko/20110303 Firefox/3.6.15"; request.Headers.Add("Accept-Language", "en-us,en;q=0.5"); request.Headers.Add("Accept-Encoding", "gzip,deflate"); request.Headers.Add("Accept-Charset", "ISO-8859-1,utf-8;q=0.7,*;q=0.7"); request.Headers.Add("Keep-Alive", "115"); request.Headers.Add("X-Requested-With", "XMLHttpRequest"); request.Headers.Add("Pragma", "no-cache"); request.Headers.Add("Cache-Control", "no-cache"); } static void writeToRequestStream(HttpWebRequest request, List formData) { //build request stream string queryString = String.Join("&", formData.ToArray()); byte[] byteArray = Encoding.UTF8.GetBytes(queryString); //write to stream request.ContentLength = byteArray.Length; Stream rs = request.GetRequestStream(); rs.Write(byteArray, 0, byteArray.Length); rs.Close(); } Now I sniff my uploading request (2nd request) and compare it to the browser's request, there're only 2 differences: Browser's 'Connection' header ='keep-alive' but mine doesn't exist (I don' know why although request.Keep-alive is set to 'true') Some browser's cookies doesn't appear in mine. The response should be a JSON, something like this: {"hashes":"[\"QcvII\"]","hash":"QcvII","album":false,"edit":false} But the server responses to my request by a pile of special characters... I can't find out which in above 2 differences makes my code doesn't work. I will extremely appreciate if you can help me making this code work. I'm a newbie so please don't blame me if my code or my expression's silly. Can anybody help to make this code work? P/S: i'm using .net framework 4
