[site]: stackoverflow
[post_id]: 4841328
[parent_id]: 4841289
[tags]: 
Here's one way to create a text node that can be used with swap inside a DocumentFragment: require 'nokogiri' frag = Nokogiri::HTML::DocumentFragment.parse( "foo" ) foo = frag.children.first foo.swap( Nokogiri::XML::Text.new( "bar", foo.document ) ) puts frag #=> bar Edit: There's definitely something subtle going on here, based on the following. I've filed a bug report for you. It appears to parse the string correctly if the text is not at the root of the DocumentFragment, or if this is a Document and not fragment: require 'nokogiri' elems = " foo bar baz" rooted = " #{elems} " doc = Nokogiri::XML rooted doc.at_xpath('/r/a1').swap( 'x1' ) # Element->text doc.at_xpath('/r/a2/text()').swap( 'jim' ) # Text->text doc.at_xpath('/r/a3').swap( ' ' ) # Element->element doc.at_xpath('/r/a4/text()').swap( ' jam ' ) # Text->element doc.xpath('/r/text()').last.swap( 'jom' ) # RootText->text puts doc.root #=> x1 jim jam jom #=> (correct output) frag = Nokogiri::XML::DocumentFragment.parse rooted frag.at_xpath('./r/a1').swap( 'x1' ) # Element->text frag.at_xpath('./r/a2/text()').swap( 'jim' ) # Text->text frag.at_xpath('./r/a3').swap( ' ' ) # Element->element frag.at_xpath('./r/a4/text()').swap( ' jam ' ) # Text->element frag.xpath('./r/text()').last.swap( 'jom' ) # RootText->text puts frag #=> x1 jim jam jom #=> (correct output) frag = Nokogiri::XML::DocumentFragment.parse elems frag.at_xpath('./a1').swap( 'x1' ) # Element->text frag.at_xpath('./a2/text()').swap( 'jim' ) # Text->text frag.at_xpath('./a3').swap( ' ' ) # Element->element frag.at_xpath('./a4/text()').swap( ' jam ' ) # Text->element baz = frag.children.last begin baz.swap( 'jom' ) # RootText->text rescue Exception => e p baz #=> # p e #=> # puts e.backtrace #=> /usr/local/lib/ruby/gems/1.9.1/gems/nokogiri-1.4.4/lib/nokogiri/xml/node.rb:509:in `in_context' #=> /usr/local/lib/ruby/gems/1.9.1/gems/nokogiri-1.4.4/lib/nokogiri/xml/node.rb:509:in `parse' #=> /usr/local/lib/ruby/gems/1.9.1/gems/nokogiri-1.4.4/lib/nokogiri/xml/document_fragment.rb:14:in `initialize' #=> /usr/local/lib/ruby/gems/1.9.1/gems/nokogiri-1.4.4/lib/nokogiri/xml/node.rb:485:in `new' #=> /usr/local/lib/ruby/gems/1.9.1/gems/nokogiri-1.4.4/lib/nokogiri/xml/node.rb:485:in `fragment' #=> /usr/local/lib/ruby/gems/1.9.1/gems/nokogiri-1.4.4/lib/nokogiri/xml/node.rb:885:in `coerce' #=> /usr/local/lib/ruby/gems/1.9.1/gems/nokogiri-1.4.4/lib/nokogiri/xml/node.rb:382:in `replace' #=> /usr/local/lib/ruby/gems/1.9.1/gems/nokogiri-1.4.4/lib/nokogiri/xml/node.rb:407:in `swap' #=> /Users/phrogz/Desktop/test_swap.rb:32:in ` ' end puts frag #=> x1 jim #=> jam #=> baz Edit 2 : This has been confirmed as a bug by the Nokogiri development team: OMG! Thanks for the boog report! I'm sure we don't have any test coverage that runs Node#replace and #swap on text nodes, so hopefully I'll be able to fix this for the 1.4.5 release.
