[site]: stackoverflow
[post_id]: 1542957
[parent_id]: 
[tags]: 
why my WebClient upload file code hangs?

I am using VSTS 2008 + C# + .Net 3.5 + ASP.Net + IIS 7.0 to develop a Windows Forms application at client side to upload a file, and at server side I receive this file using an aspx file. I find my client side application will hang after click the button to trigger upload event. Any ideas what is wrong and how to solve? Thanks! Client side code, public partial class Form1 : Form { private static WebClient client = new WebClient(); private static ManualResetEvent uploadLock = new ManualResetEvent(false); private static void Upload() { try { Uri uri = new Uri("http://localhost/Default2.aspx"); String filename = @"C:\Test\1.dat"; client.Headers.Add("UserAgent", "TestAgent"); client.UploadProgressChanged += new UploadProgressChangedEventHandler(UploadProgressCallback); client.UploadFileCompleted += new UploadFileCompletedEventHandler(UploadFileCompleteCallback); client.UploadFileAsync(uri, "POST", filename); uploadLock.WaitOne(); } catch (Exception e) { Console.WriteLine(e.StackTrace.ToString()); } } public static void UploadFileCompleteCallback(object sender, UploadFileCompletedEventArgs e) { Console.WriteLine("Completed! "); uploadLock.Set(); } private static void UploadProgressCallback(object sender, UploadProgressChangedEventArgs e) { Console.WriteLine("{0} uploaded {1} of {2} bytes. {3} % complete...", (string)e.UserState, e.BytesSent, e.TotalBytesToSend, e.ProgressPercentage); // Console.WriteLine (e.ProgressPercentage); } public Form1() { InitializeComponent(); } private void button1_Click(object sender, EventArgs e) { Upload(); } } Server side code: protected void Page_Load(object sender, EventArgs e) { string agent = HttpContext.Current.Request.Headers["UserAgent"]; using (FileStream file = new FileStream(@"C:\Test\Agent.txt", FileMode.Append, FileAccess.Write)) { byte[] buf = Encoding.UTF8.GetBytes(agent); file.Write(buf, 0, buf.Length); } foreach (string f in Request.Files.AllKeys) { HttpPostedFile file = Request.Files[f]; file.SaveAs("C:\\Test\\UploadFile.dat"); } }
