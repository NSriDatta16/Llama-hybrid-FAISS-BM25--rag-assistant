[site]: crossvalidated
[post_id]: 333593
[parent_id]: 
[tags]: 
Dealing with Numerical Issues from Computing Weighted Sample Covariance Matrix

I have vector-valued samples $\mathbf{x}_1, \mathbf{x}_2, \ldots, \mathbf{x}_N$ with normalized weights $w_1, \ldots, w_N$. I'm trying to compute a weighted sample covariance matrix: $$ \sum_i w_i (\mathbf{x}_i - \bar{\mathbf{x}}) (\mathbf{x}_i - \bar{\mathbf{x}})^T = \sum_i w_i \mathbf{x}_i\mathbf{x}_i^T - \bar{\mathbf{x}}\bar{\mathbf{x}}^T, $$ where $\bar{\mathbf x} = \sum w_i \mathbf x_i$. Usually I use the expression on the right hand side because it is a function of weighted averages of the data. However, I have noticed that these covariance matrices aren't always positive definite numerically, even though they should be, theoretically speaking. How exactly does this numerical error creep in, and what can I do about it? Why is this fix preferable (I've seen several suggestions after an internet search)? FWIW: I would prefer not to use the expression on the left hand side because it would involve changing some code I'd rather not change.
