[site]: datascience
[post_id]: 114201
[parent_id]: 
[tags]: 
Sklearn pipeline and custom transformers to remove specific value from columns

I'm trying to use sklearn pipelines and custom transformers to do outlier removal. What I want to do is identify outliers using an IQR-filter, set the outlier values to 'OUTLIER' (not NaN), and then remove all 'OUTLIER' values in the numerical columns. The reason for setting the otulier values to 'OUTLIER' instead of NaN is because I want to impute existing NaN values while removing outlier values. The pipeline would then be IQR-filter, remove outliers, impute missing values, standard scaler . What I've tried are the following custom transformers: class FeatureSelector(BaseEstimator, TransformerMixin): def __init__(self, feature_names): self.feature_names = feature_names def fit(self, X, y=None): return self def transform(self, X): return X[self.feature_names] class IQRFilter(BaseEstimator,TransformerMixin): def __init__(self,factor=2): self.factor = factor def outlier_detector(self,X,y=None): X = pd.Series(X).copy() q1 = X.quantile(0.25) q3 = X.quantile(0.75) iqr = q3 - q1 self.lower_bound.append(q1 - (self.factor * iqr)) self.upper_bound.append(q3 + (self.factor * iqr)) def fit(self,X,y=None): self.lower_bound = [] self.upper_bound = [] X.apply(self.outlier_detector) return self def transform(self,X,y=None): X = pd.DataFrame(X).copy() for i in range(X.shape[1]): x = X.iloc[:, i].copy() x[(x self.upper_bound[i])] = 'OUTLIER' X.iloc[:, i] = x return X class RemoveIQROutliers(BaseEstimator, TransformerMixin): def __init__(self): pass def fit(self, X, y=None): return self def transform(self, X): return X.loc[X != 'OUTLIER'] And the following pipeline: numerical_pipeline = Pipeline([ ('FeatureSelector', FeatureSelector(num_cols)), ('iqr_filter', IQRFilter()), ('remove_outliers', RemoveIQROutliers()), ('imputer', SimpleImputer(strategy='median')), ('std_scaler', StandardScaler()) ]) However, runnning numerical_pipeline.fit_transform(X_train) results in this error output: KeyError Traceback (most recent call last) C:\Users\usert~1\AppData\Local\Temp/ipykernel_21276/3029174893.py in ----> 1 numerical_pipeline.fit_transform(X_train) ~\AppData\Roaming\Python\Python39\site-packages\sklearn\pipeline.py in fit_transform(self, X, y, **fit_params) 412 """ 413 fit_params_steps = self._check_fit_params(**fit_params) --> 414 Xt = self._fit(X, y, **fit_params_steps) 415 416 last_step = self._final_estimator ~\AppData\Roaming\Python\Python39\site-packages\sklearn\pipeline.py in _fit(self, X, y, **fit_params_steps) 334 cloned_transformer = clone(transformer) 335 # Fit or load from cache the current transformer --> 336 X, fitted_transformer = fit_transform_one_cached( 337 cloned_transformer, 338 X, c:\anaconda3\envs\datascience\lib\site-packages\joblib\memory.py in __call__(self, *args, **kwargs) 347 348 def __call__(self, *args, **kwargs): --> 349 return self.func(*args, **kwargs) 350 351 def call_and_shelve(self, *args, **kwargs): ... -> 5842 raise KeyError(f"None of [{key}] are in the [{axis_name}]") 5843 5844 not_found = list(ensure_index(key)[missing_mask.nonzero()[0]].unique()) KeyError: "None of [Index([ ('l', 'i', 'n', 'e', '_', 'n', 'o'),\n ('p', 'a', 'r', 't', '_', 'p', 'r', 'i', 'c', 'e'),\n ('b', 'u', 'y', '_', 'q', 't', 'y', '_', 'd', 'u', 'e'),\n ('l', 'i', 'n', 'e', '_', 't', 'o', 't', 'a', 'l', '_', 'w', 'e', 'i', 'g', 'h', 't'),\n ('c', 'o', 's', 't'),\n ('d', 'i', 's', 'c', 'o', 'u', 'n', 't'),\n ('p', 'o', 'r', 't', '_', 'l', 'e', 'a', 'd', '_', 't', 'i', 'm', 'e'),\n ('d', 'e', 'a', 'd', 'w', 'e', 'i', 'g', 'h', 't'),\n ('v', 'a', 'l', 'u', 'e', '_', 'u', 's', 'd', '_', 's', 'p', 'o', 't', '_', 'l', 'i', 'n', 'e')],\n dtype='object')] are in the [index]" Edit: X_train.info(): Int64Index: 13400 entries, 1993441 to 1970783 Data columns (total 20 columns): # Column Non-Null Count Dtype --- ------ -------------- ----- 0 X1 13400 non-null float64 1 X2 13400 non-null float64 2 X3 13400 non-null float64 3 X4 13181 non-null float64 4 X5 13400 non-null float64 5 X6 13400 non-null float64 6 X7 13209 non-null float64 7 X8 11956 non-null float64 8 X9 13400 non-null float64 9 X10 13400 non-null object 10 X11 13400 non-null object 11 X12 13191 non-null object 12 X13 11999 non-null object 13 X14 13380 non-null object 14 X15 13400 non-null object 15 X16 13400 non-null object 16 X17 11976 non-null object 17 X18 11976 non-null object 18 X19 13367 non-null object 19 X20 13400 non-null object dtypes: float64(9), object(11) memory usage: 2.1+ MB
