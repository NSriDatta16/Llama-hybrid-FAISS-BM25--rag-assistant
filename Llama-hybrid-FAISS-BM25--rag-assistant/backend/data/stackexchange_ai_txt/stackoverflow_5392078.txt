[site]: stackoverflow
[post_id]: 5392078
[parent_id]: 
[tags]: 
Using factory_girl with mongoid to test referenced_in/references_many

I am trying to test an associated document for a subscription service. Each subscription is embedded in an account and references a plan. Below is the various bits of code: The account: Factory.define :account, :class => Account do |a| a.subdomain 'test' a.agents { [ Factory.build(:user) ] } a.subscription { Factory.build(:free_subscription) } end The subscription: Factory.define :free_subscription, :class => Subscription do |s| s.started_at Time.now s.plan { Factory.build(:free_plan) } end The plan: Factory.define :free_plan, :class => Plan do |p| p.plan_name 'Free' p.cost 0 end The error: Mongoid::Errors::InvalidCollection: Access to the collection for Subscription is not allowed since it is an embedded document, please access a collection from the root document. If I comment out the line that links the plan to the subscription then the tests work, but obviously I can't test that the subscription has a plan. Any suggestions would be greatly appreciated. UPDATE: Here are the models: class Account include Mongoid::Document field :company_name, :type => String field :subdomain, :type => String field :joined_at, :type => DateTime embeds_one :subscription accepts_nested_attributes_for :subscription before_create :set_joined_at_date private def set_joined_at_date self.joined_at = Time.now end end class Subscription include Mongoid::Document field :coupon_verified, :type => Boolean field :started_at, :type => DateTime referenced_in :plan embedded_in :account, :inverse_of => :subscription end class Plan include Mongoid::Document field :plan_name, :type => String field :cost, :type => Integer field :active_ticket_limit, :type => Integer field :agent_limit, :type => Integer field :company_limit, :type => Integer field :client_limit, :type => Integer field :sla_support, :type => Boolean field :report_support, :type => Boolean references_many :subscriptions end
