[site]: stackoverflow
[post_id]: 5694037
[parent_id]: 
[tags]: 
Apache2 with PDF and PHP - "This file does not start with "%PDF-"

I have been trying to find the reason for this error for weeks now - and I have come up a blank. The system uses PHP to generate dynamic .pdf files. I have three servers: Dev (Win7 with Apache2), Test (Ubuntu 10.4 with nginx), and Live (Ubuntu 10.10 with nginx). All are running php5 and the system I have developed - same code. Equivalent, same config. I have many browsers I have tested things with: DevIE (win7, IE8), DevFF (Win7 Firefox 3.5), DevSaf (win, Safari), LaptopFF (WinXP, Firfox 3.5), Laptop IE(WinXP, IE8 Test (Ubuntu FF3.5), and users (mostly IE8 on Win 7 and Win XP). When I generate a PDF from Test it works correctly in all browsers (except Users which I can't test). When I generate a PDF from Dev it fails from DevIE, DevFF and DevSaf, but calling for it from Test works. Apache2 always fails from the same machine. From the laptop, using FF succeeds, and using IE8 fails (see below). The users are reporting intermittent problems. It fails, and then the repeat the request and it succeeds. When it fails.... The log of the generated PDF is shown, sending the right sort of size reply (500KB to 1.8MB) with a 200 OK result. This is sometimes followed about 10 seconds later with a repeat of the same URL - but this generates the log-on screen (again 200 OK reply), but only 2K in size. The implication is that it was requested without the cookie. Adobe Reader tries to display the log-on page, with the inevitable "This file does not start with "%PDF-" error message. Except for when I try with the laptop and IE8 - then it fails with show source showing a 4 line html file with an empty body! The system has been working for over a year - and only started failing with a change of production server about 2 months ago. The test version was not changed at this time, but started to fail also. I have tried all sorts of headers, but nothing I have tried makes any difference. The current set of headers is: header('Content-Disposition: inline; filename="'.$this->pdfFilename().'"'); header('Content-type: application/pdf'); header("Pragma: public"); $when = date('r',time()+20); // expire in 20 seconds header("Expires: $when"); I've tried replacing inline with attachment. Adding and removing all sorts of no-cache headers. All to no avail. The PDF is requested in a new window, by JavaScript - and is followed 8 seconds later by a refresh. I have tested without the new window, and without the refresh - no change. I have has a few (small) PDFs served by the Dev server. So I have raised every limit I can think of. Now it always fails. So I have a Windows Apache2.2 server that fails when browsed from the same machine and succeeds when browsed from other machines in Firefox. There is no proxy or cache mechanism involved other than that in the browsers. Has anyone any ideas about what might be going wrong? As I said, I have been testing and eliminating things for nearly 4 weeks now, on and off, and I have not yet even identified the failing component.
