[site]: stackoverflow
[post_id]: 5085009
[parent_id]: 5080388
[tags]: 
I very strongly suggest that you try writing code without using any function handles until you're really familiar with Matlab. The line de =@ (i,j) (2*mB*H).*mlat(i,j); is what causes your problems. In Matlab, when you define a function handle that refers to, say, an array, the function handle will use the array as it was at the time of definition. In other words, even though mlat changes inside your loop, mlat(i,j) inside the function de is always the same. In fact, you cannot even run this code unless you have previously defined mlat in the workspace. You should therefore rewrite the main loop as follows for iStep = 1:maxStep for imc = 1:mcs pmetro = $some function of mlat - this can be calculated using the entire array as input %# for each element in mlat (and thus pmetro), decide whether %# you have to switch the spin switchIdx = pmetro > 1 | pmetro Also, note that there is a command mean to take the average. No need to sum and then divide by the number of elements.
