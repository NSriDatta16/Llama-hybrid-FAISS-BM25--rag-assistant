[site]: stackoverflow
[post_id]: 5141323
[parent_id]: 
[tags]: 
Performance test "works on my machine", but not on the build server. What's missing?

I've set up an integration test that mimics the production usage of a WCF service. The code runs impersonated under a test user account present in our active directory. The test user is a member of the administrators group on the build server (running TeamCity 5.1.3). The WCF service is in this case hosted by a console app, and is started by the test like so: private const string _uri = "net.tcp://127.0.0.1:8090/bpaic"; private const string _tns = "tstdaily"; ... _wcfProcessHandle = Process.Start(new ProcessStartInfo { FileName = _serviceRunnerPath, Arguments = "\"{0}\" \"{1}\"".FormatWith( _uri, _tns ), UseShellExecute = false, Domain = Config.Domain, UserName = Config.UserName, Password = Config.UserPassword.ToSecureString() }); A File.Exists call ensures that the executable defined by _serviceRunnerPath is present. The error manifests itself in the build server log like so: Test(s) failed. System.InvalidOperationException : Cannot process request because the process (4332) has exited. at System.Diagnostics.Process.GetProcessHandle(Int32 access, Boolean throwIfExited) at System.Diagnostics.Process.Kill() at BondPriceAndInterestCalculator.IntegrationTests.Performance.MimicFMSTest.KillWcfService() in d:\TeamCity Agents\Server Agent 1\work\40cccfdaa4a1ba8\BondPriceAndInterestCalculator.IntegrationTests\Performance\MimicFMSTest.cs:line 74 at BondPriceAndInterestCalculator.IntegrationTests.Performance.MimicFMSTest.Calculat1000PricesAnd1000OutstandingInterestsInParalell() in d:\TeamCity Agents\Server Agent 1\work\40cccfdaa4a1ba8\BondPriceAndInterestCalculator.IntegrationTests\Performance\MimicFMSTest.cs:line 69 ------- Stdout: ------- Unhandled exception in remote appdomain: System.ServiceModel.EndpointNotFoundException: Could not connect to net.tcp://127.0.0.1:8090/bpaic. The connection attempt lasted for a time span of 00:00:01.0673145. TCP error code 10061: No connection could be made because the target machine actively refused it 127.0.0.1:8090. ---> System.Net.Sockets.SocketException: No connection could be made because the target machine actively refused it 127.0.0.1:8090 at System.Net.Sockets.Socket.DoConnect(EndPoint endPointSnapshot, SocketAddress socketAddress) at System.Net.Sockets.Socket.Connect(EndPoint remoteEP) at System.ServiceModel.Channels.SocketConnectionInitiator.Connect(Uri uri, TimeSpan timeout) --- End of inner exception stack trace --- I.e., the exception doesn't occur at the time of process start, but rather when trying to kill the service after the test run. No work has been logged by the service so I assume it never was able to service requests. Everything works fine on my machine (heard that one before? ;-)), but the WCF service doesn't get started on the build server. What's missing?
