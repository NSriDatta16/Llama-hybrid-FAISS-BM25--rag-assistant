[site]: stackoverflow
[post_id]: 1629724
[parent_id]: 1558932
[tags]: 
It seemed to be something to do with the mouse capture!? The normal sequence of events during a drag goes something like this... The PreviewMouseLeftButtonDown handler gets called and ListBox.IsMouseCaptureWithin is false. The PreviewMouseMove handler gets called. By this time ListBox.IsMouseCaptureWithin is true. During the PreviewMouseMove handler DragDrop.DoDragDrop gets called and sometime during this the mouse capture is released from the ListBox. But, what seems to happening for a drag started when the context menu is open is... The PreviewMouseLeftButtonDown handler gets called and ListBox.IsMouseCaptureWithin is false. The PreviewMouseMove handler gets called. But this time ListBox.IsMouseCaptureWithin is still false. Sometime after the end of the PreviewMouseMove handler the ListBox then gets the mouse capture ( ListBox.IsMouseCaptureWithin becomes true) The result of this is that after the drag, the ListBox still has the mouse capture so any clicks on the button to open the context menu are actually going to the listbox not the button. Adding the following code to the start of the PreviewMouseLeftButtonDown handler seems to help by swallowing up the click that closes that context menu rather than trying to start a drag from it... if (!contextMenuCloseComplete) { sourceElement.CaptureMouse(); return; } ...with the contextMenuCloseComplete bool getting set in handlers for the context menu's Closed and Opened events. Does that make sense? Does anyone understand where this mouse capture behaviour is coming from?
