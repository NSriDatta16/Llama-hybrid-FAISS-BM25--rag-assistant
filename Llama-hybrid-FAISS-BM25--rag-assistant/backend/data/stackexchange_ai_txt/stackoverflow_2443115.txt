[site]: stackoverflow
[post_id]: 2443115
[parent_id]: 
[tags]: 
Apache/mod_rewrite > Tomcat encoding %26 and "&"

Apache is the front-end to my web app then I use mod_rewrite to proxy the request to JBoss. So far this sounds pretty standard, but the problem I am having is: if I access the app directly through jboss @ http://localhost:8080/app/page?raw=foo%26bar&page=1 : request.getParameter("raw") = foo&bar If I access the app through Apache @ http://localhost/foo%26bar&page=1 request.getParameter("raw") = foo So somewhere along the way, the %26 is lost and replaced with an & which chops the raw variable. This is my Apache rewrite rule. RewriteRule ^/(.*) \ http://localhost:8080/app/home?raw=$1 [L,P] The Apache access log shows: http://localhost/foo%26bar&page=1 And the rewrite log shows: http://localhost:8080/app/home?raw=foo&bar&page=1 But I want the request to be: http://localhost:8080/app/home?raw=foo%26bar&page=1 I am pretty sure that this also occurs with slashes / too so to me this is some sort of encoding issue. Is there a way to proxy the URL untouched? Can't seem to figure this one out. EDIT: First thing I would like to say is thank you to Gumbo for giving me some very good suggestions! Based on those suggestions, I have simplified my Apache configuration for testing purposes. This is what it looks like: ServerRoot "C:/apps/xampplite/apache" Listen 80 LoadModule rewrite_module modules/mod_rewrite.so LoadModule log_config_module modules/mod_log_config.so ServerAdmin postmaster@localhost ServerName localhost:80 DocumentRoot "C:/apps/xampplite/htdocs" ErrorLog "logs/error.log" LogLevel debug DefaultType text/plain LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined LogFormat "%h %l %u %t \"%r\" %>s %b" common LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio CustomLog "logs/access.log" combined RewriteEngine On RewriteLog "C:/apps/xampplite/apache/logs/rewrite.log" RewriteLogLevel 9 RewriteMap escape int:escape RewriteRule ^/(.*) http://localhost:8080/app/home?raw=${escape:$1} [L,P] Here are the steps I took: Start Apache, go to http://localhost/foo%26bar&page=1 in my web browser, stop Apache. Access log entries: ::1 - - [15/Mar/2010:19:17:18 -0400] "GET /foo%26bar&page=1 HTTP/1.1" 403 224 "-" "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.2) Gecko/20100115 Firefox/3.6" Rewrite log entries: ::1 - - [15/Mar/2010:19:17:18 --0400] [localhost/sid#54d160][rid#5e1360/initial] (2) init rewrite engine with requested uri /foo&bar&page=1 ::1 - - [15/Mar/2010:19:17:18 --0400] [localhost/sid#54d160][rid#5e1360/initial] (3) applying pattern '^/(.*)' to uri '/foo&bar&page=1' ::1 - - [15/Mar/2010:19:17:18 --0400] [localhost/sid#54d160][rid#5e1360/initial] (5) map lookup OK: map=escape key=foo&bar&page=1 -> val=foo&bar&page=1 ::1 - - [15/Mar/2010:19:17:18 --0400] [localhost/sid#54d160][rid#5e1360/initial] (2) rewrite '/foo&bar&page=1' -> 'http://localhost:8080/app/home?raw=foo&bar&page=1' ::1 - - [15/Mar/2010:19:17:18 --0400] [localhost/sid#54d160][rid#5e1360/initial] (3) split uri=http://localhost:8080/app/home?raw=foo&bar&page=1 -> uri=http://localhost:8080/app/home, args=raw=foo&bar&page=1 ::1 - - [15/Mar/2010:19:17:18 --0400] [localhost/sid#54d160][rid#5e1360/initial] (2) forcing proxy-throughput with http://localhost:8080/app/home Error log entries: [Mon Mar 15 19:16:56 2010] [notice] Apache/2.2.12 (Win32) configured -- resuming normal operations [Mon Mar 15 19:16:56 2010] [notice] Server built: Jul 22 2009 11:35:54 [Mon Mar 15 19:16:56 2010] [notice] Parent: Created child process 2324 [Mon Mar 15 19:16:56 2010] [debug] mpm_winnt.c(487): Parent: Sent the scoreboard to the child [Mon Mar 15 19:16:57 2010] [notice] Child 2324: Child process is running [Mon Mar 15 19:16:57 2010] [debug] mpm_winnt.c(408): Child 2324: Retrieved our scoreboard from the parent. [Mon Mar 15 19:16:57 2010] [info] Parent: Duplicating socket 148 and sending it to child process 2324 [Mon Mar 15 19:16:57 2010] [info] Parent: Duplicating socket 140 and sending it to child process 2324 [Mon Mar 15 19:16:57 2010] [debug] mpm_winnt.c(605): Parent: Sent 2 listeners to child 2324 [Mon Mar 15 19:16:57 2010] [debug] mpm_winnt.c(564): Child 2324: retrieved 2 listeners from parent [Mon Mar 15 19:16:57 2010] [notice] Child 2324: Acquired the start mutex. [Mon Mar 15 19:16:57 2010] [notice] Child 2324: Starting 64 worker threads. [Mon Mar 15 19:16:57 2010] [notice] Child 2324: Starting thread to listen on port 80. [Mon Mar 15 19:16:57 2010] [notice] Child 2324: Starting thread to listen on port 80. [Mon Mar 15 19:17:18 2010] [error] [client ::1] attempt to make remote request from mod_rewrite without proxy enabled: proxy:http://localhost:8080/app/home [Mon Mar 15 19:17:52 2010] [notice] Parent: Received shutdown signal -- Shutting down the server. [Mon Mar 15 19:17:52 2010] [notice] Child 2324: Exit event signaled. Child process is ending. [Mon Mar 15 19:17:52 2010] [info] Child 2324: Accept thread exiting. [Mon Mar 15 19:17:53 2010] [notice] Child 2324: Released the start mutex [Mon Mar 15 19:17:53 2010] [info] Child 2324: Accept thread exiting. [Mon Mar 15 19:17:53 2010] [info] Child 2324: 64 threads blocked on the completion port [Mon Mar 15 19:17:54 2010] [notice] Child 2324: All worker threads have exited. [Mon Mar 15 19:17:54 2010] [notice] Child 2324: Child process is exiting [Mon Mar 15 19:17:54 2010] [notice] Parent: Child process exited successfully. [Mon Mar 15 19:17:54 2010] [info] removed PID file C:/apps/xampplite/apache/logs/httpd.pid (pid=1424) Interestingly enough the first entry in the access log shows the %26 and it is gone in the first entry of the rewrite log. Still puzzled by this one...
