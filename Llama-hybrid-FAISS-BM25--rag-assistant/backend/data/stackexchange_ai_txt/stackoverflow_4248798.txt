[site]: stackoverflow
[post_id]: 4248798
[parent_id]: 
[tags]: 
SQL datetime proximity against a set

server: sql 2008 R2; dataset: between 50-100 million records I have a table full of speed instances for vehicles from which I need to determine the average speed of all the cars (ie one number not a number for each car). The trick is the records span a great period of time and there is no consistency to the time when the records where recorded so I may have a recording at 8:15 for a car and nothing again until 8:20 whereas another car might have records for every 10 seconds inside that time period. Given a specific date and time I need to determine this average speed and since it is most likely there will not be a direct match between the given time and a recording for that car, I need to choose the speed from the recording closest to the given time. Here is a setup script CREATE TABLE [dbo].[SpeedRecords]( [Id] [int] IDENTITY(1,1) NOT NULL, [CarId] [int] NOT NULL, [TimeOfEntry] [datetime] NOT NULL, [Speed] [real] NOT NULL, CONSTRAINT [PK_SpeedRecords] PRIMARY KEY CLUSTERED ([Id] ASC)) go insert into SpeedRecords(CarId,TimeOfEntry,Speed) select 1, '11/22/2010 08:16:13', 67.56 union select 1, '11/22/2010 08:15:23', 63.87 union select 1, '11/22/2010 08:36:33', 45.66 union select 1, '11/22/2010 08:23:43', 56.87 union select 2, '11/22/2010 08:36:53', 78.66 union select 2, '11/22/2010 08:04:03', 34.88 union select 2, '11/22/2010 08:08:51', 23.23 union select 2, '11/22/2010 08:34:52', 65.87 union select 3, '11/22/2010 08:58:43', 45.34 union select 3, '11/22/2010 08:34:56', 73.23 union select 3, '11/22/2010 08:12:34', 12.87 union select 4, '11/22/2010 08:45:12', 66.45 union select 4, '11/22/2010 08:36:34', 90.87 union select 4, '11/22/2010 08:24:23', 34.89 union select 4, '11/22/2010 08:45:12', 45.83 declare @dt datetime = '11/22/2010 08:43:14' -- select the average speed (for all cars) but -- only use the record for each car closest to -- the given datetime (@dt)
