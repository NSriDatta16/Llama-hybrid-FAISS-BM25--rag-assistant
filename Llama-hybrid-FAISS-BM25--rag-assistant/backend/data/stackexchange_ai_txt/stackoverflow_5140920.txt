[site]: stackoverflow
[post_id]: 5140920
[parent_id]: 5140520
[tags]: 
Your main bottle neck appears to be the fact that the information you need is distributed over two databases. Thus, you acquire a list of friends and itterate through them. I would suggest that you attempt to remove the itteration, reducing it to a single query instead. The way I would achieve this is build up a comma delimited string of user ids, and pass that string to the second database. The sql in the second database could then (using a function, for example) translate the string intol a single field table of ids, and join on that. It feel very inellegant to me, yet it's something I do all the time. The only practical alternative that I have used is to build up a single query that inserts the IDs in to a table, then join on that. Either a temporary table, or a permanent table with a SessionID field allowing multiple sessions to use it concurrently. Whatever approach you use, have a single query for step 2, using a set based approach rather than itteration, should yield significant benefits.
