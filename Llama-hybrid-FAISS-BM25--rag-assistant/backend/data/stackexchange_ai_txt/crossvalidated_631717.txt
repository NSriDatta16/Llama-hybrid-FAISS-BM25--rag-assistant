[site]: crossvalidated
[post_id]: 631717
[parent_id]: 631711
[tags]: 
I don't know the origin of the idea that Schoenfeld residuals can't be used for testing proportional hazards (PH) with time-varying covariate values. As Therneau and Grambsch say in Section 4.6: Since the [Schoenfeld] residuals are defined at each unique death, their definition and computation is unchanged by a counting process formulation of the data set. The "counting process formulation of the data set" is precisely what's used for time-varying covariates. The Cox model simply uses whatever covariate values are currently in place for all individuals at risk at each event time. Whether a value for some individual might be different from some prior value doesn't matter (provided that there's no more than 1 event possible per individual). That fact, however, also points out the difficulty in formulating a useful time-varying covariate. Since only the current value of a covariate at an event time is used, the covariate value used for the model must incorporate whatever aspect of covariate history is associated with outcome at any particular time. I don't know whether the STATA PH test based on Schoenfeld residuals might have some issues with time-varying covariates, but there's not a theoretical problem. In response to/ incorporating comments The time dependence vignette for the base R survival package deals (explicitly or implicitly) with most of the issues raised in comments. I think that all contained in this answer and my comments comes pretty directly from there or from the classic Therneau and Grambsch text linked from the first paragraph. There is no problem with evaluating scaled Schoenfeld residuals for binary or categorical predictors, or for a mix of time-constant and time-varying covariates. A single yes/no time-varying exposure variable as you use for the beta-blockers assumes that the association of outcome with drug exposure is independent of the duration of exposure: that the very first day on the drug provides the same effect as being on it for 10 years. A rolling-average estimate of drug exposure over a biologically reasonable time span might be better. In practice, a 0/1 no-drug/drug covariate might work well enough. Constructing a useful time-varying covariate and testing it for PH are two different things. Whether you use a 0/1 drug exposure indicator or some type of running average, the PH test will determine whether the association of that marker with outcome is independent of time since diagnosis. PH might be violated, for example, if the drug made a lot of difference soon after diagnosis but had less association with outcome later on. I don't know what's available in STATA for testing the PH assumption via scaled Schoenfeld residuals. The vignette linked above describes what's available in the basic R survival package. Numeric tests for PH depend on the choice of time scale, something that isn't always obvious at first. There are several options for time-scale transformation available in R; transformation based on Kaplan-Meier estimates is a common choice. What's shown in your graph suggests that STATA is using a logarithmic transformation of time instead. In that time scale, at least, it looks like PH is a reasonable assumption, given the p -value that you report and the corresponding flat estimate of what I take to be a smoothed representation of the scaled residuals (see the "bandwidth" notation near the bottom of the graph). The R survival package does have an overall display and test of the PH assumption for multi-level categorical predictors. I don't know whether that's available in STATA. If a categorical predictor sufficiently violates PH and isn't of interest except as something for which you wish to control, stratification on that predictor can be a useful choice. That said, the PH assumption is less critical for such control predictors; see the discussion on this page . For a predictor of primary interest that fails PH, the vignette notes that partitioning of survival time into a few blocks can sometimes allow for PH within each time block, with a separate HR for each time block. Like any categorization of a continuous variable, however, that is somewhat arbitrary at best.
