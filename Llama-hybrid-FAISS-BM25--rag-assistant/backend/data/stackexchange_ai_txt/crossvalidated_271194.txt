[site]: crossvalidated
[post_id]: 271194
[parent_id]: 270196
[tags]: 
I didn't read the entire code but it seems the formula used is related to the following $$\|x-y\|=\sqrt{\sum (x_n-y_n)^2}$$ $$\frac{\partial c_1(\|x-y\|-(c_2-c_3))}{\partial x_n}=\frac{c_1}{\|x-y\|}\frac{\partial \sum (x_n-y_n)^2}{\partial x_n}=\frac{c_1}{\|x-y\|}(x_n-y_n)$$ ${c_1}/{\|x-y\|}$ on the right hand side should be the scale/d2 in the code. Update We have a couple of positive and negative pairs after computing the distance between each pair, we get a list of distances. The purpose of this loss is to let positive pairs have smaller distances (below some threshold) and negative pair to have larger distances (above some threshold). So it becomes rather similar to a binary classification problem (below some threshold is positive, above is negative). We can give the misclassified pairs a loss then that could be ||X1 - X2|| - dist_thresh . In such case, if all the positive distances are dist_thresh-0.0001 and all the negative distances are dist_thresh+0.0001 , there won't be any loss anymore but the distances between positive and negative pairs are still pretty close (differed by only 0.0002). To address this we can add a margin term to the loss, which turns out to be ||X1 - X2|| - (dist_thresh +/- margin) . The scale parameter is just the reciprocal of the number of pairs, so that multiplying it gives the average loss of the batch.
