[site]: datascience
[post_id]: 117891
[parent_id]: 
[tags]: 
layer.average not showing as expected in keras plot_model

My goal is to create a simple ensemble of three identical multi-output models (model0,model1,model2). Each model has two outputs named $a$ and $b$ . The final ensemble should that have two outputs, by averaging the corresponding outputs of the three models. $$ensemble.a = (model0.a + model1.a + model2.a)/3$$ $$ensemble.b = (model0.b + model1.b + model2.b)/3$$ A minimum working example of the code is the following. The function build_model creates a single model, and the function build_ensemble defines the ensemble. Suffixes are added to layer names to avoid the error " All layer names should be unique ". import tensorflow as tf def build_model(input_shape: tuple, suffix) -> tf.keras.Model: input_layer = tf.keras.layers.Input(input_shape, name='model_input'+suffix) model = tf.keras.Sequential([ tf.keras.layers.Dense(units=50, name='dense'+suffix), ], name='base_estimator') model = model(input_layer) model_a = tf.keras.layers.Dense(units=1, name='out_a'+suffix)(model) model_b = tf.keras.layers.Dense(units=1, name='out_b'+suffix)(model) model = tf.keras.Model(inputs=input_layer, outputs=[model_a, model_b], name='model_output'+suffix) return model def build_ensemble(input_shape: tuple) -> tf.keras.Model: input_layer = tf.keras.layers.Input(input_shape, name='ensemble_input') model1 = build_model(input_shape,suffix="_0") model2 = build_model(input_shape,suffix="_1") model3 = build_model(input_shape,suffix="_2") y1_a, y1_b = model1(input_layer) y2_a,y2_b = model2(input_layer) y3_a,y3_b = model3(input_layer) out_a = tf.keras.layers.average([y1_a, y2_a,y3_a],name="out_a") out_b = tf.keras.layers.average([y1_b, y2_b,y3_b],name="out_b") ensemble_model = tf.keras.Model(inputs=input_layer, outputs=[out_a,out_b],name='ensemble_output') return ensemble_model m = build_ensemble((20,)) tf.keras.utils.plot_model(m,"test.png",expand_nested=True) The problem is that the plot created by tf.keras.utils.plot_model is not the expected. Specifically, the plotted architecture uses only the second output from each model. In the following figure, I have crossed out wrong connections with red and have added with green the connections that should be there instead. So according, to the diagram, the computation of ensemble.a seems to be wrong (it uses $b$ instead of $a$ ): $$ensemble.a = (model0.b + model1.b + model2.b)/3$$ $$ensemble.b = (model0.b + model1.b + model2.b)/3$$ Question: Is there a mistake in my architecture that I should correct or is this a bug in the plotting library? More importantly, am I actually computing the desired output? Note: The ensembling approach using layers.average is explained in the official guide: https://www.tensorflow.org/guide/keras/functional
