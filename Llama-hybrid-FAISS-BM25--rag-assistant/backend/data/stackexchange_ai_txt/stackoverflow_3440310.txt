[site]: stackoverflow
[post_id]: 3440310
[parent_id]: 3439172
[tags]: 
Here is dynamic version Declare @currentYear int Declare @OlderThan5yrs datetime Set @currentYear = Year(GetDate()) - Case When month(GetDate()) UPDATED: Here is result with data I inserted in previous query (You will have to add # to table names in the query). pName purchaser_id 5+YrAgo 4YrAgo 3YrAgo 2YrAgo 1YrAgo CurYr Category -------------------- ------------ ------- ------ ------ ------ ------ ----- -------------------------- Non-purchaser 0 0 0 0 0 0 0 Non-purchaser (ever) New purchaser 1 0 0 0 0 0 1 New Reactivated 2 0 0 1 1 0 1 Reactivated Lapsed 3 0 0 0 1 1 0 Lapsed 2 yr Consecutive 4 0 0 0 0 1 1 2 yr Consecutive 3 yr consecutive 5 0 0 0 1 1 1 3-4 yr consecutive 4 yr consecutive 6 0 0 1 1 1 1 3-4 yr consecutive 5+ year consecutive 7 1 1 1 1 1 1 5+ year consecutive Uncategorized 8 0 0 1 0 0 0 non categorized old one 9 1 0 0 0 0 0 Non-purchaser (last 5 yrs) You also don't need columns [5+YrAgo], [4YrAgo], [3YrAgo], [2YrAgo], [1YrAgo] and [CurYr]. I added them to be easier to check query logic. UPDATE 2 Below is query you asked in comment. Note table structures I've used in query are: Table purchasers ( purchaser_id int, pName varchar(20)) Table purchases (purchases_purchaser_id int, date_purchased datetime) and there is Foreign key on purchases (purchases_purchaser_id) referencing purchases (purchaser_id). ;With AggData as ( Select purchases_purchaser_id, Case When [4]+[3]+[2]+[1]+[0] = 5 Then 1 end as [Consec5], Case When [4]=0 and [2]+[1]+[0] = 3 Then 1 end as [Consec34], Case When [2]=0 and [1]+[0] = 2 Then 1 end as [Consec2], Case When [1]=1 and [0]=0 Then 1 end as [Lapsed], Case When [2]=1 and [1]=0 and [0]=1 Then 1 end as [Reactivated], Case When [4]+[3]+[2]+[1]=0 and [0]=1 Then 1 end as [New], Case When [4]+[3]+[2]>0 and [1]+[0]=0 Then 1 end as [Uncateg] From ( Select purchases_purchaser_id, @currentYear - Year(date_purchased) + Case When month(date_purchased) = @OlderThan5yrs Group by purchases_purchaser_id, @currentYear - Year(date_purchased) + Case When month(date_purchased) Result (With test data from previous post) Consec5 Consec34 Consec2 Lapsed Reactivated New Non Uncateg ------- -------- ------- ------ ----------- --- --- ------- 1 2 1 1 1 1 2 1
