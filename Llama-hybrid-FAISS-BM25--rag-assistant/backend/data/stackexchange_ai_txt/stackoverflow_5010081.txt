[site]: stackoverflow
[post_id]: 5010081
[parent_id]: 4992419
[tags]: 
This is a supplementary answer to show the performance of the various options: Fill a sample table with some data create table tmp1 ([Data] int, [Mail] varchar(200)) insert tmp1 SELECT 1,'m1@gmail.com,m2@hotmail.com,other, longer@test, fifth' UNION ALL SELECT 2,'m2@hotmail.com,m3@test.com' UNION ALL SELECT 3,'m3@single.com' UNION ALL SELECT 4,'' UNION ALL SELECT 5,null insert tmp1 select data*10000 + number, mail from tmp1, master..spt_values v where v.type='P' -- total rows: 10245 Test query: set statistics io on set statistics time on dbcc dropcleanbuffers dbcc freeproccache select single, count(*) [Count] from ( select ltrim(rtrim(substring(t.mail, v.number+1, isnull(nullif(charindex(',',t.mail,v.number+1),0)-v.number-1,200)))) single from tmp1 t inner join master..spt_values v on v.type='p' and v.number 1 ) select Mail1 as Mail, count(*) as [Count] from cte2 group by Mail1 dbcc dropcleanbuffers dbcc freeproccache --SET ANSI_DEFAULTS ON --SET ANSI_NULLS ON ; SELECT address AS Mail, COUNT(*) AS [Count] FROM tmp1 CROSS APPLY (SELECT CAST(' ' + REPLACE([Mail], ',', ' ') + ' ' AS XML ) AS x) ca1 CROSS APPLY (SELECT T.split.value('.', 'varchar(200)') AS address FROM x.nodes('/m') T(split)) ca GROUP BY address Statistics Run a few time to get a feel for the averages Table 'Worktable'. Scan count 0, logical reads 0, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. Table 'spt_values'. Scan count 8196, logical reads 26637, physical reads 2, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. Table 'tmp1'. Scan count 3, logical reads 43, physical reads 0, read-ahead reads 14, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. Table 'Worktable'. Scan count 0, logical reads 0, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. SQL Server Execution Times: CPU time = 641 ms, elapsed time = 412 ms. Table 'Worktable'. Scan count 2, logical reads 103271, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. Table 'tmp1'. Scan count 1, logical reads 43, physical reads 0, read-ahead reads 14, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. SQL Server Execution Times: CPU time = 609 ms, elapsed time = 614 ms. Table 'Worktable'. Scan count 0, logical reads 0, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. Table 'tmp1'. Scan count 3, logical reads 43, physical reads 0, read-ahead reads 14, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. SQL Server Execution Times: CPU time = 2798 ms, elapsed time = 1421 ms. Table 'Worktable'. Scan count 2, logical reads 103334, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. Table 'tmp1'. Scan count 1, logical reads 43, physical reads 0, read-ahead reads 14, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. SQL Server Execution Times: CPU time = 734 ms, elapsed time = 742 ms. Summary First (CHARINDEX) : CPU time = 344 ms, elapsed time = 198 ms. Second (CTE) : CPU time = 594 ms, elapsed time = 613 ms. Third (XML) : CPU time = 2812 ms, elapsed time = 1418 ms. Fourth (CTE2) : CPU time = 719 ms, elapsed time = 750 ms.
