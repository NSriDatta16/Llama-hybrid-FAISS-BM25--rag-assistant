[site]: stackoverflow
[post_id]: 4851801
[parent_id]: 
[tags]: 
Creating a MSMQ programmatically using .NET

running on a Win 2008 R2 machine. as part of automating my application installation procedure, I have created a small command line utility that when invoked creates a MQ. since my deployment is in a workgroup environment, I am setting the created Queue permissions so that everyone and anonymous have full control over the queue. my code is this Try Dim Q As MessageQueue = MessageQueue.Create(QueueName) Console.WriteLine("Queue created successfully") ' Create an AccessControlList. Dim list As New AccessControlList() 'Add the AccessControlEntry to the AccessControlList. list.Add(New AccessControlEntry(New Trustee("Everyone"), GenericAccessRights.All, StandardAccessRights.All, AccessControlEntryType.Allow)) 'Add the AccessControlEntry to the AccessControlList. list.Add(New AccessControlEntry(New Trustee("ANONYMOUS LOGON"), GenericAccessRights.All, StandardAccessRights.All, AccessControlEntryType.Allow)) ' Apply the AccessControlList to the queue. Q.SetPermissions(list) Catch ex As Exception Console.WriteLine(String.Format("Unable to create queue {1}. {0}", ex, QueueName)) End Try when I run it with a queue name like ".\Private$\QueueName", the queue is created successfully and if I look on the queue permissions everything SEEMS to be OK (both everyone and anonymous have full access to the queue). the problem is that the permissions seem OK but they are not. when an anonymous user tries to send (or read) a message to the queue he gets an access denied error. if on the queue permissions I remove the everyone & anonymous permissions and re-create them then suddenly everything works as expected and the client can send messages. to further prove that there is some problem: if I look on the folder c:\Windows\Sysnative\msmq\storage\lqs\ on the contents of on of the queue setting files I see these permissions Security=010007806800000084000000000000001400000002005400030000000000140024001f100101000000000001000000000000140004001f10010100000000000507000000000024003f000f0001050000000000051500000097fd4a8271ec5457708be3d5f401000001050000000000051500000097fd4a8271ec5457708be3d5f401000001050000000000051500000097fd4a8271ec5457708be3d501020000 and after removing and re-creating the permissions I get these security settings: Security=01000780680000008400000000000000140000000200540003000000000024003f000f0001050000000000051500000097fd4a8271ec5457708be3d5f4010000000014003f000f00010100000000000507000000000014003f000f0001010000000000010000000001050000000000051500000097fd4a8271ec5457708be3d5f401000001050000000000051500000097fd4a8271ec5457708be3d501020000 on every queue created using the code above the security setting is like the first Security line before I re-create the setting and like the 2nd Security line after. what am I missing here? P.S you can read some analysis of this Security Token done by an ex-MSFT employee on a MS forum post i made on the subject http://social.msdn.microsoft.com/Forums/en-US/msmq/thread/2f87fe8a-c452-432a-815d-05eeaf455514/
