[site]: stackoverflow
[post_id]: 4881557
[parent_id]: 4880886
[tags]: 
OK, now it's totally safe. I swear! I would normally clone the formula variable but in this case since you're worried about a hostile user I cleaned the variable in place: class Evaluator def self.formula(formula, values) # remove anything but Q's, numbers, ()'s, decimal points, and basic math operators formula.gsub!(/((?![qQ0-9\s\.\-\+\*\/\(\)]).)*/,'').upcase! begin formula.gsub!(/Q\d+/) { |match| ( values[match.to_sym] && values[match.to_sym].class.ancestors.include?(Numeric) ? values[match.to_sym].to_s : '0' )+'.0' } instance_eval(formula) rescue Exception => e e.inspect end end end f = '(q1 + (q2 / 3) + q3 + (q4 * 2))' # some crazy formula for this survey values = {:Q2 => 1, :Q4 => 2} # values for substitution puts "formula: #{f} = #{Evaluator.formula(f,values)}" => formula: (0.0 + (1.0 / 3) + 0.0 + (2.0 * 2)) = 4.333333333333333 f = '(Q1 + (Q2 / 3) + Q3 + (Q4 * 2)) / 2' # some crazy formula for this survey values = {:Q1 => 1, :Q3 => 2} # values for substitution puts "formula: #{f} = #{Evaluator.formula(f,values)}" => formula: (1.0 + (0.0 / 3) + 2.0 + (0.0 * 2)) / 2 = 1.5 f = '(Q1 + (Q2 / 3) + Q3 + (Q4 * 2)) / 2' # some crazy formula for this survey values = {:Q1 => 'delete your hard drive', :Q3 => 2} # values for substitution puts "formula: #{f} = #{Evaluator.formula(f,values)}" => formula: (0.0 + (0.0 / 3) + 2.0 + (0.0 * 2)) / 2 = 1.0 f = 'system("ruby -v")' # some crazy formula for this survey values = {:Q1 => 'delete your hard drive', :Q3 => 2} # values for substitution puts "formula: #{f} = #{Evaluator.formula(f,values)}" => formula: ( -) = #
