[site]: stackoverflow
[post_id]: 5311874
[parent_id]: 
[tags]: 
why does adding the where statement to this sql make it run so much slower?

I have inherited a stored procedure and am having problems with it takes a very long time to run (around 3 minutes). I have played around with it, and without the where clause it actually only takes 12 seconds to run. None of the tables it references have a lot of data in them, can anybody see any reason why adding the main where clause below makes it take so much longer? ALTER Procedure [dbo].[MissingReadingsReport] @SiteID INT, @FormID INT, @StartDate Varchar(8), @EndDate Varchar(8) As If @EndDate > GetDate() Set @EndDate = Convert(Varchar(8), GetDate(), 112) Select Dt.FormID, DT.FormDAte, DT.Frequency, Dt.DayOfWeek, DT.NumberOfRecords, Dt.FormName, dt.OrgDesc, Dt.CDesc FROM (Select MeterForms.FormID, MeterForms.FormName, MeterForms.SiteID, MeterForms.Frequency, DateTable.FormDate, tblOrganisation.OrgDesc, CDesc = ( COMPANY.OrgDesc ), DayOfWeek = CASE Frequency WHEN 'Day' THEN DatePart(dw, DateTable.FormDate) WHEN 'WEEK' THEN DatePart(dw, MeterForms.FormDate) END, NumberOfRecords = CASE Frequency WHEN 'Day' THEN (Select TOP 1 RecordID FROM MeterReadings Where MeterReadings.FormDate = DateTable.FormDate And MeterReadings.FormID = MeterForms.FormID Order By RecordID DESC) WHEN 'WEEK' THEN (Select TOP 1 ( FormDate ) FROM MeterReadings Where MeterReadings.FormDate >= DateAdd(d , -4, DateTable.FormDate) And MeterReadings.FormDate = @StartDAte AND DateTable.FormDate 0)DT Where ( Frequency = 'Day' And dt.NumberofRecords IS NULL ) OR ( ( Frequency = 'Week' AND DayOfWeek = DATEPART (dw, Dt.FormDate) ) AND ( FormDate <> NumberOfRecords OR dt.NumberofRecords IS NULL ) ) Order By FormID
