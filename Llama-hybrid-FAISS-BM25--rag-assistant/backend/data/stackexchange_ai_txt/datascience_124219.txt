[site]: datascience
[post_id]: 124219
[parent_id]: 
[tags]: 
Custom Loss Function Returns Graph Execution Error: Can not squeeze dim[0], expected a dimension of 1, got 32

I have built a loss function which adds time and frequency weighted averages and variances to the MSE: def nuloss(y1, y2, FFT=True): S = tf.shape(y1) N = tf.cast(tf.reduce_prod(S), tf.float32) n = N / tf.cast(S[1], tf.float32) if FFT: hl = tf.cast(S[2] / 2, tf.int32) domain = tf.transpose(tf.concat([tf.tile(tf.expand_dims(time, 0), [hl, 1]), tf.tile(tf.expand_dims(freq, 0), [hl, 1])], axis=0)) else: domain = tf.transpose(tf.tile(tf.expand_dims(time, 0), [S[2], 1])) W = tf.cast(tf.reduce_sum(domain, axis=0), tf.float32) w = tf.cast(tf.reshape(domain, (1, S[1], S[2])), tf.float32) mse = tf.cast(tf.reduce_sum((y1 - y2)**2), tf.float32) / N wa1 = tf.reduce_sum(y1*w, axis=1) / W wa2 = tf.reduce_sum(y2*w, axis=1) / W wa = tf.reduce_sum(tf.abs(wa1 - wa2)) / n wv1 = tf.sqrt(tf.reduce_sum(((y1 - tf.reshape(wa1, (S[0], 1, S[2])))**2)*w, axis=1) / W) wv2 = tf.sqrt(tf.reduce_sum(((y2 - tf.reshape(wa2, (S[0], 1, S[2])))**2)*w, axis=1) / W) wv = tf.reduce_sum(tf.abs(wv1 - wv2)) / n return mse + wa + wv which I have passed to an LSTM model: def LSTM(inpdata, oupdata, NHLayer=7, LR=0.002, DR=0.2, DS=3): inpshape = np.shape(inpdata)[1:] oupshape = np.shape(oupdata)[1:] Input = keras.Input(shape=inpshape) Nnode = [int(round(o)) for o in np.linspace(inpshape[1], oupshape[1], NHLayer)] rnn = keras.layers.LSTM(inpshape[1], activation=tf.nn.elu, return_sequences=True)(Input) for o, n in enumerate(Nnode): rnn = keras.layers.LSTM(max([n, Nnode[0]]), activation=tf.nn.elu, return_sequences=True)(rnn) if DR > 0 and o % DS == 0 and o != NHLayer - 1: rnn = keras.layers.Dropout(rate=DR)(rnn) Output = keras.layers.Dense(oupshape[1], activation=keras.activations.linear)(rnn) model = keras.Model(inputs=Input, outputs=Output) optimizer = keras.optimizers.RMSprop(LR) model.compile(loss=nuloss, optimizer=optimizer, weighted_metrics=['mae']) return model When I use my custom loss function, it has no problem returning values. When I pass it to my neural network, I get the following error message: InvalidArgumentError Traceback (most recent call last) Cell In[35], line 1 ----> 1 modelfit = model.fit(hdata2a, sdata2a, validation_split=0.2, verbose=2, sample_weight=sample_weights_a, epochs=Epochs, callbacks=[early_stop, scheduler], use_multiprocessing=True) File ~/anaconda3/lib/python3.11/site-packages/keras/src/utils/traceback_utils.py:70, in filter_traceback. .error_handler(*args, **kwargs) 67 filtered_tb = _process_traceback_frames(e.__traceback__) 68 # To get the full stack trace, call: 69 # `tf.debugging.disable_traceback_filtering()` ---> 70 raise e.with_traceback(filtered_tb) from None 71 finally: 72 del filtered_tb File ~/anaconda3/lib/python3.11/site-packages/tensorflow/python/eager/execute.py:60, in quick_execute(op_name, num_outputs, inputs, attrs, ctx, name) 53 # Convert any objects of type core_types.Tensor to Tensor. 54 inputs = [ 55 tensor_conversion_registry.convert(t) 56 if isinstance(t, core_types.Tensor) 57 else t 58 for t in inputs 59 ] ---> 60 tensors = pywrap_tfe.TFE_Py_Execute(ctx._handle, device_name, op_name, 61 inputs, attrs, num_outputs) 62 except core._NotOkStatusException as e: 63 if name is not None: InvalidArgumentError: Graph execution error: Detected at node nuloss/weighted_loss/Squeeze defined at (most recent call last): File "/home/hgc-swin/anaconda3/bin/ipython3", line 11, in File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/IPython/__init__.py", line 128, in start_ipython File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/traitlets/config/application.py", line 992, in launch_instance File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/IPython/terminal/ipapp.py", line 318, in start File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/IPython/terminal/interactiveshell.py", line 888, in mainloop File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/IPython/terminal/interactiveshell.py", line 881, in interact File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/IPython/core/interactiveshell.py", line 3006, in run_cell File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/IPython/core/interactiveshell.py", line 3061, in _run_cell File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/IPython/core/async_helpers.py", line 129, in _pseudo_sync_runner File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/IPython/core/interactiveshell.py", line 3266, in run_cell_async File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/IPython/core/interactiveshell.py", line 3445, in run_ast_nodes File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/IPython/core/interactiveshell.py", line 3505, in run_code File " ", line 1, in File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/utils/traceback_utils.py", line 65, in error_handler File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/engine/training.py", line 1783, in fit File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/engine/training.py", line 1377, in train_function File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/engine/training.py", line 1360, in step_function File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/engine/training.py", line 1349, in run_step File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/engine/training.py", line 1127, in train_step File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/engine/training.py", line 1185, in compute_loss File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/engine/compile_utils.py", line 277, in __call__ File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/losses.py", line 161, in __call__ File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/utils/losses_utils.py", line 350, in compute_weighted_loss File "/home/hgc-swin/anaconda3/lib/python3.11/site-packages/keras/src/utils/losses_utils.py", line 224, in squeeze_or_expand_dimensions Can not squeeze dim[0], expected a dimension of 1, got 32 [[{{node nuloss/weighted_loss/Squeeze}}]] [Op:__inference_train_function_149960] So what gives? 32 is the default batch size, but I don't know where else that number would factor in here. So really I have no clue what is causing this error.
