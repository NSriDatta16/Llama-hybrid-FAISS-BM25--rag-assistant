[site]: stackoverflow
[post_id]: 5654830
[parent_id]: 
[tags]: 
SQL Server 2005 Transactional Replication Fails to Publish Stored Procedure Containing an Index Create

I've experienced a bizarre problem with a SQL Server 2005 Transactional Publication. The issue is this: If the publication contains an article that is a stored procedure that contains a create index statement, then there is an error thrown when attempting to replicate the schema of the stored procedure to a subscriber. The behavior is very odd, because even if the create index statement is commented out , it still gives the exception, and it will only work if it is removed altogether. Here is the exact error that's being returned: Command attempted: GRANT EXECUTE ON [dbo].[usp_Test] TO [CompanyDatabase_access] (Transaction sequence number: 0x00000170000008B9000500000000, Command ID: 5) Error messages: Cannot find the object 'usp_Test', because it does not exist or you do not have permission. (Source: MSSQLServer, Error number: 15151) Get help: http://help/15151 Cannot find the object 'usp_Test', because it does not exist or you do not have permission. (Source: MSSQLServer, Error number: 15151) Get help: http://help/15151 The error is accurate, because when I check on the subscriber, the stored procedure wasn't created as expected... but that was the purpose of the publication... Additionally, I can create the stored procedure manually on the subscriber, but when I generate a snapshot, it deletes the existing stored procedure and then still returns this error message. And here's a sample publication that creates this issue. The stored procedure: USE [CompanyDatabase] GO CREATE PROCEDURE [dbo].[usp_Test] AS CREATE TABLE #TempTable(ID INT) CREATE NONCLUSTERED INDEX [IX_TempTable] ON [dbo].[#TempTable](ID) SELECT 'Test' GO GRANT EXECUTE ON [dbo].[usp_Test] TO [CompanyDatabase_access] GO The publication script: -- Adding the transactional publication use [CompanyDatabase] exec sp_addpublication @publication = N'Replication Test', @description = N'Publication of database ''CompanyDatabase''.', @sync_method = N'concurrent', @retention = 0, @allow_push = N'true', @allow_pull = N'true', @allow_anonymous = N'false', @enabled_for_internet = N'false', @snapshot_in_defaultfolder = N'true', @compress_snapshot = N'false', @ftp_port = 21, @ftp_login = N'anonymous', @allow_subscription_copy = N'false', @add_to_active_directory = N'false', @repl_freq = N'continuous', @status = N'active', @independent_agent = N'true', @immediate_sync = N'false', @allow_sync_tran = N'false', @autogen_sync_procs = N'false', @allow_queued_tran = N'false', @allow_dts = N'false', @replicate_ddl = 1, @allow_initialize_from_backup = N'false', @enabled_for_p2p = N'false', @enabled_for_het_sub = N'false' GO -- Adding the transactional articles use [CompanyDatabase] exec sp_addarticle @publication = N'Replication Test', @article = N'usp_Test', @source_owner = N'dbo', @source_object = N'usp_Test', @type = N'proc schema only', @description = N'', @creation_script = N'', @pre_creation_cmd = N'drop', @schema_option = 0x0000000048000001, @destination_table = N'usp_Test', @destination_owner = N'dbo', @status = 16 GO -- Adding the transactional subscriptions use [CompanyDatabase] exec sp_addsubscription @publication = N'Replication Test', @subscriber = N'OtherDatabaseServer', @destination_db = N'CompanyDatabase', @subscription_type = N'Pull', @sync_type = N'automatic', @article = N'all', @update_mode = N'read only', @subscriber_type = 0 GO The subscription script: /****** Begin: Script to be run at Subscriber ******/ use [CompanyDatabase] exec sp_addpullsubscription @publisher = N'DatabaseServer', @publication = N'Replication Test', @publisher_db = N'CompanyDatabase', @independent_agent = N'True', @subscription_type = N'pull', @description = N'', @update_mode = N'read only', @immediate_sync = 0 exec sp_addpullsubscription_agent @publisher = N'DatabaseServer', @publisher_db = N'CompanyDatabase', @publication = N'Replication Test', @distributor = N'DatabaseServer', @distributor_security_mode = 1, @distributor_login = N'', @distributor_password = N'', @enabled_for_syncmgr = N'False', @frequency_type = 64, @frequency_interval = 0, @frequency_relative_interval = 0, @frequency_recurrence_factor = 0, @frequency_subday = 0, @frequency_subday_interval = 0, @active_start_time_of_day = 0, @active_end_time_of_day = 235959, @active_start_date = 0, @active_end_date = 0, @alt_snapshot_folder = N'', @working_directory = N'', @use_ftp = N'False', @job_login = null, @job_password = null, @publication_type = 0 GO /****** End: Script to be run at Subscriber ******/ Again, the odd thing is that the publication will still contain the same error if the create index statement is commented out, but it will work if it is removed altogether. For now, I've just removed all stored procedures that contain these create index statements from the publication, but I would like to have them replicated to the subscribers so that any DDL updates to the procedures will be automatically reflected on the subscribers. -- EDIT -- Looking in the snapshot directory, the .sch file for usp_Test contains the exact same code block I previously posted for the stored procedure... based on the error returned, it seems like the snapshot agent decides not to run the CREATE PROCEDURE command if it contains a create index, but then continues on and tries to run the GRANT EXECUTE command, which causes the error. Also, my exact version of SQL Server is: Microsoft SQL Server 2005 - 9.00.5254.00 (2005 + SP4 Cumulative Update 1) -- END EDIT -- My question is, why is this happening? Is there an issue with the configuration of my publication or subscription? As anyone else experienced anything like this? Where would I start in troubleshooting this issue? -- UPDATE -- I've been talking to Hilary Cotter on technet... and still no luck. If I remove the GRANT EXECUTE permission on the procedure, then it creates successfully with the CREATE INDEX. So it will work with GRANT EXECUTE OR CREATE INDEX, but not both. Hilary suggested that it might be some type of spam appliance in my domain that was preventing the snapshot from being transferred correctly when it contained both of those keywords, but if I manually copy the .sch file to the subscriber and validate that it contains the expected commands, I still get the same issue.
