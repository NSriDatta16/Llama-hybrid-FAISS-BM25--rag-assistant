[site]: stackoverflow
[post_id]: 5461471
[parent_id]: 
[tags]: 
PHP GD Image Cropping Function

I use this piece of code to make thumbnails of an uploaded image. $file = randString().'.jpg'; $uniPath = 'i/u'.$login; $completePath = $uniPath.'/a/'.$file; $thumbPath = $uniPath.'/b/'.$file; if(copy($_FILES['filename']['tmp_name'], $completePath)){ function convertPic($w_dst, $h_dst, $n_img){ $wxh = $w_dst.'x'.$h_dst; switch($wxh){ case '150x150': $letter = 'b'; break; case '50x50': $letter = 'c'; break; default: $letter = 'z'; } $dbPath = '/i/u1/'.$letter.'/'.$n_img; $new_img = $_SERVER['DOCUMENT_ROOT'].$dbPath; $file_src = "img.jpg"; // temporary safe image storage $img_src = $file_src; unlink($file_src); move_uploaded_file($_FILES['filename']['tmp_name'], $file_src); list($w_src, $h_src, $type) = getimagesize($file_src); // create new dimensions, keeping aspect ratio $ratio = $w_src/$h_src; $h_ratio = ($h_dst / $h_src); $w_ratio = ($w_dst / $w_src); if($w_src > $h_src){ //landscape $w_crop = round($w_src * $h_ratio); $h_crop = $h_dst; $src_x = ceil(($w_src - $h_src)/2); $src_y = 0; } elseif($w_src jpg $img_src = imagecreatefromgif($file_src); break; case 2: // jpeg -> jpg $img_src = imagecreatefromjpeg($file_src); break; case 3: // png -> jpg $img_src = imagecreatefrompng($file_src); break; } $img_dst = imagecreatetruecolor($w_dst, $h_dst); // resample imagecolorallocate($img_dst, 255, 255, 255) or die("fail imagecolorallocate"); imagecopyresampled($img_dst, $img_src, 0, 0, $src_x, $src_y, $w_crop, $h_crop, $w_src, $h_src) or die("imagecopyresampled($img_dst, $img_src, 0, 0, $src_x, $src_y, $w_crop, $h_crop, $w_src, $h_src)"); imagejpeg($img_dst, $new_img); // save new image unlink($file_src); // clean up image storage imagedestroy($img_src); imagedestroy($img_dst); return $db_path; } convertPic(150, 150, $file); convertPic(250, 250, $file); But for some reason the convertPic function does not work if called twice as in the example above. If it is called once everything works fine. I've put an alert if imagecopyresampled fails and it outputs imagecopyresampled(Resource id #17, img.jpg, 0, 0, 0, 0, 250, 250, , ) I think the problem is with the temporary image storing but not sure. Please help.
