[site]: crossvalidated
[post_id]: 608494
[parent_id]: 608427
[tags]: 
As hinted in @whuber's comment, the summation in your blue box is a weighted average with nonnegative weights summing to 1, and as such it must be less than or equal to the largest number averaged where the largest number is nothing but $\max\limits_a q_\pi(s,a)$ . To further clarify, each weight has the form $\frac{\pi(a|s)-\frac{\epsilon}{|\mathcal{A}(s)|}}{1-\epsilon}$ which is nonnegative since the $\epsilon$ -soft policy $\pi$ to be improved upon is $\epsilon$ -greedy (at least after first iteration in the book's algo), and also clearly $$\sum\limits_a \frac{\pi(a|s)-\frac{\epsilon}{|\mathcal{A}(s)|}}{1-\epsilon}=1$$ since the number of summation terms are just $|\mathcal{A}(s)|$ . And since each such weight is nonnegative, it's obvious and easily provable that $$\max\limits_a q_\pi(s,a)=\sum\limits_a \frac{\pi(a|s)-\frac{\epsilon}{|\mathcal{A}(s)|}}{1-\epsilon}\max\limits_a q_\pi(s,a).$$ Now I believe you can make sense of the blue box line. Why it has this form? Itâ€™s so contrived that one can compare with the previous value function to show improvement for a generic state $s$ in the state space.
