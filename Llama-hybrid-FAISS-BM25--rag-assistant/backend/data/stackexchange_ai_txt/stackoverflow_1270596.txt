[site]: stackoverflow
[post_id]: 1270596
[parent_id]: 1242958
[tags]: 
I was doing it wrong. By using request it was calling to_s on all paramaters, so my mock object was being passed as "#[Spec::Mocks::Mock:0x3fda2a4736c0 @name=\"file\"]". That will teach me to pay more attention to exception output. Instead I should use multipart_post and stub out the authentication calls in a block. it "should allow authenticated file uploads" do file = File.open(a_valid_file) multipart_post( resource(:assets), :method => "POST", :params => { :file => file } ) do |controller| controller.stub!(:ensure_authenticated).and_return(true) controller.session.stub!(:user).and_return(User.first) ) end
