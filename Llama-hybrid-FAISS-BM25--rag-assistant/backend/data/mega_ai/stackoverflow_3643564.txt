[site]: stackoverflow
[post_id]: 3643564
[parent_id]: 
[tags]: 
Strange problem with session.invalidate()

I have strange issue with logging in and out. I've implemented container-based security. I have Login/Logout links on all my pages (through template.xhtml ) that are rendered or not based on backing bean boolean property (it's actually method isLoggedIn() ). Also in backing bean I have method logout which is the action for Logout link (it's h:commandLink ). Logout method returns String that redirects to login page through implicit JSF 2.0 navigation. Now when I deploy application I browse to my page it displays index.xhtml . From there I go to login page. I put my username/password click Login and it logs me in. But now I click Logout which calls backing bean logout method mentioned, which called does this: public String logout() { HttpSession session = (HttpSession) FacesContext.getCurrentInstance().getExternalContext().getSession(false); //HttpServletRequest request = (HttpServletRequest) FacesContext.getCurrentInstance().getExternalContext().getRequest(); try { session.invalidate(); //request.logout(); } catch (Exception ex) { Logger.getLogger(PostController.class.getName()).log(Level.SEVERE, null, ex); } return "/ssl/login?faces-redirect=true"; } Now after clicking Logout it redirects me back to login page when I again put username/password and click Login. But then strange thing happens because it displays me my index.xhtml but I'm not logged in. I have to go again to login page, retype credentials once again to finally be logged in. This happens only when I use session.invalidate() in backing bean logout() method. When I use request.logout() everything works fine. What's the problem? Edited: isLoggedIn looks like this but I don't think it's a problem cause I created filter that redirects me (only when I'm logged in) to index.xhtml when I try to browse to login page. And it doesn't happen. public boolean isLoggedIn() { HttpServletRequest request = (HttpServletRequest) FacesContext.getCurrentInstance().getExternalContext().getRequest(); if(request.getUserPrincipal() != null) return true; else return false; } Edited: Here is scenario considering http headers: I request login.xhtml: GET /blog-war/ssl/login.xhtml;jsessionid=edccb9f9a1c5fc77dbd7fc86f55b HTTP/1.1 Host: localhost:8080 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Referer: http://localhost:8080/blog-war/ Cookie: JSESSIONID=edccb9f9a1c5fc77dbd7fc86f55b Response: HTTP/1.1 302 Moved Temporarily X-Powered-By: Servlet/3.0 Server: GlassFish Server Open Source Edition 3.0.1 Location: https://localhost:8181/blog-war/ssl/login.xhtml Content-Type: text/html;charset=ISO-8859-1 Content-Language: en-GB Content-Length: 197 Date: Sat, 04 Sep 2010 22:27:47 GMT Moved temporarily so browser makes another request: GET /blog-war/ssl/login.xhtml HTTP/1.1 Host: localhost:8181 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Referer: http://localhost:8080/blog-war/ Cookie: JSESSIONID=edccb9f9a1c5fc77dbd7fc86f55b Response: HTTP/1.1 200 OK X-Powered-By: Servlet/3.0, JSF/2.0 Server: GlassFish Server Open Source Edition 3.0.1 Cache-Control: no-cache, no-store, must-revalidate Pragma: no-cache Expires: Thu, 01 Jan 1970 00:00:00 GMT Content-Type: text/html;charset=UTF-8 Content-Length: 1256 Date: Sat, 04 Sep 2010 22:27:47 GMT I fill in username/password and click Login: POST /blog-war/ssl/j_security_check HTTP/1.1 Host: localhost:8181 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Referer: https://localhost:8181/blog-war/ssl/login.xhtml Cookie: JSESSIONID=edccb9f9a1c5fc77dbd7fc86f55b Response: HTTP/1.1 302 Moved Temporarily X-Powered-By: Servlet/3.0 Server: GlassFish Server Open Source Edition 3.0.1 Location: https://localhost:8181/blog-war/ Content-Type: text/html;charset=ISO-8859-1 Content-Language: en-GB Content-Length: 182 Date: Sat, 04 Sep 2010 22:40:01 GMT It was redirect to index.xhtml: GET /blog-war/ HTTP/1.1 Host: localhost:8181 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Referer: https://localhost:8181/blog-war/ssl/login.xhtml Cookie: JSESSIONID=edccb9f9a1c5fc77dbd7fc86f55b Response: HTTP/1.1 302 Moved Temporarily X-Powered-By: Servlet/3.0 Server: GlassFish Server Open Source Edition 3.0.1 Pragma: No-cache Cache-Control: no-cache Expires: Thu, 01 Jan 1970 01:00:00 CET Location: http://localhost:8080/blog-war/ Content-Type: text/html;charset=ISO-8859-1 Content-Language: en-GB Content-Length: 181 Date: Sat, 04 Sep 2010 22:40:01 GMT Again redirect because I have filter that switch to https-http and vice versa (I wanted only login.xhtml in https): GET /blog-war/ HTTP/1.1 Host: localhost:8080 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Cookie: JSESSIONID=edccb9f9a1c5fc77dbd7fc86f55b Response: HTTP/1.1 200 OK X-Powered-By: Servlet/3.0, JSF/2.0 Server: GlassFish Server Open Source Edition 3.0.1 Pragma: no-cache Cache-Control: no-cache, no-store, must-revalidate Expires: Thu, 01 Jan 1970 00:00:00 GMT Content-Type: text/html;charset=UTF-8 Content-Length: 4002 Date: Sat, 04 Sep 2010 22:40:02 GMT Now I'm logged in sucessfully, Logout link is rendered means backing bean isLoggedIn returns true. Now I click Logout which invokes session.invalidate() in logout() method in backing bean: POST /blog-war/index.xhtml HTTP/1.1 Host: localhost:8080 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Referer: http://localhost:8080/blog-war/ Cookie: JSESSIONID=edccb9f9a1c5fc77dbd7fc86f55b Response: HTTP/1.1 302 Moved Temporarily X-Powered-By: Servlet/3.0, JSF/2.0 Server: GlassFish Server Open Source Edition 3.0.1 Cache-Control: no-cache, no-store, must-revalidate Pragma: no-cache Expires: Thu, 01 Jan 1970 00:00:00 GMT Location: http://localhost:8080/blog-war/ssl/login.xhtml Content-Type: text/html;charset=ISO-8859-1 Content-Language: en-GB Content-Length: 196 Date: Sat, 04 Sep 2010 22:48:34 GMT Redirect to login page logout returns String "/ssl/login?faces-redirect=true" so we go there: GET /blog-war/ssl/login.xhtml HTTP/1.1 Host: localhost:8080 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Referer: http://localhost:8080/blog-war/ Cookie: JSESSIONID=edccb9f9a1c5fc77dbd7fc86f55b Response: HTTP/1.1 302 Moved Temporarily X-Powered-By: Servlet/3.0 Server: GlassFish Server Open Source Edition 3.0.1 Location: https://localhost:8181/blog-war/ssl/login.xhtml Content-Type: text/html;charset=ISO-8859-1 Content-Language: en-GB Content-Length: 197 Date: Sat, 04 Sep 2010 22:48:34 GMT Another redirect, login page should be in https (filter is working :)): GET /blog-war/ssl/login.xhtml HTTP/1.1 Host: localhost:8181 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Referer: http://localhost:8080/blog-war/ Cookie: JSESSIONID=edccb9f9a1c5fc77dbd7fc86f55b Response: HTTP/1.1 200 OK X-Powered-By: Servlet/3.0, JSF/2.0 Server: GlassFish Server Open Source Edition 3.0.1 Cache-Control: no-cache, no-store, must-revalidate Pragma: no-cache Expires: Thu, 01 Jan 1970 00:00:00 GMT Set-Cookie: JSESSIONID=eefdcda45337b9c897de2a0e95e3; Path=/blog-war; Secure Content-Type: text/html;charset=UTF-8 Content-Length: 1256 Date: Sat, 04 Sep 2010 22:48:35 GMT So this was normal flow of events. Now abnormal:) I'm already at login page so I retype username/password and click Login: POST /blog-war/ssl/j_security_check HTTP/1.1 Host: localhost:8181 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Referer: https://localhost:8181/blog-war/ssl/login.xhtml Cookie: JSESSIONID=eefdcda45337b9c897de2a0e95e3 Response: HTTP/1.1 302 Moved Temporarily X-Powered-By: Servlet/3.0 Server: GlassFish Server Open Source Edition 3.0.1 Location: https://localhost:8181/blog-war/ Content-Type: text/html;charset=ISO-8859-1 Content-Language: en-GB Content-Length: 182 Date: Sat, 04 Sep 2010 22:55:46 GMT Redirect to index: GET /blog-war/ HTTP/1.1 Host: localhost:8181 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Referer: https://localhost:8181/blog-war/ssl/login.xhtml Cookie: JSESSIONID=eefdcda45337b9c897de2a0e95e3 Response: HTTP/1.1 302 Moved Temporarily X-Powered-By: Servlet/3.0 Server: GlassFish Server Open Source Edition 3.0.1 Pragma: No-cache Cache-Control: no-cache Expires: Thu, 01 Jan 1970 01:00:00 CET Location: http://localhost:8080/blog-war/ Content-Type: text/html;charset=ISO-8859-1 Content-Language: en-GB Content-Length: 181 Date: Sat, 04 Sep 2010 22:55:47 GMT Again filter redirects to http for index.xhtml: GET /blog-war/ HTTP/1.1 Host: localhost:8080 User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; pl; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: pl,en-us;q=0.7,en;q=0.3 Accept-Encoding: gzip,deflate Accept-Charset: ISO-8859-2,utf-8;q=0.7,*;q=0.7 Keep-Alive: 115 Connection: keep-alive Response: HTTP/1.1 200 OK X-Powered-By: Servlet/3.0, JSF/2.0 Server: GlassFish Server Open Source Edition 3.0.1 Cache-Control: no-cache, no-store, must-revalidate Pragma: no-cache Expires: Thu, 01 Jan 1970 00:00:00 GMT Set-Cookie: JSESSIONID=ef675cbb9747063c235fdb44137e; Path=/blog-war Content-Type: text/html;charset=UTF-8 Content-Length: 3410 Date: Sat, 04 Sep 2010 22:55:48 GMT At this point Logout link is not rendered, means we are not logged in? In response there is set-cookie so does it mean server logged me out? After going again to login page it starts all over from the top. I can also insert server logs which differs a little bit from normal login and abnormal login scenario. Also about Expires in response, why it's January 1970? I'm really confused.
