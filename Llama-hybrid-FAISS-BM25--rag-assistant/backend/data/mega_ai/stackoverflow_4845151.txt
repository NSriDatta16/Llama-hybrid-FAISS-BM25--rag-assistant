[site]: stackoverflow
[post_id]: 4845151
[parent_id]: 
[tags]: 
CometProcessor End Event loop

I have a simple servlet which uses CometProcessor interface. package cc.co.sqeezer; import java.io.IOException; public class TestServlet extends HttpServlet implements CometProcessor { private static final long serialVersionUID = 1L; public TestServlet() { super(); } public void event(CometEvent event) { if (event.getEventType() == CometEvent.EventType.BEGIN) { System.out.println("Begin"); event.getHttpServletRequest().setAttribute("org.apache.tomcat.comet.timeout", new Integer(0xFFFFFFFF)); send(event); } else if (event.getEventType() == CometEvent.EventType.READ) { System.out.println("Read"); send(event); } else if (event.getEventType() == CometEvent.EventType.END) { System.out.println("End: " + event.getEventSubType()); send(event); } else if (event.getEventType() == CometEvent.EventType.ERROR) { System.out.println("Error: " + event.getEventSubType()); send(event); } } private void send(CometEvent event) { HttpServletResponse response = event.getHttpServletResponse(); response.setHeader("Pragma", "no-cache"); response.setHeader("Cache-Control", "must-revalidate"); response.setHeader("Cache-Control", "no-cache"); response.setHeader("Cache-Control", "no-store"); response.setDateHeader("Expires", 0); String eventType = event.getEventType().toString(); String receivedText = (String) event.getHttpServletRequest().getParameter("mytext"); try { response.getWriter().write(eventType + " " + receivedText); response.getWriter().flush(); } catch (IOException e) { e.printStackTrace(); } } public void init(ServletConfig config) throws ServletException { } } Connector is Jsp page is Test I'm using Eclipse to start the servlet. What I would expect is to send "text" to the server and get back the echo with the same text and CometEvent name. When I'm sending the data to the server the first I get "200 ReadyState=3 BEGIN text". This is expected scenario. If I wait for about 25 seconds I will get "Error: TIMEOUT" in console output. And error event will be fired every 25 seconds, so in browser I see something like "200 ReadyState=3 BEGIN textERROR textERROR textERROR textERROR textERROR text", where the "text" is the text in input. 5 textERRORs means that 5 error events occured. I don't know why these textERRORs appeared. And the main question is why the error event (timeout) fired every 25 seconds? If I close client in browser I will get an infinite loop of End Events. Why this happens I don't know either? How to prevent that kind of loop? Tomcat version is Apache Tomcat/6.0.28 on Ubuntu 10.10 Thank you in advance.
