[site]: crossvalidated
[post_id]: 433957
[parent_id]: 433908
[tags]: 
Based on your causal diagram, it appears that "selection variables" refers to confounders , not factors related to selection into the sample. This distinction is important because the items included in the different inverse probability weights is important. Briefly, to answer your question, I would not use any of the approaches you listed. The analysis and construction of the weights depends on the question you are ultimately interested in. Before proceeding, let me define some notation; $Y$ is the outcome, $A$ is the treatment, $W$ is the "selection" variables / confounders, and $M$ is the mediator. 1) What is the average causal effect of treatment plans on the outcome? For this question, we don't adjust for the mediator since the effect of $A$ is partially through $M$ . Since we are interested in the total effect of $A$ on $Y$ , $M$ will not appear in our model. The IPTW would be calculated as $$\frac{1}{\Pr(A=a|W)}$$ These probabilities can be calculated using a multinomial logistic regression model. Note that the denominator is defined by the probability that person $i$ was actually observed under . So if $A_i = 2$ , the their IPTW should be $\frac{1}{\Pr(A=2|W)}$ . We can also calculate stabilized IPTW, which only have a slightly different numerator. $$\frac{\Pr(A=a)}{\Pr(A=a|W)}$$ A heuristic way to think about the problem is that IPTW allow us to "erase" arrows. This specification of IPTW "erases" the $L$ to $A$ arrow. After that arrow is removed, there is no longer any backdoor paths between $A$ and $Y$ . Therefore, we don't need to account for $M$ (in fact if we include $M$ in the models, we begin "erasing" other arrows that no longer identify the effect we may want). After the calculation of all the weights, we can estimate the marginal structural model (what I believe you refer to as the outcome model). $$Y = \beta_0 + \beta_1 I(A=1) + \beta_2 I(A=2) + \beta_3 I(A=3)$$ The $\beta$ 's will correspond to the average causal effect, where everyone was given $A=a$ compared to $A=0$ for $a={1, 2, 3}$ (be sure to use a robust variance estimator for standard errors). 2) What is the controlled direct effect of the treatment plan on the outcome? The controlled direct effect corresponds to the change in $Y$ if $M$ had uniformly set to the same level in the population and $A$ were compared. There is also the natural direct and indirect effects ( VanderWeele 2009 ), but these require some strong assumptions to identify ( Naimi 2014 ). I am more familiar with the controlled direct effect, so I will focus on that (but the estimation procedures are the same). For this scenario, we need to construct two sets of inverse probability weights. First, we calculate IPTW like we previously did. $$\frac{\Pr(A=a)}{\Pr(A=a|W)}$$ Next, we need to account for confounders (e.g. common causes) of the $M$ and $Y$ relationship. To do this, we construct a second set of weights. I will only present the stabilized version $$\frac{\Pr(M=m|A=a)}{\Pr(M=m|A=a, W)}$$ This denominator assumes that there are no other common causes of $M$ and $Y$ besides $W$ (which may not be true in your setting). After these weights are calculated, they are combine together via multiplication. Afterwards, we can estimate our marginal structural model $$Y = \beta_0 + \beta_1 I(A=1) + \beta_2 I(A=2) + \beta_3 I(A=3) + \mathbf{\beta M}$$ Note that the $\mathbf{M}$ is a vector of your $M$ 's. Ideally, you would include interaction terms for every $A$ and $M$ combination in this model but you may not have enough data. In conclusion, remember this is estimating a different quantity (which you may or may not want). If you are interested in this approach, I've found Zhu et al. 2016 to be a good example of application. Summary Depending on the quantity of interest, the inverse probability weights will be different. If we want to compare the scenarios where everyone is given treatment $A=a$ to the control (i.e., $E[Y|A=a] - E[Y|A=0]$ ), we would use the first set of weights that ignore any mediators. If we want to know what the controlled direct effect is (e.g., $E[Y|A=a, M=m] - E[Y|A=0, M=m]$ ), then we would use the second procedure.
