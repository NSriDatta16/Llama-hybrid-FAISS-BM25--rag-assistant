[site]: stackoverflow
[post_id]: 5407273
[parent_id]: 
[tags]: 
Window moving average in sql server

I am trying to create a function that computes a windowed moving average in SQLServer 2008 . I am quite new to SQL so I am having a fair bit of difficulty. The data that I am trying to perform the moving average on needs to be grouped by day (it is all timestamped data) and then a variable moving average window needs to be applied to it. I already have a function that groups the data by day (and @id) which is shown at the bottom. I have a few questions: Would it be better to call the grouping function inside the moving average function or should I do it all at once? Is it possible to get the moving average for the dates input into the function, but go back n days to begin the moving average so that the first n days of the returned data will not have 0 for their average? (ie. if they want a 7 day moving average from 01-08-2011 to 02-08-2011 that I start the moving average calculation on 01-01-2011 so that the first day they defined has a value?) I am in the process of looking into how to do the moving average, and know that a moving window seems to be the best option (currentSum = prevSum + todayCount - nthDayAgoCount) / nDays but I am still working on figuring out the SQL implementation of this. I have a grouping function that looks like this (some variables removed for visibility purposes): SELECT 'ALL' as GeogType, CAST(v.AdmissionOn as date) as dtAdmission, CASE WHEN @id IS NULL THEN 99 ELSE v.ID END, COUNT(*) as nVisits FROM dbo.Table1 v INNER JOIN dbo.Table2 t ON v.FSLDU = t.FSLDU5 WHERE v.AdmissionOn >= '01-01-2010' AND v.AdmissionOn Which returns a table like so: ALL 2010-01-01 1 103 ALL 2010-01-02 1 114 ALL 2010-01-03 1 86 ALL 2010-01-04 1 88 ALL 2010-01-05 1 84 ALL 2010-01-06 1 87 ALL 2010-01-07 1 82 EDIT: To answer the first question I asked: I ended up creating a function which declared a temporary table and inserted the results from the count function into it, then used the example from user662852 to compute the moving average.
