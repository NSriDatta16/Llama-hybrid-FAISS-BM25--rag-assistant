[site]: stackoverflow
[post_id]: 987839
[parent_id]: 984477
[tags]: 
Haven't realized you may have multiple persons in the document. My query would be incorrect in that case anyway. I thought maybe if you first shred out each person into its own XML fragment and ten extract the enter/leave times might perform better. I don't have 215k person XML to try, but here is an idea: declare @x xml; select @x = N' HH3269732 John Smith 01/02/2008 10:15 01/02/2008 11:45 03/01/2008 08:00 03/01/2008 10:00 04/01/2008 08:00 HH3269733 Jane Doe 01/03/2008 10:15 01/03/2008 11:45 03/04/2008 08:00 03/04/2008 10:00 04/04/2008 08:00 '; with cte_person as ( select t.c.value('(personid)[1]', 'NVARCHAR(50)') as personid , t.c.value('(firstname)[1]', 'NVARCHAR(50)') as firstname , t.c.value('(lastname)[1]', 'NVARCHAR(50)') as lastname , t.c.query('entertime') as entertime , t.c.query('leavetime') as leavetime FROM @x.nodes('root/person') t(c)) , cte_cross_enter as ( select p.personid , p.firstname , p.lastname , x.c.value('.', 'datetime') as entertime , row_number() over (partition by personid order by x.c) as row_enter from cte_person p cross apply p.entertime.nodes('/entertime') x(c)) , cte_cross_leave as ( select p.personid , x.c.value('.', 'datetime') as leavetime , row_number() over (partition by personid order by x.c) as row_leave from cte_person p cross apply p.leavetime.nodes('/leavetime') x(c)) select e.personid , e.firstname , e.lastname , e.entertime , l.leavetime from cte_cross_enter e left outer join cte_cross_leave l on e.personid = l.personid and e.row_enter = l.row_leave
