[site]: datascience
[post_id]: 63976
[parent_id]: 
[tags]: 
How to estimate total correlation KL[q(z)||Πjq(zj)] of VAE after training (useful for latents disentanglement evaluation)

FactorVAE and β-TCVAE both use total correlation (TC) batch estimation for their objectives. Where TC is: $$ KL\bigl( q(z)||\prod\nolimits_{j} q(z_{j})\bigr) $$ both estimates are applied to $q(z|x)$ of the encoder during training. Where $z∼q(z|x)$ is sampled from diagonal Gaussian with $μ(x)$ and $σ(x)$ given by encoder. FactorVAE TC estimate is hard to train and I failed to converge it for my dataset. β-TCVAE converges and gives meaningful latents if we consider $μ(x)$ only. But it has such high $σ(x)$ that $z∼q(z|x)$ becomes meaningless (I need disentangled latents to contain info about some polar cases of data - the info is contained in $μ(x)$ but is lost when sampling $z∼q(z|x)$ - I checked the info presence by training a simple NN classifier). I have not idea how to fix it so I simply want to separately estimate TC of the $q(μ)$ using the whole train dataset (if it's good then it's OK for my needs). FactorVAE paper mentions a straghtforward way of TC estimation in appendix D: $$ KL\bigl( q(z)||\prod\nolimits_{j} q(z_{j})\bigr) = _{q(z)} \left[{{\mathrm{log}} \frac{q(z)}{\prod_{j}q(z_{j})}}\right] ≈ _{q(z)} \left[{{\mathrm{log}} \frac{\hat{q}(z)}{{\prod_{j} \hat{q}(z_{j})}}}\right]\\ ≈ \frac{1}{H} \sum_{h=1}^H \left[{{\mathrm{log}} \frac{1}{|{\mathcal{B}}|} \sum_{i∈{\mathcal{B}}}\prod_{j=1}^D q(z_{j}^{(h)}|x^{(i)}) - {\mathrm{log}} \prod_{j=1}^D \frac{1}{|{\mathcal{B}}|} \sum_{i∈{\mathcal{B}}} q(z_{j}^{(h)}|x^{(i)})}\right] $$ where $z^{(h)} \overset{{iid}}{∼} q(z)$ and $q(z) ≈ \hat{q}(z) = \frac{1}{|{\mathcal{B}}|} \prod\nolimits_{i∈{\mathcal{B}}} q(z|x^{(i)})$ . But first : I cannot sample $H$ samples as I want to estimate TC of $q(μ)$ and hence I can only use deterministic mapping $μ(x)$ . And second they also say that: From Figure 18, we can see that even with B as big as 10,000, we get negative values for the estimate of TC, which is a KL divergence and hence should be non-negative, hence this method of using a batch estimate for $q(z)$ does not work. I only have ~10000 samples in my database so I might end implementing it and having negative KLD too (if I go with $H=1$ ). Hence my question : what is the best way to estimate TC of some database samples (as I want to estimate $μ(x)$ that is a deterministic function of the database). Is it even possible? Are there better ways than mentioned above? What can you say about failure of the estimation method from FactorVAE paper?
