[site]: stackoverflow
[post_id]: 1498994
[parent_id]: 
[tags]: 
free memory not clears the memory block

I am using DllImport to call method in c wrapper library from my own .net class. This method in c dll creates a string variable and returns the pointer of the string. Something like this; _declspec(dllexport) int ReturnString() { char* retval = (char *) malloc(125); strcat(retval, "SOMETEXT"); strcat(retval, "SOMETEXT MORE"); return (int)retval; } Then i read the string using Marshall.PtrToStringAnsi(ptr). After i get a copy of the string, i simply call another c method HeapDestroy which is in c wrapper library that calls free(ptr). Here is the question; Recently while it is working like a charm, I started to get "Attempted to read or write protected memory area" exception. After a deeper analysis, i figured out, i beleive, although i call free method for this pointer, value of the pointer is not cleared, and this fills the heap unattended and makes my iis worker process to throw this exception. By the way, it is an web site project that calls this method in c library. Would you kindly help me out on this issue? Sure, here is C# code; [DllImport("MyCWrapper.dll", CharSet = CharSet.Ansi, CallingConvention = CallingConvention.Cdecl)] private extern static int ReturnString(); [DllImport("MyCWrapper.dll", CharSet = CharSet.Ansi, CallingConvention = CallingConvention.Cdecl)] private extern static void HeapDestroy(int ptr); public static string GetString() { try { int i = ReturnString(); string result = String.Empty; if (i > 0) { IntPtr ptr = new IntPtr(i); result = Marshal.PtrToStringAnsi(ptr); HeapDestroy(i); } return result; } catch (Exception e) { return String.Empty; } }
