[site]: stackoverflow
[post_id]: 2819195
[parent_id]: 2810284
[tags]: 
To get it working I had to change the code based on the code found here (thanks umeshb for sharing it!) The code I'm using right now (working on XP) is: (feel free to optimize it) Public Class PrinterSettingsHelper #Region "Private Variables" Private gPrinter As IntPtr = New System.IntPtr() Private gPrinterValues As PRINTER_DEFAULTS = New PRINTER_DEFAULTS() Private gPInfo As PRINTER_INFO_2 = New PRINTER_INFO_2() Private gDevMode As DEVMODE Private gPtrDevMode As IntPtr Private gPtrPrinterInfo As IntPtr Private gSizeOfDevMode As Integer = 0 Private gLastError As Integer Private gNBytesNeeded As Integer Private gNRet As Long Private gIntError As Integer Private gNTemporary As Int32 Private gDevModeData As IntPtr #End Region #Region "Data structure" _ Public Structure PRINTER_DEFAULTS Public pDatatype As Integer Public pDevMode As Integer Public DesiredAccess As Integer End Structure _ Private Structure PRINTER_INFO_2 Public pServerName As String Public pPrinterName As String Public pShareName As String Public pPortName As String Public pDriverName As String Public pComment As String Public pLocation As String Public pDevMode As IntPtr Public pSepFile As String Public pPrintProcessor As String Public pDatatype As String Public pParameters As String Public pSecurityDescriptor As IntPtr Public Attributes As Int32 Public Priority As Int32 Public DefaultPriority As Int32 Public StartTime As Int32 Public UntilTime As Int32 Public Status As Int32 Public cJobs As Int32 Public AveragePPM As Int32 End Structure Private Const CCDEVICENAME As Short = 32 Private Const CCFORMNAME As Short = 32 _ Public Structure DEVMODE _ Public dmDeviceName As String Public dmSpecVersion As Short Public dmDriverVersion As Short Public dmSize As Short Public dmDriverExtra As Short Public dmFields As Integer Public dmOrientation As Short Public dmPaperSize As Short Public dmPaperLength As Short Public dmPaperWidth As Short Public dmScale As Short Public dmCopies As Short Public dmDefaultSource As Short Public dmPrintQuality As Short Public dmColor As Short Public dmDuplex As Short Public dmYResolution As Short Public dmTTOption As Short Public dmCollate As Short _ Public dmFormName As String Public dmUnusedPadding As Short Public dmBitsPerPel As Short Public dmPelsWidth As Integer Public dmPelsHeight As Integer Public dmDisplayFlags As Integer Public dmDisplayFrequency As Integer End Structure #End Region #Region "Win API Def" _ Private Shared Function GetLastError() As Int32 End Function _ Private Shared Function ClosePrinter(ByVal hPrinter As IntPtr) As Boolean End Function _ Private Shared Function DocumentProperties(ByVal hwnd As IntPtr, ByVal hPrinter As IntPtr, _ ByVal pDeviceNameg As String, _ ByVal pDevModeOutput As IntPtr, ByRef pDevModeInput As IntPtr, ByVal fMode As Integer) As Integer End Function _ Private Shared Function GetPrinter(ByVal hPrinter As IntPtr, ByVal dwLevel As Int32, _ ByVal pPrinter As IntPtr, ByVal dwBuf As Int32, ByRef dwNeeded As Int32) As Boolean End Function _ Private Shared Function OpenPrinter( ByVal szPrinter As String, _ ByRef hPrinter As IntPtr, ByRef pd As PRINTER_DEFAULTS) As Boolean End Function _ Private Shared Function SetPrinter(ByVal hPrinter As IntPtr, ByVal Level As Integer, _ ByVal pPrinter As IntPtr, ByVal Command As Integer) As Boolean End Function #End Region #Region "Constants" Private Const DM_DUPLEX As Integer = 4096 '0x1000 Private Const DM_IN_BUFFER As Integer = 8 Private Const DM_OUT_BUFFER As Integer = 2 Private Const PRINTER_ACCESS_ADMINISTER As Integer = 4 '0x4 Private Const STANDARD_RIGHTS_REQUIRED As Integer = 983040 '0xF0000 Private Const PRINTER_ALL_ACCESS As Integer = STANDARD_RIGHTS_REQUIRED Or PRINTER_ACCESS_ADMINISTER Or PRINTER_ACCESS_USE Private Const PRINTER_ACCESS_USE As Integer = 8 '0x8 #End Region #Region "Function to change printer settings" Public Function ChangePrinterSetting(ByVal iPrinterName As String) As Boolean gDevMode = Me.GetPrinterSettings(iPrinterName) Marshal.StructureToPtr(gDevMode, gDevModeData, True) gPInfo.pDevMode = gDevModeData gPInfo.pSecurityDescriptor = IntPtr.Zero 'bring up the printer preferences dialog DocumentProperties(IntPtr.Zero, gPrinter, iPrinterName, gDevModeData _ , gPInfo.pDevMode, DM_IN_BUFFER Or DM_OUT_BUFFER Or PRINTER_ACCESS_ADMINISTER) 'update driver dependent part of the DEVMODE Marshal.StructureToPtr(gPInfo, gPtrPrinterInfo, True) gLastError = Marshal.GetLastWin32Error() gNRet = Convert.ToInt16(SetPrinter(gPrinter, 2, gPtrPrinterInfo, 0)) If gNRet = 0 Then 'Unable to set shared printer settings. gLastError = Marshal.GetLastWin32Error() Throw New Exception(Marshal.GetLastWin32Error().ToString) End If If gPrinter <> IntPtr.Zero Then ClosePrinter(gPrinter) End If Return Convert.ToBoolean(gNRet) End Function Private Function GetPrinterSettings(ByVal PrinterName As String) As DEVMODE Dim lDevMode As DEVMODE gPrinterValues.pDatatype = 0 gPrinterValues.pDevMode = 0 gPrinterValues.DesiredAccess = PRINTER_ALL_ACCESS gNRet = Convert.ToInt32(OpenPrinter(PrinterName, _ gPrinter, gPrinterValues)) If gNRet = 0 Then gLastError = Marshal.GetLastWin32Error() Throw New Exception(Marshal.GetLastWin32Error().ToString()) End If GetPrinter(gPrinter, 2, IntPtr.Zero, 0, gNBytesNeeded) If gNBytesNeeded IntPtr.Zero) Then 'Cannot get the DEVMODE structure. Throw New System.Exception("Cannot get DEVMODE data") End If gPInfo.pDevMode = gPtrDevMode End If gIntError = DocumentProperties(IntPtr.Zero, gPrinter, _ PrinterName, IntPtr.Zero, lTempBuffer, 0) gDevModeData = Marshal.AllocHGlobal(gIntError) gIntError = DocumentProperties(IntPtr.Zero, gPrinter, _ PrinterName, gDevModeData, lTempBuffer, 2) lDevMode = CType(Marshal.PtrToStructure(gDevModeData, GetType(DEVMODE)), DEVMODE) If (gNRet = 0) OrElse (gPrinter = IntPtr.Zero) Then gLastError = Marshal.GetLastWin32Error() Throw New Exception(Marshal.GetLastWin32Error().ToString()) End If Return lDevMode End If End Function #End Region End Class and to use this class: Dim lPrinterpreferences As PrinterSettingsHelper = New PrinterSettingsHelper() lPrinterpreferences.ChangePrinterSetting("MyFavouritePrinter")
