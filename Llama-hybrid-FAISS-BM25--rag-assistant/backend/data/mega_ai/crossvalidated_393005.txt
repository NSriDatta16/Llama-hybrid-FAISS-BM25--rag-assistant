[site]: crossvalidated
[post_id]: 393005
[parent_id]: 
[tags]: 
Forward algorithm for ZIP - Hidden Markov model

I'm trying to adjust a Zero Inflated Poisson Hidden Markov Model with Stan. For the Poisson-HMM in a past forum this setting was shown. see link . While to adjust the ZIP with the classical theory is well documented the code and model. Zero Inflation It uses a parameter theta here there is a probability $\theta$ of drawing a zero, and a probability $1−\theta$ of drawing from Poisson( $\lambda$ ) $p(y_n | \theta, \lambda) = \begin{cases} \theta + (1-\theta)*e^{-\lambda} & \text{ if } y_n=0 \\ (1-\theta)*e^{-\lambda} \frac{\lambda^{y_n}}{y_n!} & \text{ if } y_n>0 \end{cases}$ Zero Inflation - Hidden Markov Model Let $Y_t$ be the observed series and $C_t$ a homogeneous, unobserved Markov chain, withstate-space $E={e_1,· · ·, e_m}$ . We suppose that, conditionally to $C_t=e_i$ , $Y_t$ is distributed according to a ZIP of parameters $(\theta_i, \lambda_i)$ . $p(y_t | C_t ; \theta, \lambda) = \begin{cases} \theta_i + (1-\theta_i)*e^{-\lambda_i} & \text{ if } y_t=0 \\ (1-\theta_i)*e^{-\lambda_i} \frac{\lambda_i^{y_t}}{y_t!} & \text{ if } y_t>0 \end{cases}$ ziphsmm library(ziphsmm) set.seed(123) prior_init $series serie series, m = result$state) fit1 Stan library(rstan) ZIPHMM N; int y[N]; int m; } parameters { real theta; // positive_ordered[m] lambda; // simplex[m] Gamma[m]; // tpm } model { vector[m] log_Gamma_tr[m]; vector[m] lp; vector[m] lp_p1; // priors lambda ~ gamma(0.1,0.01); theta ~ beta(0.05, 0.05); // transposing tpm and taking the log of each entry for(i in 1:m) for(j in 1:m) log_Gamma_tr[j, i] = log(Gamma[i, j]); lp = rep_vector(-log(m), m); // for(n in 1:N) { for(j in 1:m){ if (y[n] == 0) lp_p1[j] = log_sum_exp(log_Gamma_tr[j] + lp) + log_sum_exp(bernoulli_lpmf(1 | theta), bernoulli_lpmf(0 | theta) + poisson_lpmf(y[n] | lambda[j])); else lp_p1[j] = log_sum_exp(log_Gamma_tr[j] + lp) + bernoulli_lpmf(0 | theta) + poisson_lpmf(y[n] | lambda[j]); } lp = lp_p1; } target += log_sum_exp(lp); }' mod_ZIP True values real = list(tpm = tpm, zeroprop = nrow(serie[serie $m == 1 & serie$ y == 0, ]) / nrow(serie[serie $m == 1,]), emit = t(t(tapply(serie$ y[serie $y != 0],serie$ m[serie $y != 0], mean)))) real $ tpm [,1] [,2] [1,] 0.9 0.1 [2,] 0.2 0.8 $zeroprop [1] 0.6341463 $emit [,1] 1 20.433333 2 7.277778 Estimates give quite oddly to someone could help me to know that I am doing wrong. I will expand my question, the proportion of zeros gives quite a distance with rStan theta = 0.518 and the real is 0.634, the same for the values of the transition matrix. Also the average of the values lambda1 = 7.62 and lambda2 = 20.54, while the real ones are lambda1 = 20.43 and lambda2 = 7.27. That is, they are crossed. I would expect to obtain estimates with rstan, similar to those of the ziphsmm package. I think I'm making some mistake in defining the model in Stan but I do not know which.
