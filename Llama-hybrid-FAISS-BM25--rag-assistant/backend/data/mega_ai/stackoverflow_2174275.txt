[site]: stackoverflow
[post_id]: 2174275
[parent_id]: 2144204
[tags]: 
The code needs to not only pay attention to the current ratio, but how you're changing the ratio with the crop. Also, the height calculation was based on half the desired height, and should have been the full height. Assuming all else is correct with your code, you should be able to place the code below into your FileExists if block, replacing the current content.
