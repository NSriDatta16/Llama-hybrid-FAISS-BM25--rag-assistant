[site]: stackoverflow
[post_id]: 153287
[parent_id]: 
[tags]: 
File name corruption on file download (IE)

I have implemented a simple file upload-download mechanism. When a user clicks a file name, the file is downloaded with these HTTP headers: HTTP/1.1 200 OK Date: Tue, 30 Sep 2008 14:00:39 GMT Server: Microsoft-IIS/6.0 Content-Disposition: attachment; filename=filename.doc; Content-Type: application/octet-stream Content-Length: 10754 I also support Japanese file names. In order to do that, I encode the file name with this java method: private String encodeFileName(String name) throws Exception{ String agent = request.getHeader("USER-AGENT"); if(agent != null && agent.indexOf("MSIE") != -1){ // is IE StringBuffer res = new StringBuffer(); char[] chArr = name.toCharArray(); for(int j = 0; j It worked well so far, until someone found out that it doesn't work well with long file names. For example: あああああああああああああああ2008.10.1あ.doc . If I change one of the single-byte dots to a single-byte underline , or if I remove the first character, it works OK. i.e., it depends on length and URL-encoding of a dot character. Following are a few examples. This is broken ( あああああああああああああああ2008.10.1あ.doc ): Content-Disposition: attachment; filename=%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%822008%2E10%2E1%e3%81%82.doc; This is OK ( あああああああああああああああ2008_10.1あ.doc ): Content-Disposition: attachment; filename=%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%822008_10%2E1%e3%81%82.doc; This is also fine ( あああああああああああああああ2008.10.1あ.doc ): Content-Disposition: attachment; filename=%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%82%e3%81%822008%2E10%2E1%e3%81%82.doc; Anybody have a clue?
