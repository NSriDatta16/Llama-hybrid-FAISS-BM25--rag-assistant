[site]: stackoverflow
[post_id]: 4137178
[parent_id]: 
[tags]: 
HttpModules life in ASP.NET MVC

I find a code about counting online users in Asp.Net. I add it to my MVC project but its not working. There is a custom Httpmodule that has a Init() function and it is being called in every request. where is the problem. init() must be run one time for all application lifecycle , but it is running on every request. This code run well on asp.net but because of init() method run in every request it is not working on MVC. public class OnlineUsersModule : IHttpModule { private static Int32 _sessionTimeOut = 20; // Set Default to 20 Minutes private static List _onlineUsers = null; public static List OnlineUsers { get { CleanExpiredSessions(); return _onlineUsers; } } private static void CleanExpiredSessions() { _onlineUsers.RemoveAll(delegate(OnlineUserInfo user) { return user.SessionStarted.AddMinutes(_sessionTimeOut) (); // Get the Current Session State Module SessionStateModule module = context.Modules["Session"] as SessionStateModule; module.Start += new EventHandler(Session_Start); } private void Session_Start(object sender, EventArgs e) { HttpRequest Request = HttpContext.Current.Request; HttpApplicationState Application = HttpContext.Current.Application; HttpSessionState Session = HttpContext.Current.Session; // Get Session TimeOut _sessionTimeOut = HttpContext.Current.Session.Timeout; Application.Lock(); OnlineUserInfo user = new OnlineUserInfo(); user.SessionId = Session.SessionID; user.SessionStarted = DateTime.Now; user.UserAgent = !String.IsNullOrEmpty(Request.UserAgent) ? Request.UserAgent : String.Empty; user.IPAddress = !String.IsNullOrEmpty(Request.UserHostAddress) ? Request.UserHostAddress : String.Empty; if (Request.UrlReferrer != null) { user.UrlReferrer = !String.IsNullOrEmpty(Request.UrlReferrer.OriginalString) ? Request.UrlReferrer.OriginalString : String.Empty; } else { user.UrlReferrer = String.Empty; } if (HttpContext.Current.User.Identity.IsAuthenticated) { user.CurrentUser = HttpContext.Current.User; } // Add the New User to Collection _onlineUsers.Add(user); Application.UnLock(); } public void Dispose() { } #endregion } public class OnlineUserInfo { public String UserAgent { get; set; } public String SessionId { get; set; } public String IPAddress { get; set; } public String UrlReferrer { get; set; } public DateTime SessionStarted { get; set; } public IPrincipal CurrentUser { get; set; } public override string ToString() { StringBuilder sb = new StringBuilder(); sb.AppendFormat("UserAgent = {0} | ", UserAgent); sb.AppendFormat("SessionId = {0} | ", SessionId); sb.AppendFormat("IPAddress = {0} | ", IPAddress); sb.AppendFormat("UrlReferrer = {0} | ", UrlReferrer); sb.AppendFormat("SessionStarted = {0}", SessionStarted); return sb.ToString(); } } Also I think there is one more problem. when i add breakpoint to init() method, after push F10 it goes to start of init() means there is other threads that try to run init() is it a problem?
