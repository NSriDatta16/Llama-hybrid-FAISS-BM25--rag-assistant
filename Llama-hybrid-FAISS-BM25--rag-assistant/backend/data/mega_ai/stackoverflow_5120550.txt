[site]: stackoverflow
[post_id]: 5120550
[parent_id]: 5119948
[tags]: 
Another Method, when a exe is packed with the UPX tool, the section of the PE header contains sections called UPX0 , UPX1 , etc. so if read these sections and compare the name with the string UPX you can determine if the exe was compressed using the UPX packer. check this function uses Windows; function IsUPXCompressed(const Filename:TFileName): Boolean; var i : integer; pBaseAddress : PByte; pDosHeader : PImageDosHeader; pNtHeaders : PImageNtHeaders; hFile : Cardinal; hFileMap : Cardinal; pSectionHeader: PImageSectionHeader; dwOffset : Cardinal; SectName : AnsiString; begin Result:=False; hFile := CreateFile(PChar(Filename), GENERIC_READ, FILE_SHARE_READ, nil, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, 0); if (hFile = INVALID_HANDLE_VALUE) then Exit; hFileMap := CreateFileMapping(hFile, nil, PAGE_READONLY or SEC_IMAGE, 0, 0, nil); if (hFileMap = 0) then begin CloseHandle(hFile); Exit; end; pBaseAddress := MapViewOfFile(hFileMap, FILE_MAP_READ, 0, 0, 0); if (pBaseAddress = nil) then begin CloseHandle(hFileMap); CloseHandle(hFile); Exit; end; try dwOffset := Cardinal(pBaseAddress); pDosHeader := PImageDosHeader(pBaseAddress); pNtHeaders := PImageNtHeaders(dwOffset + Cardinal(pDosHeader._lfanew)); pSectionHeader := pImageSectionHeader(Cardinal(pNtHeaders) + SizeOf(TImageNtHeaders)); for i := 0 to pNtHeaders.FileHeader.NumberOfSections-1 do begin SetString(SectName, PAnsiChar(@pSectionHeader.Name), SizeOf(pSectionHeader.Name)); Result:=Pos('UPX',SectName)>0; If Result then break; Inc(pSectionHeader); end; finally UnmapViewOfFile(pBaseAddress); CloseHandle(hFileMap); CloseHandle(hFile); end; end;
