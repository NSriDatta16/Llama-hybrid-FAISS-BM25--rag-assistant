[site]: stackoverflow
[post_id]: 3857778
[parent_id]: 3857003
[tags]: 
Add a unique key and let MySQL handle it: ALTER TABLE amounts_merged ADD UNIQUE (product,type,month,day,hour) In PHP: $sql = "INSERT INTO amounts_merged (product,type,month,day,hour,average_amount) SELECT product, type, month, day, hour, AVG(amount) AS average_amount FROM amounts GROUP BY product, type, month, day, hour ON DUPLICATE KEY UPDATE average_amount = VALUES(average_amount);" mysql_query($sql, $con); Some loose remarks: Don't quote variables that are integers or floats (don't know if they are, but I have my suspicions... Prepared statements are even more handy for both running more update queries then 1, and in preventing SQL injection. Having seperate columns for month/date/hour in your original amounts table is probably making live harder then need be, as with just having a timestamp/datetime you can get the data easily from those fiels, and you can still use all date functions easily on the original field.
