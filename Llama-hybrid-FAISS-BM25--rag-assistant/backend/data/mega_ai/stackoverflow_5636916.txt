[site]: stackoverflow
[post_id]: 5636916
[parent_id]: 
[tags]: 
How to terminate processes from a wmi permanent event consumer

I am trying to create a permanent wmi event consumer that will wait for a process to be created with a specific commandline parameter then terminate it. So far I can get my event handler to fire when expected and write to a test log file. I can even access parameters from the WMI event by using the TargetEvent.TargetInstance. However when i try to call terminate on it, it fails. I am also having trouble creating instances of objects like wscript.shell or wscript.network which fail to create an instance. I believe this might be because this script is not actually running in the windows script host. So my question is how can I get the terminate method to work on my instance of Win32_Process or is there a way to call an external command (given I can't use wscript.shell object). I got most of the details on how to create my mof file from here: http://www.codeproject.com/KB/system/PermEvtSubscriptionMOF.aspx?display=Print My Setup Mof File is the following: #pragma namespace("\\\\.\\root\\subscription") instance of __EventFilter as $EventFilter { Name = "My Test Filter"; EventNamespace = "Root\\Cimv2"; Query = "Select * From __InstanceCreationEvent Within 2 " "Where TargetInstance Isa \"Win32_Process\" " "And Targetinstance.Name = \"notepad.exe\" " "And Targetinstance.CommandLine LIKE \"%test.txt%\""; QueryLanguage = "WQL"; }; instance of ActiveScriptEventConsumer as $Consumer { Name = "MyTestConsumer"; ScriptingEngine = "VBScript"; ScriptText = "On Error Resume Next\n" "'Set WshShell = WScript.CreateObject(\"WScript.Shell\")\n" "Set objFSO = CreateObject(\"Scripting.FileSystemObject\")\n" "Set objFile = objFSO.OpenTextFile(\"c:\\log.txt\", 8, True)\n" "objFile.WriteLine Time & \" \" & \" notepad started \" & TargetEvent.TargetInstance.Handle \n" "objFile.Close\n" "TargetEvent.TargetInstance.Terminate()\n"; }; instance of __FilterToConsumerBinding { Filter = $EventFilter; Consumer = $Consumer; }; My removal mof file is: #pragma namespace("\\\\.\\root\\subscription") #Pragma deleteInstance("__EventFilter.Name=\"My Test Filter\"",FAIL) #Pragma deleteInstance("ActiveScriptEventConsumer.Name=\"MyTestConsumer\"",FAIL) #pragma deleteinstance ("__FilterToConsumerBinding.Consumer=" "\"\\\\\\\\.\\\\root\\\\subscription:ActiveScriptEventConsumer.Name=\\\"MyTestConsumer\\\"\"," "Filter=\"\\\\\\\\.\\\\root\\\\subscription:__EventFilter.Name=\\\"My Test Filter\\\"\"", FAIL)
