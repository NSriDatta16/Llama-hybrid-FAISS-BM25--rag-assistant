[site]: stackoverflow
[post_id]: 2993386
[parent_id]: 2993236
[tags]: 
You can add another CTE to determine the count of employees and then use that in an Update statement: WITH OrgChart (employeeID, employeeName,managerID,level) AS ( SELECT employeeID,employeeName,0 as managerID,0 AS Level FROM Employees WHERE managerID IS NULL UNION ALL SELECT Employees.employeeID,Employees.employeeName,Employees.managerID,Level + 1 FROM Employees INNER JOIN OrgChart ON Employees.managerID = OrgChart.employeeID ) , SubordinateCount As ( Select ManagerId, Count(*) As Total From OrgChart Group By ManagerId ) Update Employees Set TotalOrganization = SubordinateCount.Total FROM SubordinateCount Join Employees As E On E.employeeId = SubordinateCount.ManagerId ADDITION The change in spec is that you want a count of all subordinate employees. The trick to that is to create a path of the employee to each of their managers. So, first here is my test data: Insert Employees(EmployeeId, Name, ManagerId) Values(1, 'Alice', Null) Insert Employees(EmployeeId, Name, ManagerId) Values(2, 'Bob', 1) Insert Employees(EmployeeId, Name, ManagerId) Values(3, 'Charlie', 1) Insert Employees(EmployeeId, Name, ManagerId) Values(4, 'Dan', 3) Insert Employees(EmployeeId, Name, ManagerId) Values(5, 'Ellen', 3) Insert Employees(EmployeeId, Name, ManagerId) Values(6, 'Fred', 5) Insert Employees(EmployeeId, Name, ManagerId) Values(7, 'Gale', 6) Insert Employees(EmployeeId, Name, ManagerId) Values(8, 'Harry', 6) So, first we write a query that gives us a path to their manager: With OrgChart As ( Select E.EmployeeId, E.Name, Null As ManagerId, 0 AS Level , Cast( '/' + Cast(E.EmployeeId As varchar(10)) + '/' As varchar(100) ) As Path From dbo.Employees As E Where E.ManagerId Is Null Union All Select E.EmployeeID, E.Name, E.ManagerID, Level + 1 , Cast( OrgChart.Path + Cast(E.EmployeeId As varchar(10)) + '/' As varchar(100)) From dbo.Employees As E Join OrgChart On OrgChart.EmployeeId = E.ManagerID ) Select * From OrgChart That produces: EmployeeId Name ManagerId Level Path 1 Alice NULL 0 /1/ 2 Bob 1 1 /1/2/ 3 Charlie 1 1 /1/3/ 4 Dan 3 2 /1/3/4/ 5 Ellen 3 2 /1/3/5/ 6 Fred 5 3 /1/3/5/6/ 7 Gale 6 4 /1/3/5/6/7/ 8 Harry 6 4 /1/3/5/6/8/ Now we simply need to count instances where the given employee exists in someone's path: With OrgChart As ( Select E.EmployeeId, E.Name, Null As ManagerId, 0 AS Level , Cast( '/' + Cast(E.EmployeeId As varchar(10)) + '/' As varchar(100) ) As Path From dbo.Employees As E Where E.ManagerId Is Null Union All Select E.EmployeeID, E.Name, E.ManagerID, Level + 1 , Cast( OrgChart.Path + Cast(E.EmployeeId As varchar(10)) + '/' As varchar(100)) From dbo.Employees As E Join OrgChart On OrgChart.EmployeeId = E.ManagerID ) , OrgCounts As ( Select O.EmployeeId, O.Name, O.ManagerId, O.Level, O.Path , (Select Count(*) From OrgChart As O1 Where O1.Path Like '%/' + Cast(E.EmployeeId As varchar(10)) + '/%') - 1 As SubordinateTotal From Employees As E Join OrgChart As O On O.EmployeeId = E.EmployeeId ) Select O.EmployeeId, O.Name, O.ManagerId, O.Level, O.Path, O.SubordinateTotal From OrgCounts I subtract one from the total to exclude the current employee. Now that we've found a query to provide the proper results, we can easily use that to do an update: With OrgChart As ( Select E.EmployeeId, E.Name, Null As ManagerId, 0 AS Level , Cast( '/' + Cast(E.EmployeeId As varchar(10)) + '/' As varchar(100) ) As Path From dbo.Employees As E Where E.ManagerId Is Null Union All Select E.EmployeeID, E.Name, E.ManagerID, Level + 1 , Cast( OrgChart.Path + Cast(E.EmployeeId As varchar(10)) + '/' As varchar(100)) From dbo.Employees As E Join OrgChart On OrgChart.EmployeeId = E.ManagerID ) , OrgCounts As ( Select O.EmployeeId, O.Name, O.ManagerId, O.Level, O.Path , (Select Count(*) From OrgChart As O1 Where O1.Path Like '%/' + Cast(E.EmployeeId As varchar(10)) + '/%') - 1 As SubordinateTotal From Employees As E Join OrgChart As O On O.EmployeeId = E.EmployeeId ) Update Employees Set TotalOrganization = O.SubordinateTotal From OrgCounts As O Join dbo.Employees As E On E.EmployeeId = O.EmployeeId
