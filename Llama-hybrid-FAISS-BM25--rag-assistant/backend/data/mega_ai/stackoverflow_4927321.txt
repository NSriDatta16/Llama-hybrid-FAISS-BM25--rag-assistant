[site]: stackoverflow
[post_id]: 4927321
[parent_id]: 4923323
[tags]: 
Try this: EDITED: added NULLIF(..., 0) to treat 0s as NULLs. SELECT t1.SKU, COALESCE( NULLIF(AVG(t1.DaysDifference), 0), NULLIF(t2.AvgDifferenceVendor, 0), 7 ) AS AvgDiff FROM @TmpTbl_SKUs t1 INNER JOIN ( SELECT Vendor, AVG(DaysDifference) AS AvgDifferenceVendor FROM @TmpTbl_SKUs GROUP BY Vendor ) t2 ON t1.Vendor = t2.Vendor GROUP BY t1.SKU, t2.AvgDifferenceVendor EDIT 2: how I tested the script. For testing I'm using the sample data posted with the question. DECLARE @TmpTbl_SKUs AS TABLE ( Vendor VARCHAR (255), Number VARCHAR(4), SKU VARCHAR(20), PurchaseOrderDate DATETIME, LastReceivedDate DATETIME, DaysDifference INT ) INSERT INTO @TmpTbl_SKUs (Vendor, Number, SKU, PurchaseOrderDate, LastReceivedDate, DaysDifference) SELECT 'OTHER PMDD', '1111', 'OP1111', '2009-08-21 00:00:00.000', '2009-09-02 00:00:00.000', 12 UNION ALL SELECT 'OTHER PMDD', '1111', 'OP1112', '2009-12-09 00:00:00.000', '2009-12-17 00:00:00.000', 8 UNION ALL SELECT 'MANTOR', '3333', 'MA1111', '2006-02-15 00:00:00.000', '2006-02-23 00:00:00.000', 8 UNION ALL SELECT 'MANTOR', '3333', 'MA1112', '2006-02-15 00:00:00.000', '2006-02-23 00:00:00.000', 8; First I'm running the script on the unmodified data. Here's the result: SKU AvgDiff -------------------- ----------- MA1111 8 MA1112 8 OP1111 12 OP1112 8 AvgDiff for every SKU is identical to the original DaysDifference for every SKU, because there's only one row per each one. Now I'm changing DaysDifference for SKU='MA1111' to 0 and running the script again. Ther result is: SKU AvgDiff -------------------- ----------- MA1111 4 MA1112 8 OP1111 12 OP1112 8 Now AvgDiff for MA1111 is 4. Why? Because the average for the SKU is 0, and so the average by Vendor is taken, which has been calculated as (0 + 8) / 2 = 4 . Next step is to set DaysDifference to 0 for all the SKUs of the same Vendor. In this case I'm setting it for SKUs MA1111 and MA1112. Here's the result of the script for this change: SKU AvgDiff -------------------- ----------- MA1111 7 MA1112 7 OP1111 12 OP1112 8 So now AvgDiff is 7 for both MA1111 and MA1112. How has it become so? Both have DaysDifference = 0. That means that the average by Vendor should be taken for each one. But Vendor average is 0 too in this case. According to the requirement, the average here should default to 7, which is what the script has returned. So the script seems to be working correctly. I understand that it's either me having missed something or you having forgotten to mention some details. In any case, I would be glad to see where this script fails to solve your problem.
