[site]: stackoverflow
[post_id]: 733420
[parent_id]: 733384
[tags]: 
Here is an example using ZwQueryProcessInformation from the DDK. The DDK is now known as the "WDK" and is available with MSDN. If you don't have MSDN, apparantly, you can also get it from here . I haven't tried it, I just googled your question. #include "ntdll.h" #include #include #include "ntddk.h" #define DUPLICATE_SAME_ATTRIBUTES 0x00000004 #pragma comment(lib,"ntdll.lib") BOOL EnablePrivilege(PCSTR name) { TOKEN_PRIVILEGES priv = {1, {0, 0, SE_PRIVILEGE_ENABLED}}; LookupPrivilegeValue(0, name, &priv.Privileges[0].Luid); HANDLE hToken; OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &hToken); AdjustTokenPrivileges(hToken, FALSE, &priv, sizeof priv, 0, 0); BOOL rv = GetLastError() == ERROR_SUCCESS; CloseHandle(hToken); return rv; } int main(int argc, char *argv[]) { if (argc == 1) return 0; ULONG pid = strtoul(argv[1], 0, 0); EnablePrivilege(SE_DEBUG_NAME); HANDLE hProcess = OpenProcess(PROCESS_DUP_HANDLE, FALSE, pid); ULONG n = 0x1000; PULONG p = new ULONG[n]; while (NT::ZwQuerySystemInformation(NT::SystemHandleInformation, p, n * sizeof *p, 0) == STATUS_INFO_LENGTH_MISMATCH) delete [] p, p = new ULONG[n *= 2]; NT::PSYSTEM_HANDLE_INFORMATION h = NT::PSYSTEM_HANDLE_INFORMATION(p + 1); for (ULONG i = 0; i
