[site]: stackoverflow
[post_id]: 3561122
[parent_id]: 3558407
[tags]: 
For what it's worth, here's my current version of the escape-text template which incorporates most of the (excellent!) suggestions which people have given in response to my question. For the record, my original version took about 45605ms on average on my sample DocBook document. After that, the runtime was decreased in multiple steps: Removing the left and right variable together with the concat() call brought the runtime down to 13052ms; this optimization was taken from Tomalak's answer . Moving the common case (which is: the given character doesn't need any special escaping) first in the inner element brought the runtime further down to 5812ms. This optimization was first suggested by Dimitre . Aborting the recursion early by first testing whether the given string contains any of the special characters at all brought the runtime down to 612ms. This optimization was suggested by Michael . Finally, I couldn't resist doing a micro optimization after reading a comment by Dimitre in Tomalak's answer : I replaced the calls with x y . This brought the runtime to about 606ms (so about 1% improvement). In the end, the function took 606ms instead of 45605ms. Impressive! "@|#\}&amp;^~/{ 1"> &quot; \ &quot;
