[site]: stackoverflow
[post_id]: 5382008
[parent_id]: 5187168
[tags]: 
Now that the sound of crickets chirping has dwindled in the background I guess I'll post the workaround I currently have in place: Instead of inheriting and extending CMFCCaptionMenuButton I build my class by extending CMFCCaptionButton . I then create a menu and provide a ShowMenu method to be explicitly called when handling the custom button events as well as overriding GetIconID to return a particular system icon for the button for each menu added to the caption bar ending up with something like this for the example outlined in the question: #pragma once // CMorphMenuButton command target class CMorphMenuButton : public CMFCCaptionButton { public: CMorphMenuButton(UINT nHit); virtual ~CMorphMenuButton(); virtual CMenuImages::IMAGES_IDS GetIconID (BOOL bHorz, BOOL bMaximized) const; void ShowMenu(CWnd* pWnd); private: CMenu m_dockMenu; CMenu* m_subMenu; }; // MorphMenuButton.cpp : implementation file // #include "stdafx.h" #include "MorphMenuButton.h" // CMorphMenuButton CMorphMenuButton::CMorphMenuButton(UINT nHit) : CMFCCaptionButton(nHit) { SetMiniFrameButton(); // already defaulted? m_dockMenu.LoadMenu(IDR_DOCKPANE); // resource ID for dock pane menus } CMorphMenuButton::~CMorphMenuButton() { m_dockMenu.DestroyMenu(); } CMenuImages::IMAGES_IDS CMorphMenuButton::GetIconID(BOOL bHorz, BOOL bMaximized) const { return CMenuImages::IdArrowForward; } void CMorphMenuButton::ShowMenu(CWnd* pWnd) { CRect windowRect, buttonRect; pWnd->GetWindowRect(&windowRect); buttonRect = GetRect(); CPoint menuPos(windowRect.left + buttonRect.right, windowRect.top + buttonRect.bottom); m_subMenu = m_dockMenu.GetSubMenu(0); if (!m_subMenu->TrackPopupMenu(TPM_LEFTALIGN | TPM_RIGHTBUTTON, menuPos.x, menuPos.y, pWnd)) { DWORD id = GetLastError(); wchar_t errMsg[256]; FormatMessage(FORMAT_MESSAGE_FROM_SYSTEM, 0, id, 0, errMsg, sizeof(errMsg), 0); MessageBox(0, errMsg, L"Error", MB_OK); } } The setting of caption bar buttons and handling of click events for both buttons and menus are the same as defined in the question and this works.
