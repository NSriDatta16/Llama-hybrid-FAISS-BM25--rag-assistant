[site]: stackoverflow
[post_id]: 4205443
[parent_id]: 
[tags]: 
EF4: Object Context consuming too much memory

I have a reporting tool that runs against an MS SQL Server using EF4. The general bulk of this report involves looping over around 5000 rows and then pulling numerous other rows for each one of these. I pull the initial rows through one data context. The code that pulls the related rows involves using another data context, wrapped in a using statement. It would appear though that the memory consumed by the second data context is never freed and usage shoots up to 1.5GB before an out of memory exception is thrown. Here a snippet of the code so you can get the idea: var outlets = (from o in db.tblOutlets where o.OutletType == 3 && o.tblCalls.Count() > number && o.BelongsToUser.HasValue && o.tblUser.Active == true select new { outlet = o, callcount = o.tblCalls.Count() }).OrderByDescending(p => p.callcount); var outletcount = outlets.Count(); //var outletcount = 0; //var average = outlets.Average(p => p.callcount); foreach (var outlet in outlets) { using (relenster_v2Entities db_2 = new relenster_v2Entities()) { //loop over calls and add history //check the last time the history table was added to for this call var lastEntry = (from h in db_2.tblOutletDistributionHistories where h.OutletID == outlet.outlet.OutletID orderby h.VisitDate descending select h).FirstOrDefault(); DateTime? beginLooking = null; I had hoped that by using a second data context that memory could be released after each iteration. It would appear it is not (or the GC is not running in time)
