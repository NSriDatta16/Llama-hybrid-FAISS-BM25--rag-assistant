[site]: stackoverflow
[post_id]: 284149
[parent_id]: 
[tags]: 
How do I mix message encoding types (Text/MTOM) in the Request & Response of a Web Service client application using WCF (or WSE 3)?

Here is my problem. I am hitting a web service (hosted on a Java based server) that will only accept text encoded Requests, but it returns MTOM Responses. What I've found is that if I set the web service to RequireMtom, it sends an Mtom request! Unfortunately, the server chokes on an Mtom request and returns a 500 error. However, if I set it to Text message encoding, the response comes back correctly with a multipart MIME (MTOM) response that errors out the Microsoft Web Service API (sample error below). It's expecting a text encoded response because the request was text encoded. I would like to RequireMtom on the response only. Can anyone help me here? As you can see in the error below (which occurs with the standard web services API, WCF or WSE3), when I send the request with text encoding, the response comes back correctly with all the data in a multipart/related response, but the .net framework chokes! ERROR MESSAGE WITH WSE: Client found response content type of 'multipart/related; type="text/xml"; start=" "; boundary="----=_Part_209564_1891070135.1226526701833"', but expected 'text/xml'. The request failed with the error message: at System.Web.Services.Protocols.SoapHttpClientProtocol.ReadResponse(SoapClientMessage message, WebResponse response, Stream responseStream, Boolean asyncCall) at System.Web.Services.Protocols.SoapHttpClientProtocol.Invoke(String methodName, Object[] parameters) at TestWseService.AdesaJasperWse.ManagementServiceService.runReport(String requestXmlString) in C:\Documents and Settings\xxx\My Documents\Visual Studio 2005\Projects\TestWseService\Web References\AdesaJasperWse\Reference.cs:line 229 at TestWseService.Form1.buttonRunService_Click(Object sender, EventArgs e) in C:\Documents and Settings\xxx\My Documents\Visual Studio 2005\Projects\TestWseService\Form1.cs:line 42 ERROR MESSAGE WITH WCF The content type multipart/related; type="text/xml"; start=" "; boundary="----=_Part_209545_389093169.1226526546805" of the response message does not match the content type of the binding (text/xml; charset=utf-8). If using a custom encoder, be sure that the IsContentTypeSupported method is implemented properly. The first 1024 bytes of the response were: Server stack trace: at System.ServiceModel.Channels.HttpChannelUtilities.ValidateRequestReplyResponse(HttpWebRequest request, HttpWebResponse response, HttpChannelFactory factory, WebException responseException) at System.ServiceModel.Channels.HttpChannelFactory.HttpRequestChannel.HttpChannelRequest.WaitForReply(TimeSpan timeout) at System.ServiceModel.Channels.RequestChannel.Request(Message message, TimeSpan timeout) at System.ServiceModel.Dispatcher.RequestChannelBinder.Request(Message message, TimeSpan timeout) at System.ServiceModel.Channels.ServiceChannel.Call(String action, Boolean oneway, ProxyOperationRuntime operation, Object[] ins, Object[] outs, TimeSpan timeout) at System.ServiceModel.Channels.ServiceChannel.Call(String action, Boolean oneway, ProxyOperationRuntime operation, Object[] ins, Object[] outs) at System.ServiceModel.Channels.ServiceChannelProxy.InvokeService(IMethodCallMessage methodCall, ProxyOperationRuntime operation) at System.ServiceModel.Channels.ServiceChannelProxy.Invoke(IMessage message) Request (with Text Message Encoding): POST /jasperserver-pro/services/repository HTTP/1.1 Content-Type: text/xml; charset=utf-8 VsDebuggerCausalityData: uIDPo7V2+runH+xGudbec7ueUU8AAAAA7H9vL3stlkCBofMgLa5DWkQOHHpBdy1Ek6P6nXx7FpsACQAA SOAPAction: "" Authorization: Basic amFzcGVyYWRtaW46akBzcDNyQGRtJW4= Host: reports.dev.xxx.com Content-Length: 789 Expect: 100-continue &lt;request operationName="runReport" locale="en"&gt;&#xD; &lt;argument name="RUN_OUTPUT_FORMAT"&gt;HTML&lt;/argument&gt;&#xD; &lt;resourceDescriptor name="" wsType="" uriString="/BusinessIntelligence/MOS/Reports/dotnettest" isNew="false"&gt;&#xD; &lt;label&gt;null&lt;/label&gt;&#xD; &lt;parameter name="testparam"&gt;1&lt;/parameter&gt;&#xD; &lt;/resourceDescriptor&gt;&#xD; &lt;/request&gt; Response (with Text Message Encoding): HTTP/1.1 200 OK Date: Wed, 12 Nov 2008 21:49:04 GMT Server: IBM_HTTP_Server Surrogate-Control: no-store Set-Cookie: JSESSIONID=0000z5pH1xEMyulueASctjru2qe:13kftunf6; Path=/ Expires: Thu, 01 Dec 1994 16:00:00 GMT Cache-Control: no-cache="set-cookie, set-cookie2" Content-Length: 2580 Content-Type: multipart/related; type="text/xml"; start=" "; boundary="----=_Part_209545_389093169.1226526546805" Content-Language: en-US ------=_Part_209545_389093169.1226526546805 Content-Type: text/xml; charset=UTF-8 Content-Transfer-Encoding: binary Content-Id: &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;operationResult version=&quot;2.0.1&quot;&gt; &lt;returnCode&gt;&lt;![CDATA[0]]&gt;&lt;/returnCode&gt; &lt;/operationResult&gt; ------=_Part_209545_389093169.1226526546805 Content-Type: text/html Content-Transfer-Encoding: binary Content-Id: a {text-decoration: none} &nbsp; The value of the parameter is: 1 &nbsp; ------=_Part_209545_389093169.1226526546805-- Request (with Mtom Message Encoding): POST /jasperserver-pro/services/repository HTTP/1.1 MIME-Version: 1.0 Content-Type: multipart/related; type="application/xop+xml";start=" ";boundary="uuid:fafcdca7-94f7-4884-a8d4-5c6d50dbe8ef+id=1";start-info="text/xml" VsDebuggerCausalityData: uIDPo+cN2kKX2odFuUVaER0j60gAAAAAmfYaGH7Ow0WQOcwhebh5pqmDl29omcVOtwVGa10IWewACQAA SOAPAction: "" Authorization: Basic amFzcGVyYWRtaW46akBzcDNyQGRtJW4= Host: reports.dev.xxx.com Content-Length: 1031 Expect: 100-continue --uuid:fafcdca7-94f7-4884-a8d4-5c6d50dbe8ef+id=1 Content-ID: Content-Transfer-Encoding: 8bit Content-Type: application/xop+xml;charset=utf-8;type="text/xml" &lt;request operationName="runReport" locale="en"&gt;&#xD; &lt;argument name="RUN_OUTPUT_FORMAT"&gt;HTML&lt;/argument&gt;&#xD; &lt;resourceDescriptor name="" wsType="" uriString="/BusinessIntelligence/MOS/Reports/dotnettest" isNew="false"&gt;&#xD; &lt;label&gt;null&lt;/label&gt;&#xD; &lt;parameter name="testparam"&gt;1&lt;/parameter&gt;&#xD; &lt;/resourceDescriptor&gt;&#xD; &lt;/request&gt; --uuid:fafcdca7-94f7-4884-a8d4-5c6d50dbe8ef+id=1-- Response (with Mtom Message Encoding): HTTP/1.1 500 Internal Server Error Date: Wed, 12 Nov 2008 21:47:42 GMT Server: IBM_HTTP_Server Surrogate-Control: no-store $WSEP: Set-Cookie: JSESSIONID=0000_iMrdp-TnK9FG3jZFzjx_hA:13kftunf6; Path=/ Expires: Thu, 01 Dec 1994 16:00:00 GMT Cache-Control: no-cache="set-cookie, set-cookie2" Content-Length: 12 Connection: close Content-Type: text/html;charset=UTF-8 Content-Language: en-US Error 500: Here is a link that supports the theory that Microsoft does not support mixed encodings: WSE 3.0: MTOM response mandatory for MTOM request? UHG!
