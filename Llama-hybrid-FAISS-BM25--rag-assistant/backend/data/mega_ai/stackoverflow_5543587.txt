[site]: stackoverflow
[post_id]: 5543587
[parent_id]: 5540103
[tags]: 
One solution is creating unique function-objects in JS for every single update, which I believe is not an efficient way? May not work as you'd like it to: https://jira.mongodb.org/browse/SERVER-458 Is this possible in an efficient way? The issue you're facing is that you want MongoDB to perform an upsert with some more complex logic. So you want to leverage the document-level locking to effectively "trigger" multiple complex changes all at once. You're not the first one to want this, unfortunately it's not available right now. There are several server bugs tied to this type of "more complex update behavior". You may want to watch / vote on a few of the following to check for progress. $set only when inserting , add only when not existing , push and set at the same time , coordinate a "size" with $addToSet . In particular, SERVER-458 seems closest to what you want.
