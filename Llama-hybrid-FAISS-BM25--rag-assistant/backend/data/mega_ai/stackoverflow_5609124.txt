[site]: stackoverflow
[post_id]: 5609124
[parent_id]: 
[tags]: 
send_file in rails drops last 4KB of 16KB file when sent to client

I uploaded a 16 kB PNG image into a photos database on my Rails development server using attachment_fu, and I can view the PNG image in a browser pointing to the Rails development server. So that part works fine. When I download the file to my iPhone app, and look at the data received in the method "didReceiveData", I have two problems: Sometimes the last 4 kB of the PNG file is dropped, so only 12 kB is received. Other times, only 4 kB or 8 kB is sent and parts of the PNG image are not in this 4 or 8 kB received. The first occurs when I change a parameter in send_file (like buffer_size to 16kB) and restart the server. This makes me think there is some sort of caching going on with the development server. Otherwise if I haven't changed a parameter and restarted the server, #2 above occurs. To try and fix 1 by stopping caching in the development server, I've A) added to config/environments/development.rb : config.cache_classes = true config.action_controller.perform_caching = false B) and added the following code in the controller: response.headers.delete("Pragma") response.headers.delete('Cache-Control') response.headers["Expires"] = "#{1.year.ago}" Below is the code where send_file is called in the controller: user_photo = Photo.find_by_id(334) @p = user_photo send_file("#{RAILS_ROOT}/public" + @p.public_filename, :disposition => 'inline', :encoding => 'binary', :type => @p.content_type, :stream => false, :filename => URI.encode(@p.filename), :buffer_size => 4096 ) My connectionDidFinishLoading method looks like: -(void)connectionDidFinishLoading:(NSURLConnection *)connection { [connection release]; [theConnectionData release]; } Any ideas why the PNG image gets truncated by 4kB or sporadically the file doesn't get sent at all?
