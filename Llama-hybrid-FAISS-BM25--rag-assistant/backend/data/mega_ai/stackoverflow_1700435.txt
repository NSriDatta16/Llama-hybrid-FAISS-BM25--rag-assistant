[site]: stackoverflow
[post_id]: 1700435
[parent_id]: 
[tags]: 
Calculate upload transfer speed problem

I have implemented a file transfer rate calculator to display kB/sec for an upload process occuring in my app, however with the following code it seems I am getting 'bursts' in my KB/s readings just after the file commences to upload. This is the portion of my stream code, this streams a file in 1024 chunks to a server using httpWebRequest: using (Stream httpWebRequestStream = httpWebRequest.GetRequestStream()) { if (request.DataStream != null) { byte[] buffer = new byte[1024]; int bytesRead = 0; Debug.WriteLine("File Start"); var duration = new Stopwatch(); duration.Start(); while (true) { bytesRead = request.DataStream.Read(buffer, 0, buffer.Length); if (bytesRead == 0) break; httpWebRequestStream.Write(buffer, 0, bytesRead); totalBytes += bytesRead; double bytesPerSecond = 0; if (duration.Elapsed.TotalSeconds > 0) bytesPerSecond = (totalBytes / duration.Elapsed.TotalSeconds); Debug.WriteLine(((long)bytesPerSecond).FormatAsFileSize()); } duration.Stop(); Debug.WriteLine("File End"); request.DataStream.Close(); } } Now an output log of the upload process and associated kB/sec readings are as follows: (You will note a new file starts and ends with 'File Start' and 'File End') File Start 5.19 MB 7.89 MB 9.35 MB 11.12 MB 12.2 MB 13.13 MB 13.84 MB 14.42 MB 41.97 kB 37.44 kB 41.17 kB 37.68 kB 40.81 kB 40.21 kB 33.8 kB 34.68 kB 33.34 kB 35.3 kB 33.92 kB 35.7 kB 34.36 kB 35.99 kB 34.7 kB 34.85 kB File End File Start 11.32 MB 14.7 MB 15.98 MB 17.82 MB 18.02 MB 18.88 MB 18.93 MB 19.44 MB 40.76 kB 36.53 kB 40.17 kB 36.99 kB 40.07 kB 37.27 kB 39.92 kB 37.44 kB 39.77 kB 36.49 kB 34.81 kB 36.63 kB 35.15 kB 36.82 kB 35.51 kB 37.04 kB 35.71 kB 37.13 kB 34.66 kB 33.6 kB 34.8 kB 33.96 kB 35.09 kB 34.1 kB 35.17 kB 34.34 kB 35.35 kB 34.28 kB File End My problem is as you will notice, the 'burst' I am talking about starts at the beginning of every new file, peaking in MB's and then evens out properly. is this normal for an upload to burst like this? My upload speeds typically won't go higher than 40k/sec here so it can't be right. This is a real issue, when I take an average of the last 5 - 10 seconds for on-screen display, it really throws things out producing a result around ~3MB/sec! Any ideas if I am approaching this problem the best way? and what I should do? :S Graham Also: Why can't I do ' bytesPerSecond = (bytesRead / duration.Elapsed.TotalSeconds) ' and move duration.Start & duration.Stop into the while loop and receive accurate results? I would have thought this would be more accurate? Each speed reads as 900 bytes/sec, 800 bytes/sec etc.
