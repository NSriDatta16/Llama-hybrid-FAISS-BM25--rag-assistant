[site]: crossvalidated
[post_id]: 618579
[parent_id]: 
[tags]: 
Counterfactual Contrasts in a Hierarchical model using emmeans()

--REPRODUCIBLE EXAMPLE INCLUDED! See below -- Hi! I'm attempting to measure a difference in sales using a Controlled Interrupted Time-Series methodology; that is, I have a collection of 'exposed' and 'unexposed' time series and I am trying to infer the effect of an exposure based on the magnitude of level-change and slope-change in the estimated trend of the time series. To add a wrinkle, I'm using a linear mixed model to give each subject its own trend over time; because of this (and the fact that my effect of interest is encoded as multiple coefficients/interactions in the model) I'm trying using the emmeans package to compute the marginal mean for the sales difference between the estimated trend of the 'exposed' subjects and the estimated counterfactual trend of the 'exposed' subjects if they had been unexposed . Here's some simulated data: library(tippy) library(ggplot2) library(dplyr) library(magrittr) library(lme4) library(emmeans) library(fdrtool) # A function to generate the sales based on an underlying model (don't peek!) simulate_sales_data $exposure[geo_df$ geo_name == g] # Determine the geo's unique intercept/slope/season terms int 365) + era_slopechange * (time_seq - 365) * (time_seq > 365) + epsilon return(data.frame(geo_name = g, time = time_seq, sales = s2))}) %>% do.call(rbind.data.frame, .) %>% left_join(geo_df, by = "geo_name") %>% mutate( exposure_label = factor(exposure, levels = c(FALSE, TRUE), labels = c("Unexposed", "Exposed")), era = factor(case_when(time >= 365 ~'Post', TRUE ~ 'Pre'), levels = c("Pre", "Post"))) } # Initialize some parameters geographies % filter(time $saledate time, origin = "2021-01-01") # A little cleanup salesdata $exposure exposure, levels = c(TRUE, FALSE)) salesdata $era era, levels = c("Post", "Pre")) # examine the sales as a plot ggplot(data = salesdata, aes(x = time, y = sales, group = geo_name, color = geo_name, linetype = exposure)) + geom_line() + scale_color_discrete(guide = "none") + theme(legend.position = "bottom") + geom_vline(xintercept = 365, linetype = 2) + annotate("label", x = 365, y = 10500, label = "Start of Media") + theme(panel.background = element_blank(), panel.grid.major = element_line(color = "grey93"), panel.grid.minor = element_line(color = "grey93"), axis.line = element_line(colour = "black")) # Or like this (different plot) filter(salesdata, geo_name %in% c( salesdata %>% distinct(geo_name, exposure) %>% group_by(exposure) %>% filter(row_number() % {.$geo_name})) %>% ggplot(data = ., aes(x = time, y = sales, group = geo_name, color = geo_name, linetype = exposure)) + geom_line() + scale_color_discrete(guide = "none") + theme(legend.position = "bottom") + geom_vline(xintercept = 365, linetype = 2) + annotate("label", x = 365, y = 15000, label = "Start of Media") + theme(panel.background = element_blank(), panel.grid.major = element_line(color = "grey93"), panel.grid.minor = element_line(color = "grey93"), axis.line = element_line(colour = "black")) + facet_wrap(~geo_name) Here's my model that I'm fitting: mdl Here, I'm attempting to give each geography a random intercept, slope, and seasonal (sinusoidal) trend, AS WELL as a random level+ slope change based on which 'era' it is (either 'Pre'- or 'Post'-intervention). 'Era' and 'exposure' are also included as fixed effects because my ultimate goal will be to compare the average level+slope change among exposed subjects to the average level+slope change samong unexposed subjects . Now, where I run into trouble is how to estimate a grid of counterfactual predictions (for only the EXPOSED subjects). I started with something along the lines of emmeans(mdl2, ~era*exposure, counterfactuals = "exposure") But this isn't correct and my lack of familiarity with emmeans is making this really difficult to figure out. I think my problem is that I want to use the exposure as a counterfactual variable (i.e., estimate means for every subject as if it were both an 'exposed' AND an 'unexposed') but also as a subsetting variable (i.e., I am only interested in the counterfactual comparisons among the subjects that were unexposed.) The counterfactual is fairly easy to estimate in terms of its mean value (can just create a copy of the dataset where exposure = 'Unexposed' for all subjects) but obviously this doesn't preserve the standard error of the estimates so I can't do inferential testing on these differences. Here's a visual representation of what I'm trying to estimate: salesdata$pred2 % distinct(exposure, geo_name) %>% group_by(exposure) %>% head(16) %>% {.$geo_name})) g Ultimately, I'm looking for a way to test whether the difference between the solid red lines and the dashed red lines is statistically significant. Any stats folks out there that can point me in the right direction? Thank you so much!
