[site]: stackoverflow
[post_id]: 1120283
[parent_id]: 
[tags]: 
Uri.TryCreate throws UriFormatException?

I have a method that tries to create a Uri and then clean it up (removes fragments, excludes some domains and query string patterns, etc.). The method looks like this: static public bool TryCreateCleanUri(Uri baseUri, string relstr, out Uri result) { if (!Uri.TryCreate(baseUri, relstr, out result)) { return false; } return CleanupUri(result, out result); } This method has been working fine for months. But last night it failed. Uri.TryCreate() threw an exception! Here's the stack trace: ERROR: Unhandled exception caught. Program terminating. System.UriFormatException: Invalid URI: The hostname could not be parsed. at System.Uri.CreateHostStringHelper(String str, UInt16 idx, UInt16 end, Flags& flags, String& scopeId) at System.Uri.CreateHostString() at System.Uri.GetComponentsHelper(UriComponents uriComponents, UriFormat uriFormat) at System.Uri.CombineUri(Uri basePart, String relativePart, UriFormat uriFormat) at System.Uri.GetCombinedString(Uri baseUri, String relativeStr, Boolean dontEscape, String& result) at System.Uri.ResolveHelper(Uri baseUri, Uri relativeUri, String& newUriString, Boolean& userEscaped, UriFormatException& e) at System.Uri.TryCreate(Uri baseUri, Uri relativeUri, Uri& result) at System.Uri.TryCreate(Uri baseUri, String relativeUri, Uri& result) Documentation for Uri.TryCreate(Uri, String, out Uri) says that the return value is True if successful, False otherwise, but it's silent about exceptions. However, documentation for Uri.TryCreate(Uri, Uri, out Uri) says: This method constructs the URI, puts it in canonical form, and validates it. If an unhandled exception occurs, this method catches it. If you want to create a Uri and get exceptions use one of the Uri constructors. The stack trace shows that the exception was thrown in Uri.TryCreate(Uri, Uri, out Uri) , which, according to the documentation, shouldn't happen. This is a very rare occurrence. I've been using that code for months, running literally billions of urls through it, and haven't encountered a problem until now. Unfortunately I don't know what combination of things caused the problem. I'm hoping to construct a test case that shows the error. Is this a known bug in Uri.TryCreate , or am I missing something?
