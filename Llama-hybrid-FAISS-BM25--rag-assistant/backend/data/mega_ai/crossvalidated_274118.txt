[site]: crossvalidated
[post_id]: 274118
[parent_id]: 
[tags]: 
Test 20 conditions of Observed vs Expected counts accounting for multiple comparisons

I have a dataset, dat , which has three variables; id which is a independent survey, ecosystem is the class of site surveyed and species are the individual species identified within it. It looks like this: library(tidyverse) > dat %>% head() id ecosystem species 1 0 A Sp_0001 2 0 A Sp_0002 3 0 A Sp_0003 4 0 A Sp_0004 5 0 A Sp_0005 6 0 A Sp_0006 > dat %>% str() 'data.frame': 428275 obs. of 3 variables: $ id : int 0 0 0 0 0 0 0 0 0 0 ... $ ecosystem: chr "A" "A" "A" "A" ... $ species : chr "Sp_0001" "Sp_0002" "Sp_0003" "Sp_0004" ... > dat %>% summarise_all(funs(n_distinct(.))) id ecosystem species 1 39774 20 6714 There 39774 surveys, 20 classes of site and 6714 different species. Note that the number of surveys per ecosystem class is not equal: > sp_eco % + group_by(ecosystem) %>% + summarise(count = n_distinct(id)) > sp_eco # A tibble: 20 × 2 ecosystem count 1 A 989 2 B 6438 3 C 2646 4 D 2673 5 E 7838 6 F 4320 ... I want to ask what species are characteristic of each ecosystem site. I thought before diving into some sort of complicated machine learning model I would try and do something conceptually (but maybe not practically) straightforward. I thought a good way to initially approach this would be to calculate the expected proportion of surveys in each ecosystem class containing a given species if the species was randomly distributed across all of them and then comparing that to the actual proportion observed. Those species over-represented in a given ecosystem site could then be considered characteristic of the ecosystem site. For example, take Sp_0015 : > # Expected counts > exp_prop_Sp_0015 % + filter(species == "Sp_0015") %>% + nrow()/(dat %>% summarise_all(funs(n_distinct(.))) %>% .$id) > > # Add expected to observed counts > observed_Sp_0015 % + filter(species == "Sp_0015") %>% + group_by(ecosystem) %>% + summarise(count = n_distinct(id)) %>% + mutate(expected = exp_prop_example * sp_eco$count) > observed_Sp_0015 # A tibble: 20 × 3 ecosystem count expected 1 A 460 448.7972 2 B 2720 2921.4930 3 C 1203 1200.7254 4 D 907 1212.9777 5 E 3454 3556.7975 6 F 2290 1960.3681 I thought I could use something like a pairwise comparisons for proportions to do this as it would account for multiple comparisons within each species. But I can't do this as the observed can be greater than the expected. > pairwise.prop.test(observed_Sp_0015$count, observed_Sp_0015$expected) Error in prop.test(x[c(i, j)], n[c(i, j)], ...) : elements of 'x' must not be greater than those of 'n' So my question(s) is: What test would be appropriate in this situation? Some sort of Chi-squared test? Does it allow the calculation of some sort of interval for each interval site so I can call a given species characteristic to a particular site. How should I deal with multiple comparison adjustments both within a species when I am testing across all 20 ecosystem sites and also when I repeat the test for all 6714 species? (maybe do all 20 * 6714 tests at once then separate the results out?) Note: I got this dataset off a past Kaggle competition but changed the labels so as to not ruin it for other people. I'm using it to demonstrate data manipulation but have become interested in analysing it too.
