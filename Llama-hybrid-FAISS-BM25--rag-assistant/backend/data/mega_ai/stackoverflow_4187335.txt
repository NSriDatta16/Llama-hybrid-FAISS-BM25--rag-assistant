[site]: stackoverflow
[post_id]: 4187335
[parent_id]: 
[tags]: 
CakePHP Model uses the wrong fields in SQL statements!

I have a bunch of models with various associations set up between them and seems like Cakephp at times executes incorrect SQL statement and cause MySQL to barf. For example, if I have two models, Comment and Tag and a code like this: $this->Comment->id = 5; $this->Comment->saveField('read_count', 3); yields SQL statement: UPDATE comments SET read_count = 3 WHERE Tag.id = 3; It doesn't happen all the time but it eventually happens since I am doing everything in a tight loop. Please help. This really makes me question my decision to go with Cake since this sounds bad. Thanks. EDIT 1 I just ran into the problem and here is the faulty SQL: SELECT COUNT(*) AS `count` FROM `albums_songs` AS `AlbumSong` WHERE `ArtistGenre`.`id` = 26482 AlbumSong and ArtistGenre are two completely separate tables and they are not related at all. EDIT 2 Just ran into another failure. The code is: $this->Song->find('first', array('conditions' => array('Song.artist_id' => 30188, 'Song.name' => 'Pal Pal (By.Tarkhanz)'), 'fields' => array('Song.id'))) While the generated SQL is: SELECT `Song`.`id` FROM `songs` AS `Song` WHERE `Artist`.`name` = 'Annie Villeneuve' LIMIT 1 As you can see no were in the conditions do I specify an Artist.name yet the SQL generated is looking at it. EDIT 3 Another example failure. Call is as followed: $this->Song->id = $song_id; $library_count = $this->Song->field('Song.library_count'); Yet the SQL is: SELECT `Song`.`library_count` FROM `songs` AS `Song` WHERE `Artist`.`name` = 'Mazikana_Ragheb_Allama' LIMIT 1 where Artist.name is not a column of Song as it belongs to the Artist model. Thanks. EDIT 4 models/album.php array( 'className' => 'Artist', 'foreignKey' => 'artist_id', 'conditions' => '', 'fields' => '', 'order' => '' ) ); var $hasAndBelongsToMany = array( 'Song' => array( 'className' => 'Song', 'joinTable' => 'albums_songs', 'foreignKey' => 'album_id', 'associationForeignKey' => 'song_id', 'unique' => true, 'conditions' => '', 'fields' => '', 'order' => '', 'limit' => '', 'offset' => '', 'finderQuery' => '', 'deleteQuery' => '', 'insertQuery' => '' ) ); var $hasMany = array( 'AlbumSong' => array( 'className' => 'AlbumSong', 'foreignKey' => 'album_id', 'dependent' => false, 'conditions' => '', 'fields' => '', 'order' => '', 'limit' => '', 'offset' => '', 'exclusive' => '', 'finderQuery' => '', 'counterQuery' => '' ) ); } ?> models/album_song.php array( 'className' => 'Song', 'foreignKey' => 'song_id', 'conditions' => '', 'fields' => '', 'order' => '' ), 'Album' => array( 'className' => 'Album', 'foreignKey' => 'album_id', 'conditions' => '', 'fields' => '', 'order' => '' ) ); } ?> models/artist.php array( 'className' => 'Album', 'foreignKey' => 'artist_id', 'dependent' => false, 'conditions' => '', 'fields' => '', 'order' => '', 'limit' => '', 'offset' => '', 'exclusive' => '', 'finderQuery' => '', 'counterQuery' => '' ), 'Song' => array( 'className' => 'Song', 'foreignKey' => 'artist_id', 'dependent' => false, 'conditions' => '', 'fields' => '', 'order' => '', 'limit' => '', 'offset' => '', 'exclusive' => '', 'finderQuery' => '', 'counterQuery' => '' ), 'ArtistGenre' => array( 'className' => 'ArtistGenre', 'foreignKey' => 'artist_id', 'dependent' => false, 'conditions' => '', 'fields' => '', 'order' => '', 'limit' => '', 'offset' => '', 'exclusive' => '', 'finderQuery' => '', 'counterQuery' => '' ) ); } ?> models/artist_genre.php array( 'className' => 'Artist', 'foreignKey' => 'artist_id', 'conditions' => '', 'fields' => '', 'order' => '' ), 'Genre' => array( 'className' => 'Genre', 'foreignKey' => 'genre_id', 'conditions' => '', 'fields' => '', 'order' => '' ) ); } ?> models/genre.php array( 'className' => 'Artist', 'joinTable' => 'artists_genres', 'foreignKey' => 'genre_id', 'associationForeignKey' => 'artist_id', 'unique' => true, 'conditions' => '', 'fields' => '', 'order' => '', 'limit' => '', 'offset' => '', 'finderQuery' => '', 'deleteQuery' => '', 'insertQuery' => '' ) ); var $hasMany = array( 'ArtistGenre' => array( 'className' => 'ArtistGenre', 'foreignKey' => 'genre_id', 'dependent' => false, 'conditions' => '', 'fields' => '', 'order' => '', 'limit' => '', 'offset' => '', 'exclusive' => '', 'finderQuery' => '', 'counterQuery' => '' ) ); } ?> models/song.php array( 'className' => 'Artist', 'foreignKey' => 'artist_id', 'conditions' => '', 'fields' => '', 'order' => '' ) ); /* var $hasAndBelongsToMany = array( 'Album' => array( 'className' => 'Album', 'joinTable' => 'albums_songs', 'foreignKey' => 'song_id', 'associationForeignKey' => 'album_id', 'unique' => true, 'conditions' => '', 'fields' => '', 'order' => '', 'limit' => '', 'offset' => '', 'finderQuery' => '', 'deleteQuery' => '', 'insertQuery' => '' ) ); */ var $hasMany = array( 'AlbumSong' => array( 'className' => 'AlbumSong', 'foreignKey' => 'song_id', 'dependent' => false, 'conditions' => '', 'fields' => '', 'order' => '', 'limit' => '', 'offset' => '', 'exclusive' => '', 'finderQuery' => '', 'counterQuery' => '' ) ); } ?> That is pretty much of it. For sake of brevity I removed validation code. Thanks a lot!
