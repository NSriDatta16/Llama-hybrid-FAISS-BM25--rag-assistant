[site]: stackoverflow
[post_id]: 4235909
[parent_id]: 4098895
[tags]: 
Try this with DOMDocument and DOMXPath: loadHtml(mb_convert_encoding($html, 'HTML-ENTITIES', "UTF-8")); $xpath = new DOMXPath($dom); foreach ($xpath->query('//text()[ not(ancestor::h1) and not(ancestor::h2) and not(ancestor::h3) and not(ancestor::h4) and not(ancestor::h5) and not(ancestor::h6) and not(ancestor::b) and not(ancestor::u) and not(ancestor::i) ]') as $node) { $replaced = str_ireplace('my test string', ' my test string ', $node->wholeText); $newNode = $dom->createDocumentFragment(); $newNode->appendXML($replaced); $node->parentNode->replaceChild($newNode, $node); } // get only the body tag with its contents, then trim the body tag itself to get only the original content echo mb_substr($dom->saveXML($xpath->query('//body')->item(0)), 6, -7, "UTF-8"); } $html = ' This is my test string Nested my test string This is my test string too my test string 3 '; echo doReplace($html);
