[site]: stackoverflow
[post_id]: 4966937
[parent_id]: 3054220
[tags]: 
I would only insert an ad ideally at a paragraph break (perhaps p tag) or a line break (perhaps br tag). Failing that, at a word break. And failing that, force it in between characters. (To cover weird corner cases.) So here's the K.I.S.S. solution: count letters, words, lines, AND paragraphs as you go. Simply do a cascade failure towards your preferred solution: if you get to 2000 chracters -- just force in an ad and start counting everything again from scratch. That would never happen except in weird cases. If you get to 250 words -- just force in an ad and start counting everything again from scratch. That would happen very infrequently, only with poorly formatted text, weird alien languages etc. If you get to 50 new lines -- just force in an ad and start counting everything again from scratch. That would only happen occasionally, with writers who don't use paragraph breaks. And finally if you get to 3 new paragraphs -- put in an ad and start counting everything again from scratch. That's what would normally happen. I would not bother with complicated ideas like backtracking in nearby cases, etc etc. It's just plain not worth it. It almost always gives you a better overall longterm solution to take a consistent, simple "cascading failures" approach. Do the above and you're done! It's much more art than science doing something like this. You'll enjoy the above, hope it helps! Obviously, tune the numbers I put in the pseudocode above. Most of the work on a job like this is tuning paramaters on an actual testbed. Writing the code itself is nothing, you need to create a good testbed so you can do it in front of your eyes and see it working (ideally include "dials" for the paramaters, so you can see the results in realtime, you know?) That's how you do it!
