[site]: crossvalidated
[post_id]: 187363
[parent_id]: 187080
[tags]: 
I was quite impressed by the elegance in @whuber answer. To be honest I had to do a lot of acquainting myself with new concepts to follow the steps in his solution. After spending a lot of time on it, I've decided to post what I got. So what follows is an exegetical note to his already accepted response. In this way there is no attempt at originality, and my only objective is to provide some additional anchoring points to follow some of the steps involved. So here it goes... 1. Why $2n$? Well this one may be way too basic: we need an even number of people to play the game. 2. Can we derive the formula for derangements? Following the Wikipedia entry with the example based on matching of people and hats , $n$ hats to be precise, we have that the options for the first person picking up a hat are shown here as follows: $d(n)=(n-1)[d(n-2) + d(n-1)]=$ $=n\,d(n-2)-d(n-2)+n\,d(n-1)-d(n-1)$, which can be reorganized as: $d(n) - n\,d(n-1) = -[d(n-1)-(n-1)\,d(n-2)]$. Now noticing the parallelism between the LHS of this equation and the part on the RHS within brackets we can continue recursively: $d(n) - n\,d(n-1)=-[d(n-1)-(n-1)\,d(n-2)] =$ $=(-1)^2\,[d(n-2)-(n-2)\,d(n-3)]=\cdots=(-1)^{n-2}\,d(2)-2\,d(1)$ This implies that $d(n) = n\,d(n-1)+(-1)^n$. Working backwards: $d(2)=1$ $d(3)= 3\,d(2)-1 =3*1\,-1$ $d(4)= 4\,d(3)+1 =4*3*1\,-4\,\,+1$ $d(5)= 5\,d(4)-1 =5*4*3*1\,-5*4\,+5\,\,-1$ $d(6)= 6\,d(5)+1 = 6*5*4*3*1\,-6*5*4\,+6*5\,-6\,+1=$ $=6!\left(\frac{1}{2}- \frac{1}{3*2}+\frac{1}{4*3*2}-\frac{1}{5*4*3*2}+\frac{1}{6!}\right)=$ $=6!\left(\frac{1}{6!}-\frac{1}{5!}+\frac{1}{4!}-\frac{1}{3!}+\frac{1}{2!}-\frac{1}{1!}+1\right)$ So in general, $d(n)=n!\left(1-1+\frac{1}{2!}-\frac{1}{3!}+\frac{1}{4!}+\cdots+\frac{1}{n!}\right)$ And remembering the Taylor series of $e^x$ evaluated at $x=-1$: $d(n)\approx\frac{n!}{e}$ 3. Disjoint transposition : The concept of transposition is easy to get from the link provided in the original answer , but "disjoint" was a bit less clear. Looking at an example, from the set ${a,b,c,d,e,f}$, the permutation ${b,d,a,c,f,e}$ can be expressed as a cycle as: a -> b -> d -> c after which it returns to a , but e -> f forms a loop onto itself - a disjoint cycle. Or, putting these two cycles together, the permutation can be expressed as the product $(\text {a b d c})(\text{e f})$. In the Santa Claus question (eight employees happening to have drawn names in perfectly matched pairs: Anna gives Martha a gift, while Martha has drawn Anna's name) there will be $4$ closed loops. 4. To find the number of two-element loops we need to divide all possible permutations $(2n)!$ of the set of eight ($2n$) people by the total possible number of swaps of two elements $2^n$ and the total number of permutations of these pairs $n!$: $p(2n) = \frac{(2n)!}{2^n n!}$. For the R simulation: 1. paired This function boils down to understanding x[x] : It is meant to evaluate an $8$ element vector representing the present assignments, and determine whether it is composed of 2-element loops, as in the Santa Claus problem. As long as the permutations correspond to transposing elements so that if Paul was supposed to give a present to Maria ( Paul -> Maria and vice versa, Maria -> Paul ) and Max to John ( Max -> John / John -> Max ) initially, the resultant transposition just results in new perfect pairing ( Max -> Maria / Maria -> Max and Paul -> John / John -> Paul ) we are fulfilling the initial condition of perfect pairing: In other words, if we go back to the example of the hats in Wikipedia person i always takes back hat $1$. 2. good This function evaluates whether we are dealing with a derangement by comparing the vector $x$ element wise to the the vector $(1,2,3,4,5,6,7,8)$, and making sure there is no coincidence. 3. k.paired is there to exclude paired permutations like the one above in the diagram, which are not derangements: v
