[site]: crossvalidated
[post_id]: 643696
[parent_id]: 
[tags]: 
Distance matrix of actual dataset doesn't obey triangle inequality, leading to non-positive definite covariance matrix

Yesterday I asked a question about why my randomly generated distance matrices were leading to Matérn covariance matrices that were not positive definite. The answer there called my attention to the fact that my simplistic way of generating randomly generated distance matrices was not ensuring that such matrices obeyed the triangle inequality. Indeed, enforcing that solved the problem. However, what I realize now is that my real data is also leading to that same problem. That is, when calculating a distance matrix for the distances between rows in my dataset, I end up getting a distance matrix that... does not obey triangle inequality. And thus, leads to a Matérn covariance matrix that is not positive definite. Here is a small subset (1000 rows) of my actual data (about 40,000 rows), which does reproduce the issue, uploaded to Filebin: actualdata.csv Here is the illustration of what I am doing: library(Rfast) # for fast calculation of distances and checking symmetry library(fossil) # for checking triangle inequality # Load subset of my actual data and calculate the distance matrix: X $values)) # should be greter than zero, but isn't print(sum(g$ values Here is a set of checks of whether the d obeys all 4 properties of distance matrices: # check that we have a correct distance matrix (warning: the triangle inequality checks may take a while): Rfast::is.symmetric(d) # symmetric matrix? YES sum(diag(d)!=0.000000000001)==0 # zero diagonal values? YES min(d[row(d) == (col(d) - 1)])>0 # positive off-diagonal values? YES fossil::tri.ineq(d) # obeys triangular inequality? NO (warning: this line is quite slow) The problem is: because here the input dataset X is not simulated, I cannot force the distance matrix to obey triangle inequality by design. Therefore my question: in this case, what can be done to ensure the generation of a positive definite Matérn covariance matrix?
