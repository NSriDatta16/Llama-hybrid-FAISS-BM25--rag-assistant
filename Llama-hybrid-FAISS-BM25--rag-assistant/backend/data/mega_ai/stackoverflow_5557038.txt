[site]: stackoverflow
[post_id]: 5557038
[parent_id]: 
[tags]: 
Drupal AHAH, Dynamic form expansion

Form $form['animal'] = array( '#type' => 'select', '#title' => t('Animal'), '#options' => load_animals(), '#ahah' => array( 'event' => 'change', 'path' => 'path/to/ajax/service', 'method' => 'replace', 'effect' => 'fade', 'wrapper' => 'breed-wrapper', ), ); ... $form['breed'] = array( '#type' => 'select', '#title' => t('Breeds'), '#options' => array('Select animal to load breed'), '#prefix' => ' ', '#suffix' => ' ', ); And following is the AHAH callback processing $post = $_POST; $form_state = array('storage' => NULL, 'submitted' => FALSE); $form_build_id = $post['form_build_id']; $form = form_get_cache($form_build_id, $form_state); $args = $form['#parameters']; $form_id = array_shift($args); $form['#redirect'] = FALSE; $form['#post'] = $post; $form['#programmed'] = FALSE; $form_state['post'] = $post; drupal_process_form($form_id, $form, $form_state); // New form elements $breed_form = $form['breed']; $options = load_breeds((int)$post['animal']); $breed_form['#options'] = $options; $form['breed'] = $breed_form; form_set_cache($form_build_id, $form, $form_state); $form = drupal_rebuild_form($form_id, $form_state, $args, $form_build_id); unset($breed_form['#prefix'], $breed_form['#suffix']); // Render the new output. $output .= drupal_render($breed_form); drupal_json(array('status' => TRUE, 'data' => $output)); Default form submit handler function default_form_submit(&$form, $form_state){ $clicked_button = $form_state['clicked_button']['#value']; $values = $form_state['values']; if($clicked_button == $values['submit']){ unset($values['op'], $values['submit'], $values['form_build_id'], $values['form_token'], $values['form_id']); .... drupal_goto($_REQUEST['q'], $query); } } When I finally submit the form in normal post way, a validation error is reported as An illegal choice has been detected. Am I properly using form_set_cache()? On AHAH post, the default form submission handler is also invoked. As this handler contains a redirection logic so AHAH request is collapsed. How to bypass it even-though I am doing click_button validation?
