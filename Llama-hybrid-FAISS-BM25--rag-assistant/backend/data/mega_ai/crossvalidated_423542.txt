[site]: crossvalidated
[post_id]: 423542
[parent_id]: 
[tags]: 
Isolation Forest and average/expected depth formula

The Isolation Forest algorithm (Liu, Fei Tony, Kai Ming Ting, and Zhi-Hua Zhou. "Isolation forest." 2008 Eighth IEEE International Conference on Data Mining. IEEE, 2008. - link: https://cs.nju.edu.cn/zhouzh/zhouzh.files/publication/icdm08b.pdf?q=isolation-forest ) tries to assign an anomaly score to observations according to the tree depth obtained by recursively (binary-) splitting them at random based on picking a random value within observed range from a random column at each time, until an observation is alone in a tree branch, given that rarer observations will need fewer splits to become isolated. In the original paper that describes the Isolation Forest algorithm, it specifies that, since outliers are those which will take a less-than-average number of splits to become isolated and the purpose is only to catch outliers, the trees are built up until a certain height limit (corresponding to the height of a perfectly-balanced binary search tree - $\lceil\log_2(n)\rceil$ ), and if there’s more than 1 observation/row present in a tree that has already reached its height limit, when an observation falls into that node, it will add to it the expected path length for the sample size of that tree to obtain the final path length: The formula for the expected path length in the paper is given as follows: $$ c(n) = 2 H ( n - 1 ) - (2(n-1) / n) $$ With $$ H(i) = \log(i) + 0.5772156649 $$ Now, from what I understand, the purpose of that formula is to calculate an average depth if the process were continued for trees that divide observations at random. If there are 3 observations, there’s 2 possible ways to split them fully using binary trees: . / \ . o / \ o o ----------- . / \ o . / \ o o Both are equally likely, and the average path length under both is $(1 + 2 + 2) / 3 = 1.67$ , but the formula gives $c(3) = 1.21$ . Similarly, for 4 observations, there’s 3 possible ways to build the trees (plus the exact same ways with horizontal mirroring): . / \ . . /\ /\ o o o o ------------ . / \ o . / \ o . / \ o o ------------ . / \ o . / \ . o / \ o o In the first case, the average path length is $2$ , while in the others it’s $(1 + 2 + 3 + 3) / 4 = 2.25$ , but the first one has a $\frac{1}{3}$ probability of being chosen if splitting elements at random, for an overall average of $2 \frac{1}{3} + 2.25 \frac{2}{3} = 2.167$ , but again the formula gives a lower number: $c(4) = 1.85$ . Am I understanding something incorrectly? What’s the formula meant to represent? I get that the actual average path length will be different according to the distribution of the data (e.g. if there's an outlier, chances are higher that the average path length from random uniform splits will be above the expected average, as there will be more splits having the longer structure than the balanced structure), but in any event the paper's formula gives numbers that are lower than the combinatorial average rather than higher.
