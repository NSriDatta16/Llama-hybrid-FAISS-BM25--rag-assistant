[site]: stackoverflow
[post_id]: 5307622
[parent_id]: 
[tags]: 
Nokogiri replace strips content of HTML

I would like to remove a tag from some HTML without stripping the remaining content of any markup. For example, I have a file, test.html: Some text, goes to uppercase other text italics ‘more text with UTF-8 ’ I would like to get the following output: SOME TEXT, GOES TO UPPERCASE other text italics ‘more text with UTF-8 ’ My code is: f = File.open('raw/test.html',"r") doc = Nokogiri::XML::DocumentFragment.parse(f.read.encode('UTF-8')) f.close doc.css("span.T2").each do |span| span.replace span.content.upcase end doc.css("span.T5").each do |span| span.replace " "+span.content+" " end doc.css("span").each do |span| span.replace span.content end doc.css("p").each do |p| p.replace Nokogiri::XML::Text.new(p.inner_html, p.document) end f = File.open('processed/test.html',"w") f.write(doc) f.close And the output I get is: SOME TEXT, GOES TO UPPERCASE &lt;p class="P4"&gt; other text &lt;em&gt;italics &lt;/em&gt;&amp;#x2018;more text with UTF-8 &amp;#x2019; &amp;#x2018;our common mother&amp;#x2019; &lt;/p&gt; Many thanks in advance. UPDATE The solution was as follows: coder = HTMLEntities.new f = File.open('raw/test.html',"r") doc = Nokogiri::XML::DocumentFragment.parse(f.read.encode('UTF-8')) f.close doc.css("p").each do |p| p.replace p.inner_html end doc.css("span.T2").each do |span| span.replace span.content.upcase end doc.css("span.T5").each do |span| span.replace " "+span.content+" " end doc.css("span").each do |span| span.replace span.inner_html end f = File.open('processed/test.html',"w") f.write(coder.decode(doc)) f.close
