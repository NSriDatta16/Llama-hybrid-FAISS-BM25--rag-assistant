[site]: datascience
[post_id]: 101911
[parent_id]: 
[tags]: 
Lung segmentation by Kmeans contains white border

I'm new to image processing, I'm trying to segment lung CT images by Kmeans by the following: import numpy as np import re import pandas as pd from skimage import morphology from skimage import measure from PIL import Image from sklearn.cluster import KMeans from skimage.transform import resize from glob import glob import sys import os import cv2 from scipy.ndimage.morphology import binary_dilation,generate_binary_structure from skimage.morphology import convex_hull_image def process_mask(mask): convex_mask = np.copy(mask) for i_layer in range(convex_mask.shape[0]): mask1 = np.ascontiguousarray(mask[i_layer]) if np.sum(mask1)>0: mask2 = convex_hull_image(mask1) if np.sum(mask2)>2*np.sum(mask1): mask2 = mask1 else: mask2 = mask1 convex_mask[i_layer] = mask2 struct = generate_binary_structure(3,1) dilatedMask = binary_dilation(convex_mask,structure=struct,iterations=10) return dilatedMask def lumTrans(img): lungwin = np.array([-1200.,600.]) newimg = (img-lungwin[0])/(lungwin[1]-lungwin[0]) newimg[newimg 1]=1 newimg = (newimg*255).astype('uint8') return newimg def lungSeg(imgs_to_process,output,name): if os.path.exists(output+'/'+name+'_clean.npy') : return imgs_to_process = Image.open(imgs_to_process) img_to_save = imgs_to_process.copy() img_to_save = np.asarray(img_to_save).astype('uint8') imgs_to_process = lumTrans(imgs_to_process) imgs_to_process = np.expand_dims(imgs_to_process, axis=0) x,y,z = imgs_to_process.shape img_array = imgs_to_process.copy() A1 = int(y/(512./100)) A2 = int(y/(512./400)) A3 = int(y/(512./475)) A4 = int(y/(512./40)) A5 = int(y/(512./470)) for i in range(len(imgs_to_process)): img = imgs_to_process[i] print(img.shape) x,y = img.shape #Standardize the pixel values allmean = np.mean(img) allstd = np.std(img) img = img-allmean img = img/allstd # Find the average pixel value near the lungs # to renormalize washed out images middle = img[A1:A2,A1:A2] mean = np.mean(middle) max = np.max(img) min = np.min(img) kmeans = KMeans(n_clusters=2).fit(np.reshape(middle,[np.prod(middle.shape),1])) centers = sorted(kmeans.cluster_centers_.flatten()) threshold = np.mean(centers) thresh_img = np.where(img A4 and B[2] bone_thresh sliceim[bones] = pad_value x,y,z = sliceim.shape if not os.path.exists(output): os.makedirs(output) img_to_save[sliceim.squeeze()==0] = 0 im = Image.fromarray(img_to_save) im.save(output + name + '.png', 'PNG') The lung segment method calling: lungSeg(image_path, new_image_path, image_name) The problem is the segmented lung still contains white borderers like this: segmented lung (output): unsegmented lung (input): The whole code here https://colab.research.google.com/drive/1gdZi7dv2bo4MNgR9suuM1ZCMItSWXggl?usp=sharing
