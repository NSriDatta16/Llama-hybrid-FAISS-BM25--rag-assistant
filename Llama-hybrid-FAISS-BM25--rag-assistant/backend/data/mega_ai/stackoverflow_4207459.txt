[site]: stackoverflow
[post_id]: 4207459
[parent_id]: 4206537
[tags]: 
No need for a CTE, all you need is a helper table. Create it once, like so: Create Table DayMinute(Minute Integer) Declare @M Integer Set @M = 1 While (@M Then, all you need is a bit of tricksiness: Select DM.Minute, SD.Sched_ID Into #MinutesWithException From DayMinute As DM Inner Join #SD As SD On DM.Minute Between SD.Start_Minute And SD.Start_Minute + Length Select MWE.Sched_ID, SH.[Date], SH.Agent_ID, [Start_Minute] = MWE.Minute, [End_Minute] = (Select Min(Last.Minute) -- First one to have no successor From #MinutesWithException As Last Where Last.Sched_ID = MWE.Sched_ID And Last.Minute > MWE.Minute And Not Exists(Select * From #MinutesWithException As Next Where Next.Sched_ID = MWE.Sched_iD And Next.Minute = Last.Minute + 1)) From #MinutesWithException As MWE Inner Join #SH As SH On MWE.Sched_ID = SH.Sched_ID Where Not Exists(Select * -- All those without predecessor From #MinutesWithException As Previous Where Previous.Sched_ID = MWE.Sched_ID And Previous.Minute = MWE.Minute - 1) Remember, a lot of SQL problems can be solved by rephrasing them. Don't ask "which ranges do not have a gap", ask "which minutes have an interval". The rest follows from there.
