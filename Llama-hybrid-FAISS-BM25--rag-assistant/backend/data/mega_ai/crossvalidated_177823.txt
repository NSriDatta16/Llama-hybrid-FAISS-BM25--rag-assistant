[site]: crossvalidated
[post_id]: 177823
[parent_id]: 
[tags]: 
R: Regression, Two-stage Least Squares

I need to perform manually two-stage Least Squares(to illustrate its advantages) , where the first stage is repeated median estimate and the second stage should be weighted least squares, where weights are obtained(as far, as I understand) from polynomial regression of first-stage residuals on regressors. Suppose I have generated the following heteroscedastic model: where error depends on regressor: set.seed(100) b So I perform repeated median regression (formula in the Introduction ): ## Generating first model using repeated median ## slope fij = function(i,j) { (my_y[i]-my_y[j])/(raw_x[i]-raw_x[j]) } bij The fit is extremely accurate! In this example a_med is 11.97634 and b_med equals 7.27022. Now I perform 2nd order polynomial regression of residuals: so that ( X here is m x 3 matrix): I was told that as long as residual variances can be roughly estimated from only one observation, actual fit from this model can be used; residual variances = coefficients for the weighted least squares: ## Obtaining 2nd order polynomial estimator for residuals Xmatr = t(rbind(rep(1,num),raw_x,(raw_x)^2)) ## coef_var = (X^T*X)^(-1)*X^T^e coef_var The resulting fit is always worse (and sometimes turns into complete garbage). Please, can you explain me what I'm doing wrong? I need to obtain the result where two-level LS is better than repeated median fit(provided the error depends on regressors as shown before) . EDIT: Using R function lm seems to produce the same picture: Xmatr = t(rbind(rep(1,num),raw_x,(raw_x)^2)) residual EDIT2: Checking the quality of the residual fit (as far as I understand what's going on): plot(raw_x,abs(residual)) lines(sort(raw_x),(sort(raw_x)-1)^2) ## real residuals lines(sort(raw_x), my_sigma[order(raw_x)],col = "magenta") ## fitted residuals legend('topleft', c("Real res","Fitted res") , lty=1, col=c('black','magenta'), bty='n', cex=.75) EDIT3: As long as my standard deviation is $(X_i-1)^2$, so the variance has power 4 and maybe I should do for the residual fit residual this makes residual fit by the quadratic function better, but the regression line moves even more far than before.
