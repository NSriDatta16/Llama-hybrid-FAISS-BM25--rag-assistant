[site]: crossvalidated
[post_id]: 583747
[parent_id]: 243384
[tags]: 
I wasn't satisfied with any of the above solutions, so I'll give it a try. I find the solution proposed by riceissa the most elegant one, but he only proved the last step. I want to add the missing pieces. So let's go ... Proof of $v_\pi(s) = \sum_a\pi(a|s)q_\pi(s,a)$ : \begin{eqnarray*} v_\pi(s) &=& \mathbb{E}_\pi[G_t|S_t=s]\\ &=&\sum_g g p(g|s)\\ &=&\sum_g g \sum_a p(g,a|s)\\ &=&\sum_g \sum_a g p(g|a,s)p(a|s)\\ &=&\sum_a p(a|s) \sum_g g p(g|a,s)\\ &=&\sum_a \pi(a|s) \mathbb{E}_\pi[G_t|S_t=s,A_t=a]\\ &=&\sum_a\pi(a|s)q_\pi(s,a) \end{eqnarray*} Proof of $q_\pi(s,a) = \sum_{s',r}p(s',r|s,a)[r+\gamma v_\pi(s')]$ : \begin{eqnarray*} q_\pi(s,a) &=& \mathbb{E}_\pi[G_t|S_t=s,A_t=a]\\ &=&\mathbb{E}_\pi[R_{t+1} + \gamma G_{t+1}|S_t=s,A_t=a]\\ &=&\mathbb{E}_\pi[R_{t+1}|S_t=s,A_t=a] + \gamma\mathbb{E}_\pi[G_{t+1}|S_t=s,A_t=a]\\ &=&\sum_r rp(r|s,a) + \gamma\mathbb{E}_\pi[G_{t+1}|S_t=s,A_t=a]\\ &=&\sum_r r\sum_{s'}p(s',r|s,a) + \gamma\mathbb{E}_\pi[G_{t+1}|S_t=s,A_t=a]\\ &=&\sum_{s',r}rp(s',r|s,a) + \gamma\mathbb{E}[\mathbb{E}_\pi[G_{t+1}|S_t=s,A_t=a,R_{t+1},S_{t+1}]] \quad (*)\\ &=&\sum_{s',r} rp(s',r|s,a) + \gamma\sum_{s',r}\mathbb{E}_\pi[G_{t+1}|S_t=s,A_t=a,R_{t+1}=r,S_{t+1}=s']p(s',r|s,a)\\ &=&\sum_{s',r} p(s',r|s,a)[r + \gamma\mathbb{E}_\pi[G_{t+1}|S_t=s,A_t=a,R_{t+1}=r,S_{t+1}=s']\\ &=&\sum_{s',r} p(s',r|s,a)[r + \gamma\mathbb{E}_\pi[G_{t+1}|S_{t+1}=s'] \quad (**)\\ &=&\sum_{s',r} p(s',r|s,a)[r + \gamma v_\pi(s')]\\ \end{eqnarray*} (*) Law of total expectation (**) $S_{t+1} = s'$ holds all information, so all other variables can be dropped (Markov property).
